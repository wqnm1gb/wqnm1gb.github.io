<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Day07 缓存菜品和购物车 | 三狗子的博客</title>
<meta name=keywords content="苍穹外卖"><meta name=description content="缓存菜品
用户端小程序展示的菜品数据都是通过查询数据库获得，如果用户端访问量比较大，数据库访问压力随之增大。


通过Redis来缓存菜品，减少数据库查询操作"><meta name=author content="冷漠三狗子丶"><link rel=canonical href=https://wqnm1gb.github.io/posts/day07%E7%BC%93%E5%AD%98%E8%8F%9C%E5%93%81%E5%92%8C%E8%B4%AD%E7%89%A9%E8%BD%A6/><link crossorigin=anonymous href=/assets/css/stylesheet.3d688279d829dc24da48acd11f9e33ebea2f39c035e899e1bf4297d8b7aa89b9.css integrity="sha256-PWiCedgp3CTaSKzRH54z6+ovOcA16Jnhv0KX2Leqibk=" rel="preload stylesheet" as=style><link rel=icon href=https://wqnm1gb.github.io/images/favicon.png><link rel=icon type=image/png sizes=16x16 href=https://wqnm1gb.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://wqnm1gb.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://wqnm1gb.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://wqnm1gb.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://wqnm1gb.github.io/posts/day07%E7%BC%93%E5%AD%98%E8%8F%9C%E5%93%81%E5%92%8C%E8%B4%AD%E7%89%A9%E8%BD%A6/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap" rel=stylesheet><script type=text/javascript async src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">MathJax.Hub.Config({tex2jax:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["[[","]]"]],processEscapes:!0,processEnvironments:!0,skipTags:["script","noscript","style","textarea","pre"],TeX:{equationNumbers:{autoNumber:"AMS"},extensions:["AMSmath.js","AMSsymbols.js"]}}}),MathJax.Hub.Queue(function(){var e,t=MathJax.Hub.getAllJax();for(e=0;e<t.length;e+=1)t[e].SourceElement().parentNode.className+=" has-jax"})</script><style>code.has-jax{font:inherit;font-size:100%;background:inherit;border:inherit;color:#515151}</style><meta property="og:title" content="Day07 缓存菜品和购物车"><meta property="og:description" content="缓存菜品
用户端小程序展示的菜品数据都是通过查询数据库获得，如果用户端访问量比较大，数据库访问压力随之增大。


通过Redis来缓存菜品，减少数据库查询操作"><meta property="og:type" content="article"><meta property="og:url" content="https://wqnm1gb.github.io/posts/day07%E7%BC%93%E5%AD%98%E8%8F%9C%E5%93%81%E5%92%8C%E8%B4%AD%E7%89%A9%E8%BD%A6/"><meta property="og:image" content="https://wqnm1gb.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-03-20T11:07:51+08:00"><meta property="article:modified_time" content="2025-03-20T11:07:51+08:00"><meta property="og:site_name" content="三狗子的博客"><meta property="fb:admins" content="your-facebook-admin-id"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://wqnm1gb.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Day07 缓存菜品和购物车","item":"https://wqnm1gb.github.io/posts/day07%E7%BC%93%E5%AD%98%E8%8F%9C%E5%93%81%E5%92%8C%E8%B4%AD%E7%89%A9%E8%BD%A6/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Day07 缓存菜品和购物车","name":"Day07 缓存菜品和购物车","description":"缓存菜品 用户端小程序展示的菜品数据都是通过查询数据库获得，如果用户端访问量比较大，数据库访问压力随之增大。\n通过Redis来缓存菜品，减少数据库查询操作\n","keywords":["苍穹外卖"],"articleBody":"缓存菜品 用户端小程序展示的菜品数据都是通过查询数据库获得，如果用户端访问量比较大，数据库访问压力随之增大。\n通过Redis来缓存菜品，减少数据库查询操作\n缓存逻辑分析：\n每个分类下的菜品保存一份缓存数据 数据库中菜品数据有变更时清理缓存数据 加入缓存逻辑后的代码\n@GetMapping(\"/list\") @ApiOperation(\"根据分类id查询菜品\") public Result\u003cList\u003cDishVO\u003e\u003e list(Long categoryId) { // 构造一个key String key = \"dish_\"+categoryId; // 判断在Redis中是否有存储 List\u003cDishVO\u003e list = (List\u003cDishVO\u003e) redisTemplate.opsForValue().get(key); if (list != null \u0026\u0026 list.size()\u003e0){ // 如果有数据，那么获取数据返回 return Result.success(list); } // 如果没有数据，那么把数据插入到redis中 Dish dish = new Dish(); dish.setCategoryId(categoryId); dish.setStatus(StatusConstant.ENABLE);//查询起售中的菜品 list = dishService.listWithFlavor(dish); redisTemplate.opsForValue().set(key,list); return Result.success(list); } 缓存的逻辑\n每个分类存为key，里边的菜品数据，在Java中是List，可以保存为Redis中的String\n缓存的原因\n频繁的使用SQL会导致数据库的压力过大，降低性能，把查询到的数据，缓存起来\n后台如果对数据操作了之后，需要删除缓存\n修改管理端接口 DishController 的相关方法，加入清理缓存的逻辑，需要改造的方法：\n新增菜品 修改菜品 批量删除菜品 起售、停售菜品 一般对Redis的操作，加在Controller上，缓存清理的代码，加到了admin/dishcontroller里边\n// 抽取一个共同的方法，来删除redis的缓存 private void delCache(String pattern){ Set keys = redisTemplate.keys(pattern); redisTemplate.delete(keys); } 缓存套餐 Spring Cache Spring Cache 是一个框架，实现了基于注解的缓存功能，只需要简单地加一个注解，就能实现缓存功能。相当于封装了，不需要再像缓存菜品的时候那样写\nSpring Cache 提供了一层抽象，底层可以切换不同的缓存实现，例如：\nEHCache Caffeine Redis 需要引入依赖\n\u003cdependency\u003e \u003cgroupId\u003eorg.springframework.boot\u003c/groupId\u003e \u003cartifactId\u003espring-boot-starter-cache\u003c/artifactId\u003e \u003cversion\u003e2.7.3\u003c/version\u003e \u003c/dependency\u003e 常用注解 注解 说明 @EnableCaching 开启缓存注解功能，通常加在启动类上（不要忘记） @Cacheable 在方法执行前先查询缓存中是否有数据，如果有数据，则直接返回缓存数据；如果没有缓存数据，调用方法并将方法返回值放到缓存中 @CachePut 将方法的返回值放到缓存中 @CacheEvict 将一条或多条数据从缓存中删除 具体的实现思路如下\n导入Spring Cache和Redis相关maven坐标 在启动类上加入@EnableCaching注解，开启缓存注解功能 在用户端接口SetmealController的 list 方法上加入@Cacheable注解 在管理端接口SetmealController的 save、delete、update、startOrStop等方法上加入CacheEvict注解 @CachePut(cacheNames = \"userCache\",key = \"#user.id\") 如果使用Spring Cache缓存数据，key的生成：userCache::abc\nSpEL可以用来动态的计算key\n#参数 引用形参 . 叫做对象导航\n#p0 #a0.id 拿到第一个参数 #p1 拿到第二个参数\n#root.args[0].id 拿到第一个参数里边的id信息\n#返回值 引用到返回值\nuserCache::abc类似是树形结构，一个:代表一个文件夹\n思考一个问题，为什么key需要动态设置值\n如果key不是动态的，那么没插入一个数据，key都是相同的，会把之前的缓存数据给覆盖掉，所以需要设置一个动态值\n@Cacheable(cacheNames = \"cacheName\" , key = \"#id\") 基于代理技术，Spring为这个Controller创建代理对象，在代理对象中动态的把key计算出来，然后把缓存数据清理\n可以直接查缓存中有没有，如果有的话，不需要调用Mapper，如果没有，会调用Mapper，同时把查询出来的数据，放入缓存中\n思考的一个问题，放入cache中的是什么样的对象，是返回值对象，在外卖项目中，返回的是Result对象\n// 删除一条数据 @CacheEvict(cacheNames = \"cacheName\" , key = \"#id\") // 一次性删除所有缓存 @CacheEvict(cacheNames = \"cacheName\", allEntries = true) Evict 驱逐的意思\n添加商品到购物车 冗余字段：重复出现的字段\n提高查询速度，需要是不能经常变化的数据\n添加商品到购物车的时候，需要先判断商品是不是已经在购物车里了，如果是的话，只需要更新数量\n一次添加只可能是添加菜品或添加套餐\n// 添加到购物车 @Override public void addShoppingCart(ShoppingCartDTO shoppingCartDTO) { // 判断商品是否在购物车里了 // 写一个动态查询语句来判断 ShoppingCart shoppingCart = new ShoppingCart(); BeanUtils.copyProperties(shoppingCartDTO,shoppingCart); shoppingCart.setUserId(BaseContext.getCurrentId()); // 直接传入一个shoppingcartdto不可以，因为无法判断用户是谁，进而无法知道是哪个菜品 List\u003cShoppingCart\u003e list = shoppingCartMapper.getById(shoppingCart); // 如果已经在购物车里边，那么直接修改商品的数量 if(list != null \u0026\u0026 list.size()\u003e0){ // 每次数量只可能是加一，判断是菜品还是套餐 ShoppingCart shoppingCart1 = list.get(0); if(shoppingCart1.getDishId()!=null){ // 因为限制了菜品的id和用户的id，所以只可能找出的是一条数据，只需要取list集合里边的第一条数据就行 shoppingCart1.setNumber(shoppingCart1.getNumber()+1); shoppingCartMapper.update(shoppingCart1); } }else { // 如果不在购物车里边，那么添加数据到购物车 // 如果是菜品数据 if(shoppingCart.getDishId()!=null){ // 购物车表里边的name是商品的名字字段，如果是菜品就要用菜品的名字，如果是套餐就要用套餐的名字 Dish dish = dishMapper.getById(shoppingCart.getDishId()); shoppingCart.setName(dish.getName()); shoppingCart.setImage(dish.getImage()); shoppingCart.setAmount(dish.getPrice()); }else { // 需要插入的是套餐数据 Setmeal setmeal = setmealMapper.getById(shoppingCart.getSetmealId()); shoppingCart.setName(setmeal.getName()); shoppingCart.setImage(setmeal.getImage()); shoppingCart.setAmount(setmeal.getPrice()); } shoppingCart.setNumber(1); shoppingCart.setCreateTime(LocalDateTime.now()); shoppingCartMapper.insert(shoppingCart); } } } ","wordCount":"1839","inLanguage":"zh","image":"https://wqnm1gb.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2025-03-20T11:07:51+08:00","dateModified":"2025-03-20T11:07:51+08:00","author":{"@type":"Person","name":"冷漠三狗子丶"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://wqnm1gb.github.io/posts/day07%E7%BC%93%E5%AD%98%E8%8F%9C%E5%93%81%E5%92%8C%E8%B4%AD%E7%89%A9%E8%BD%A6/"},"publisher":{"@type":"Organization","name":"三狗子的博客","logo":{"@type":"ImageObject","url":"https://wqnm1gb.github.io/images/favicon.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wqnm1gb.github.io/ accesskey=h title="主页 (Alt + H)"><img src=https://wqnm1gb.github.io/apple-touch-icon.png alt aria-label=logo height=35>主页</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://wqnm1gb.github.io/ title=三狗子的博客><span>首页</span></a></li><li><a href=https://wqnm1gb.github.io/archives/ title=归档><span>归档</span></a></li><li><a href=https://wqnm1gb.github.io/categories/ title=Categories><span>分类</span></a></li><li><a href=https://wqnm1gb.github.io/tags/ title=Tags><span>标签</span></a></li><li><a href=https://wqnm1gb.github.io/search/ title=搜索><span>搜索</span></a></li><li><a href=https://wqnm1gb.github.io/about/ title=关于><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://wqnm1gb.github.io/>主页</a>&nbsp;»&nbsp;<a href=https://wqnm1gb.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Day07 缓存菜品和购物车</h1><div class=post-meta><span title='2025-03-20 11:07:51 +0800 +0800'>三月 20, 2025</span>&nbsp;·&nbsp;4 分钟&nbsp;·&nbsp;1839 字&nbsp;·&nbsp;冷漠三狗子丶</div></header><div class=post-content><h1 id=缓存菜品>缓存菜品<a hidden class=anchor aria-hidden=true href=#缓存菜品>#</a></h1><p>用户端小程序<strong>展示的菜品数据</strong>都是通过查询数据库获得，如果用户端访问量比较大，数据库访问压力随之增大。</p><p><img loading=lazy src=/images/Day07%e7%bc%93%e5%ad%98%e8%8f%9c%e5%93%81%e5%92%8c%e8%b4%ad%e7%89%a9%e8%bd%a6.assets/1740531212471-f98e92d5-c109-4b3c-8468-e806202f161e.png alt></p><p>通过Redis来缓存菜品，减少数据库查询操作</p><p><img loading=lazy src=/images/Day07%e7%bc%93%e5%ad%98%e8%8f%9c%e5%93%81%e5%92%8c%e8%b4%ad%e7%89%a9%e8%bd%a6.assets/1740531256142-df78ed77-1a42-4387-ae77-7bf8596432f6.png alt></p><p>缓存逻辑分析：</p><ul><li>每个分类下的菜品保存一份缓存数据</li><li>数据库中菜品数据有变更时清理缓存数据</li></ul><p><img loading=lazy src=/images/Day07%e7%bc%93%e5%ad%98%e8%8f%9c%e5%93%81%e5%92%8c%e8%b4%ad%e7%89%a9%e8%bd%a6.assets/1740531296942-f227cd41-14d3-4968-9d9a-744194f4082f.png alt></p><p>加入缓存逻辑后的代码</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/list&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ApiOperation</span><span class=p>(</span><span class=s>&#34;根据分类id查询菜品&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Result</span><span class=o>&lt;</span><span class=n>List</span><span class=o>&lt;</span><span class=n>DishVO</span><span class=o>&gt;&gt;</span><span class=w> </span><span class=nf>list</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>categoryId</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//   构造一个key</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;dish_&#34;</span><span class=o>+</span><span class=n>categoryId</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 判断在Redis中是否有存储</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=o>&lt;</span><span class=n>DishVO</span><span class=o>&gt;</span><span class=w> </span><span class=n>list</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=p>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>DishVO</span><span class=o>&gt;</span><span class=p>)</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>opsForValue</span><span class=p>().</span><span class=na>get</span><span class=p>(</span><span class=n>key</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>list</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>list</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=o>&gt;</span><span class=n>0</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 如果有数据，那么获取数据返回</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>Result</span><span class=p>.</span><span class=na>success</span><span class=p>(</span><span class=n>list</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 如果没有数据，那么把数据插入到redis中</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Dish</span><span class=w> </span><span class=n>dish</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Dish</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>dish</span><span class=p>.</span><span class=na>setCategoryId</span><span class=p>(</span><span class=n>categoryId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>dish</span><span class=p>.</span><span class=na>setStatus</span><span class=p>(</span><span class=n>StatusConstant</span><span class=p>.</span><span class=na>ENABLE</span><span class=p>);</span><span class=c1>//查询起售中的菜品</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>list</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>dishService</span><span class=p>.</span><span class=na>listWithFlavor</span><span class=p>(</span><span class=n>dish</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>opsForValue</span><span class=p>().</span><span class=na>set</span><span class=p>(</span><span class=n>key</span><span class=p>,</span><span class=n>list</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Result</span><span class=p>.</span><span class=na>success</span><span class=p>(</span><span class=n>list</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>缓存的逻辑</p><p>每个分类存为key，里边的菜品数据，在Java中是List，可以保存为Redis中的String</p><p>缓存的原因</p><p>频繁的使用SQL会导致数据库的压力过大，降低性能，把查询到的数据，缓存起来</p><p>后台如果对数据操作了之后，需要删除缓存</p><p>修改管理端接口 DishController 的相关方法，加入清理缓存的逻辑，需要改造的方法：</p><ul><li>新增菜品</li><li>修改菜品</li><li>批量删除菜品</li><li>起售、停售菜品</li></ul><p><strong>一般对Redis的操作，加在Controller上，缓存清理的代码，加到了admin/dishcontroller里边</strong></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>//    抽取一个共同的方法，来删除redis的缓存</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>delCache</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>pattern</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Set</span><span class=w> </span><span class=n>keys</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>keys</span><span class=p>(</span><span class=n>pattern</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>redisTemplate</span><span class=p>.</span><span class=na>delete</span><span class=p>(</span><span class=n>keys</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h1 id=缓存套餐>缓存套餐<a hidden class=anchor aria-hidden=true href=#缓存套餐>#</a></h1><h2 id=spring-cache>Spring Cache<a hidden class=anchor aria-hidden=true href=#spring-cache>#</a></h2><p>Spring Cache 是一个框架，实现了基于注解的缓存功能，只需要简单地加一个注解，就能实现缓存功能。相当于封装了，不需要再像缓存菜品的时候那样写</p><p>Spring Cache 提供了一层抽象，底层可以切换不同的缓存实现，例如：</p><ul><li>EHCache</li><li>Caffeine</li><li>Redis</li></ul><p>需要引入依赖</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=o>&lt;</span><span class=n>dependency</span><span class=o>&gt;</span><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>&lt;</span><span class=n>groupId</span><span class=o>&gt;</span><span class=n>org</span><span class=p>.</span><span class=na>springframework</span><span class=p>.</span><span class=na>boot</span><span class=o>&lt;/</span><span class=n>groupId</span><span class=o>&gt;</span><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>&lt;</span><span class=n>artifactId</span><span class=o>&gt;</span><span class=n>spring</span><span class=o>-</span><span class=n>boot</span><span class=o>-</span><span class=n>starter</span><span class=o>-</span><span class=n>cache</span><span class=o>&lt;/</span><span class=n>artifactId</span><span class=o>&gt;</span><span class=w>    
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>&lt;</span><span class=n>version</span><span class=o>&gt;</span><span class=n>2</span><span class=p>.</span><span class=na>7</span><span class=p>.</span><span class=na>3</span><span class=o>&lt;/</span><span class=n>version</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>&lt;/</span><span class=n>dependency</span><span class=o>&gt;</span><span class=w>
</span></span></span></code></pre></div><h2 id=常用注解>常用注解<a hidden class=anchor aria-hidden=true href=#常用注解>#</a></h2><table><thead><tr><th style=text-align:left><strong>注解</strong></th><th style=text-align:left><strong>说明</strong></th></tr></thead><tbody><tr><td style=text-align:left>@EnableCaching</td><td style=text-align:left>开启缓存注解功能，通常<strong>加在启动类上（不要忘记）</strong></td></tr><tr><td style=text-align:left>@Cacheable</td><td style=text-align:left>在方法执行前先查询缓存中是否有数据，如果有数据，则直接返回缓存数据；如果<strong>没有缓存数据</strong>，调用方法并将方法返回值放到缓存中</td></tr><tr><td style=text-align:left>@CachePut</td><td style=text-align:left>将方法的返回值放到缓存中</td></tr><tr><td style=text-align:left>@CacheEvict</td><td style=text-align:left>将一条或多条数据从缓存中删除</td></tr></tbody></table><p>具体的实现思路如下</p><ol><li>导入Spring Cache和Redis相关maven坐标</li><li><strong>在启动类上加入@EnableCaching注解，开启缓存注解功能</strong></li><li>在用户端接口SetmealController的 list 方法上加入@Cacheable注解</li><li>在管理端接口SetmealController的 save、delete、update、startOrStop等方法上加入CacheEvict注解</li></ol><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@CachePut</span><span class=p>(</span><span class=n>cacheNames</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;userCache&#34;</span><span class=p>,</span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;#user.id&#34;</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p>如果使用Spring Cache缓存数据，key的生成：userCache::abc</p><p>SpEL可以用来动态的计算key</p><p>#参数 引用形参 . 叫做对象导航</p><p>#p0 #a0.id 拿到第一个参数 #p1 拿到第二个参数</p><p>#root.args[0].id 拿到第一个参数里边的id信息</p><p>#返回值 引用到返回值</p><p>userCache::abc类似是树形结构，一个:代表一个文件夹</p><p>思考一个问题，<strong>为什么key需要动态设置值</strong></p><p>如果key不是动态的，那么没插入一个数据，key都是相同的，会把之前的缓存数据给覆盖掉，所以需要设置一个动态值</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@Cacheable</span><span class=p>(</span><span class=n>cacheNames</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;cacheName&#34;</span><span class=w> </span><span class=p>,</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;#id&#34;</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p><strong>基于代理技术，Spring为这个Controller创建代理对象，在代理对象中动态的把key计算出来，然后把缓存数据清理</strong></p><p>可以直接查缓存中有没有，如果有的话，不需要调用Mapper，如果没有，会调用Mapper，同时把查询出来的数据，放入缓存中</p><p>思考的一个问题，放入cache中的是什么样的对象，是<strong>返回值对象</strong>，在外卖项目中，返回的是Result对象</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 删除一条数据</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@CacheEvict</span><span class=p>(</span><span class=n>cacheNames</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;cacheName&#34;</span><span class=w> </span><span class=p>,</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;#id&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 一次性删除所有缓存</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@CacheEvict</span><span class=p>(</span><span class=n>cacheNames</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;cacheName&#34;</span><span class=p>,</span><span class=w> </span><span class=n>allEntries</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>true</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p>Evict 驱逐的意思</p><h1 id=添加商品到购物车>添加商品到购物车<a hidden class=anchor aria-hidden=true href=#添加商品到购物车>#</a></h1><p><img loading=lazy src=/images/Day07%e7%bc%93%e5%ad%98%e8%8f%9c%e5%93%81%e5%92%8c%e8%b4%ad%e7%89%a9%e8%bd%a6.assets/1740531994152-d7fa66cc-d39f-405f-9ce1-b085d067f649.png alt></p><p>冗余字段：重复出现的字段</p><p>提高查询速度，需要是不能经常变化的数据</p><p>添加商品到购物车的时候，需要先判断商品是不是已经在购物车里了，如果是的话，只需要更新数量</p><p>一次添加只可能是添加菜品或添加套餐</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=c1>//    添加到购物车</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>addShoppingCart</span><span class=p>(</span><span class=n>ShoppingCartDTO</span><span class=w> </span><span class=n>shoppingCartDTO</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//        判断商品是否在购物车里了</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//        写一个动态查询语句来判断</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ShoppingCart</span><span class=w> </span><span class=n>shoppingCart</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ShoppingCart</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>BeanUtils</span><span class=p>.</span><span class=na>copyProperties</span><span class=p>(</span><span class=n>shoppingCartDTO</span><span class=p>,</span><span class=n>shoppingCart</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>shoppingCart</span><span class=p>.</span><span class=na>setUserId</span><span class=p>(</span><span class=n>BaseContext</span><span class=p>.</span><span class=na>getCurrentId</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//        直接传入一个shoppingcartdto不可以，因为无法判断用户是谁，进而无法知道是哪个菜品</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=o>&lt;</span><span class=n>ShoppingCart</span><span class=o>&gt;</span><span class=w> </span><span class=n>list</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>shoppingCartMapper</span><span class=p>.</span><span class=na>getById</span><span class=p>(</span><span class=n>shoppingCart</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//        如果已经在购物车里边，那么直接修改商品的数量</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>list</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>list</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=o>&gt;</span><span class=n>0</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 每次数量只可能是加一，判断是菜品还是套餐</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ShoppingCart</span><span class=w> </span><span class=n>shoppingCart1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>list</span><span class=p>.</span><span class=na>get</span><span class=p>(</span><span class=n>0</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>shoppingCart1</span><span class=p>.</span><span class=na>getDishId</span><span class=p>()</span><span class=o>!=</span><span class=kc>null</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 因为限制了菜品的id和用户的id，所以只可能找出的是一条数据，只需要取list集合里边的第一条数据就行</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>shoppingCart1</span><span class=p>.</span><span class=na>setNumber</span><span class=p>(</span><span class=n>shoppingCart1</span><span class=p>.</span><span class=na>getNumber</span><span class=p>()</span><span class=o>+</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>shoppingCartMapper</span><span class=p>.</span><span class=na>update</span><span class=p>(</span><span class=n>shoppingCart1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 如果不在购物车里边，那么添加数据到购物车</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 如果是菜品数据</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>if</span><span class=p>(</span><span class=n>shoppingCart</span><span class=p>.</span><span class=na>getDishId</span><span class=p>()</span><span class=o>!=</span><span class=kc>null</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//            购物车表里边的name是商品的名字字段，如果是菜品就要用菜品的名字，如果是套餐就要用套餐的名字</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Dish</span><span class=w> </span><span class=n>dish</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>dishMapper</span><span class=p>.</span><span class=na>getById</span><span class=p>(</span><span class=n>shoppingCart</span><span class=p>.</span><span class=na>getDishId</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>shoppingCart</span><span class=p>.</span><span class=na>setName</span><span class=p>(</span><span class=n>dish</span><span class=p>.</span><span class=na>getName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>shoppingCart</span><span class=p>.</span><span class=na>setImage</span><span class=p>(</span><span class=n>dish</span><span class=p>.</span><span class=na>getImage</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>shoppingCart</span><span class=p>.</span><span class=na>setAmount</span><span class=p>(</span><span class=n>dish</span><span class=p>.</span><span class=na>getPrice</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 需要插入的是套餐数据</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>Setmeal</span><span class=w> </span><span class=n>setmeal</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>setmealMapper</span><span class=p>.</span><span class=na>getById</span><span class=p>(</span><span class=n>shoppingCart</span><span class=p>.</span><span class=na>getSetmealId</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>shoppingCart</span><span class=p>.</span><span class=na>setName</span><span class=p>(</span><span class=n>setmeal</span><span class=p>.</span><span class=na>getName</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>shoppingCart</span><span class=p>.</span><span class=na>setImage</span><span class=p>(</span><span class=n>setmeal</span><span class=p>.</span><span class=na>getImage</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>shoppingCart</span><span class=p>.</span><span class=na>setAmount</span><span class=p>(</span><span class=n>setmeal</span><span class=p>.</span><span class=na>getPrice</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>shoppingCart</span><span class=p>.</span><span class=na>setNumber</span><span class=p>(</span><span class=n>1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>shoppingCart</span><span class=p>.</span><span class=na>setCreateTime</span><span class=p>(</span><span class=n>LocalDateTime</span><span class=p>.</span><span class=na>now</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>shoppingCartMapper</span><span class=p>.</span><span class=na>insert</span><span class=p>(</span><span class=n>shoppingCart</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://wqnm1gb.github.io/tags/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96/>苍穹外卖</a></li></ul><nav class=paginav><a class=prev href=https://wqnm1gb.github.io/posts/day08%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/><span class=title>« 上一页</span><br><span>Day08 用户下单、订单支付</span>
</a><a class=next href=https://wqnm1gb.github.io/posts/day06%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95%E5%95%86%E5%93%81%E6%B5%8F%E8%A7%88/><span class=title>下一页 »</span><br><span>Day06 微信登录、商品浏览</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://wqnm1gb.github.io/>三狗子的博客</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>