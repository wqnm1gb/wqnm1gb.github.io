<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Day10 订单状态定时处理、来单提醒和客户催单 | 三狗子的博客</title>
<meta name=keywords content="苍穹外卖"><meta name=description content="Spring Task
Spring Task是Spring框架提供的任务调度工具，可以按照约定的时间自动执行某个代码逻辑。
定位：定时任务框架
作用：定时执行某段java代码
应用场景："><meta name=author content="冷漠三狗子丶"><link rel=canonical href=https://wqnm1gb.github.io/posts/day10%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%E5%92%8C%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95/><link crossorigin=anonymous href=/assets/css/stylesheet.3d688279d829dc24da48acd11f9e33ebea2f39c035e899e1bf4297d8b7aa89b9.css integrity="sha256-PWiCedgp3CTaSKzRH54z6+ovOcA16Jnhv0KX2Leqibk=" rel="preload stylesheet" as=style><link rel=icon href=https://wqnm1gb.github.io/images/favicon.png><link rel=icon type=image/png sizes=16x16 href=https://wqnm1gb.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://wqnm1gb.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://wqnm1gb.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://wqnm1gb.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://wqnm1gb.github.io/posts/day10%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%E5%92%8C%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap" rel=stylesheet><script type=text/javascript async src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">MathJax.Hub.Config({tex2jax:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["[[","]]"]],processEscapes:!0,processEnvironments:!0,skipTags:["script","noscript","style","textarea","pre"],TeX:{equationNumbers:{autoNumber:"AMS"},extensions:["AMSmath.js","AMSsymbols.js"]}}}),MathJax.Hub.Queue(function(){var e,t=MathJax.Hub.getAllJax();for(e=0;e<t.length;e+=1)t[e].SourceElement().parentNode.className+=" has-jax"})</script><style>code.has-jax{font:inherit;font-size:100%;background:inherit;border:inherit;color:#515151}</style><meta property="og:title" content="Day10 订单状态定时处理、来单提醒和客户催单"><meta property="og:description" content="Spring Task
Spring Task是Spring框架提供的任务调度工具，可以按照约定的时间自动执行某个代码逻辑。
定位：定时任务框架
作用：定时执行某段java代码
应用场景："><meta property="og:type" content="article"><meta property="og:url" content="https://wqnm1gb.github.io/posts/day10%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%E5%92%8C%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95/"><meta property="og:image" content="https://wqnm1gb.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-03-20T11:09:01+08:00"><meta property="article:modified_time" content="2025-03-20T11:09:01+08:00"><meta property="og:site_name" content="三狗子的博客"><meta property="fb:admins" content="your-facebook-admin-id"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://wqnm1gb.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Day10 订单状态定时处理、来单提醒和客户催单","item":"https://wqnm1gb.github.io/posts/day10%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%E5%92%8C%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Day10 订单状态定时处理、来单提醒和客户催单","name":"Day10 订单状态定时处理、来单提醒和客户催单","description":"Spring Task Spring Task是Spring框架提供的任务调度工具，可以按照约定的时间自动执行某个代码逻辑。\n定位：定时任务框架\n作用：定时执行某段java代码\n应用场景：\n","keywords":["苍穹外卖"],"articleBody":"Spring Task Spring Task是Spring框架提供的任务调度工具，可以按照约定的时间自动执行某个代码逻辑。\n定位：定时任务框架\n作用：定时执行某段java代码\n应用场景：\n信用卡每月还款提醒 银行贷款每月还款提醒 火车票售票系统处理未支付订单 入职纪念日为用户发送通知 只要是需要定时处理的场景都可以使用Spring Task\ncron表达式 cron表达式其实就是一个字符串，通过cron表达式可以定义任务触发的时间\n构成规则：分为6或7个域，由空格分隔开，每个域代表一个含义\n每个域的含义分别为：秒、分钟、小时、日、月、周、年（可选）\ncron表达式可以用在线生成器生成\nSpring Task使用步骤：\n导入maven坐标 spring-context（已存在） 启动类添加注解 @EnableScheduling 开启任务调度 自定义定时任务类 如果指定了是几号，星期的位置要写一个？\n如果指定了周几，那具体是几号写一个？\n往往只能定义一个，另一个地方写成问号\n中间用空格隔开\ncron表达式在线生成器\n*号代表着每秒，每分钟，每小时\n?代表的是不指定\n本项目中的案例 需求分析\n用户下单后可能存在的情况：\n下单后未支付，订单一直处于“待支付”状态 用户收货后管理端未点击完成按钮，订单一直处于“派送中〞状态 对于上面两种情况需要通过定时任务来修改订单状态，具体逻辑为：\n通过定时任务每分钟检查一次是否存在支付超时订单（下单后超过15分钟仍未支付则判定为支付超时订单），如果存在则修改订单状态为“已取消” 通过定时任务每天凌晨1点检查一次是否存在“派送中”的订单，如果存在则修改订单状态为“已完成” /** * 自定义订单定时处理任务 */ @Component @Slf4j public class OrderTask { @Autowired private OrderMapper orderMapper; /** * 处理未付款超过15分钟的订单 * 每一分钟检查一下，是否有超过15分钟都没有付款的订单 */ @Scheduled(cron = \"0 * * * * ?\") // 每分钟执行一次 public void processTimeoutOrder(){ log.info(\"未付款订单检测{}\", LocalDateTime.now()); // select * from order where status = ? and order_time \u003c= now -15 List\u003cOrders\u003e ordersList = orderMapper.getByStatusAndTimeLT(Orders.PENDING_PAYMENT, LocalDateTime.now().plusMinutes(-15)); if (ordersList !=null \u0026\u0026 ordersList.size()\u003e0){ for (Orders orders : ordersList) { // 把状态改成已取消 orders.setStatus(Orders.CANCELLED); orders.setCancelReason(\"用户支付超时\"); orders.setCancelTime(LocalDateTime.now()); orderMapper.update(orders); } } } /** * 处理还在派送中未完成的订单 */ @Scheduled(cron = \"0 0 1 * * ?\") // 每天1点执行一次 public void processNotComplete(){ log.info(\"处理还在派送中的订单{}\",LocalDateTime.now()); List\u003cOrders\u003e ordersList = orderMapper.getByStatusAndTimeLT(Orders.DELIVERY_IN_PROGRESS, LocalDateTime.now().plusMinutes(-60)); if (ordersList !=null \u0026\u0026 ordersList.size()\u003e0){ for (Orders orders : ordersList) { // 把状态改成已完成 orders.setStatus(Orders.COMPLETED); orderMapper.update(orders); } } } } WebSocket WebSocket 是基于 TCP的一种新的网络协议。它实现了浏览器与服务器全双工通信——浏览器和服务器只需要完成一次握手，两者之间就可以创建持久性的连接，并进行双向数据传输。\nhttp协议，交互一定是从客户端发给浏览器，短连接\nwebSocket是双向消息\nws就是websocket的缩写，在机器人里边用到了\nHTTP协议和WebSocket协议对比：\nHTTP是短连接 WebSocket是长连接 HTTP通信是单向的，基于请求响应模式 WebSocket支持双向通信 HTTP和WebSocket底层都是TCP连接 应用场景：\n视频弹幕 网页聊天 体育实况更新 股票基金报价实时更新 WebSocket入门案例 实现步骤：\n直接使用websocket.html页面作为WebSocket客户端 导入WebSocket的maven坐标 导入WebSocket服务端组件WebSocketServer，用于和客户端通信 导入配置类WebSocketConfiguration，注册WebSocket的服务端组件 导入定时任务类WebSocketTask，定时向客户端推送数据 既然WebSocket支持双向通信，功能看似比HTTP强大，那么我们\n是不是可以基于WebSocket开发所有的业务功能？\nWebSocket缺点：\n服务器长期维护长连接需要一定的成本 各个浏览器支持程度不一 WebSocket 是长连接，受网络限制比较大，需要处理好重连 结论：WebSocket并不能完全取代HTTP，它只适合在特定的场景下使用\n服务器配置类 package com.sky.config; import org.springframework.context.annotation.Bean; import org.springframework.context.annotation.Configuration; import org.springframework.web.socket.server.standard.ServerEndpointExporter; /** * WebSocket配置类，用于注册WebSocket的Bean */ @Configuration public class WebSocketConfiguration { @Bean public ServerEndpointExporter serverEndpointExporter() { return new ServerEndpointExporter(); } } WebSocketServer package com.sky.websocket; import org.springframework.stereotype.Component; import javax.websocket.OnClose; import javax.websocket.OnMessage; import javax.websocket.OnOpen; import javax.websocket.Session; import javax.websocket.server.PathParam; import javax.websocket.server.ServerEndpoint; import java.util.Collection; import java.util.HashMap; import java.util.Map; /** * WebSocket服务 */ @Component @ServerEndpoint(\"/ws/{sid}\") public class WebSocketServer { //存放会话对象 private static Map\u003cString, Session\u003e sessionMap = new HashMap(); /** * 连接建立成功调用的方法 */ @OnOpen public void onOpen(Session session, @PathParam(\"sid\") String sid) { System.out.println(\"客户端：\" + sid + \"建立连接\"); sessionMap.put(sid, session); } /** * 收到客户端消息后调用的方法 * * @param message 客户端发送过来的消息 */ @OnMessage public void onMessage(String message, @PathParam(\"sid\") String sid) { System.out.println(\"收到来自客户端：\" + sid + \"的信息:\" + message); } /** * 连接关闭调用的方法 * * @param sid */ @OnClose public void onClose(@PathParam(\"sid\") String sid) { System.out.println(\"连接断开:\" + sid); sessionMap.remove(sid); } /** * 群发 * * @param message */ public void sendToAllClient(String message) { Collection\u003cSession\u003e sessions = sessionMap.values(); for (Session session : sessions) { try { //服务器向客户端发送消息 session.getBasicRemote().sendText(message); } catch (Exception e) { e.printStackTrace(); } } } } Task任务向客户端发信息 package com.sky.task; import com.sky.websocket.WebSocketServer; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.scheduling.annotation.Scheduled; import org.springframework.stereotype.Component; import java.time.LocalDateTime; import java.time.format.DateTimeFormatter; @Component public class WebSocketTask { @Autowired private WebSocketServer webSocketServer; /** * 通过WebSocket每隔5秒向客户端发送消息 */ @Scheduled(cron = \"0/5 * * * * ?\") public void sendMessageToClient() { webSocketServer.sendToAllClient(\"这是来自服务端的消息：\" + DateTimeFormatter.ofPattern(\"HH:mm:ss\").format(LocalDateTime.now())); } } 客户端html代码 \u003c!DOCTYPE HTML\u003e \u003chtml\u003e \u003chead\u003e \u003cmeta charset=\"UTF-8\"\u003e \u003ctitle\u003eWebSocket Demo\u003c/title\u003e \u003c/head\u003e \u003cbody\u003e \u003cinput id=\"text\" type=\"text\" /\u003e \u003cbutton onclick=\"send()\"\u003e发送消息\u003c/button\u003e \u003cbutton onclick=\"closeWebSocket()\"\u003e关闭连接\u003c/button\u003e \u003cdiv id=\"message\"\u003e \u003c/div\u003e \u003c/body\u003e \u003cscript type=\"text/javascript\"\u003e var websocket = null; var clientId = Math.random().toString(36).substr(2); //判断当前浏览器是否支持WebSocket if('WebSocket' in window){ //连接WebSocket节点 websocket = new WebSocket(\"ws://localhost:8080/ws/\"+clientId); } else{ alert('Not support websocket') } //连接发生错误的回调方法 websocket.onerror = function(){ setMessageInnerHTML(\"error\"); }; //连接成功建立的回调方法 websocket.onopen = function(){ setMessageInnerHTML(\"连接成功\"); } //接收到消息的回调方法 websocket.onmessage = function(event){ setMessageInnerHTML(event.data); } //连接关闭的回调方法 websocket.onclose = function(){ setMessageInnerHTML(\"close\"); } //监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。 window.onbeforeunload = function(){ websocket.close(); } //将消息显示在网页上 function setMessageInnerHTML(innerHTML){ document.getElementById('message').innerHTML += innerHTML + '\u003cbr/\u003e'; } //发送消息 function send(){ var message = document.getElementById('text').value; websocket.send(message); } //关闭连接 function closeWebSocket() { websocket.close(); } \u003c/script\u003e \u003c/html\u003e 如果建立了连接，后端服务器会提示\n更改了两个配置文件\n参考链接：https://blog.csdn.net/weixin_40433846/article/details/136520927\n来单提醒功能实现 设计：\n通过WebSocket实现管理端页面和服务端保持长连接状态 当客户支付后，调用WebSocket的相关API实现服务端向客户端推送消息 客户端浏览器解析服务端推送的消息，判断是来单提醒还是客户催单，进行相应的消息提示和语音播报 约定服务端发送给客户端浏览器的数据格式为JSON，字段包括：type,orderld, content type 为消息类型，1为来单提醒2为客户催单\norderld 为订单id\ncontent 为消息内容\n修改paySuccess代码\npublic void paySuccess(String outTradeNo) { // 根据订单号查询订单 Orders ordersDB = orderMapper.getByNumber(outTradeNo); // 根据订单id更新订单的状态、支付方式、支付状态、结账时间 Orders orders = Orders.builder() .id(ordersDB.getId()) .status(Orders.TO_BE_CONFIRMED) .payStatus(Orders.PAID) .checkoutTime(LocalDateTime.now()) .build(); orderMapper.update(orders); // 还要给客户端（这里的客户端指的是管理界面）发送待接单的信息，整个后端系 统称之为服务器 // 先构造一个JSON字符串 Map map = new HashMap(); map.put(\"type\",1); // 通知类型，是1表示是接单提醒，2表示的是催单提醒 map.put(\"orderId\",ordersDB.getId()); map.put(\"content\",\"订单号\"+outTradeNo); String jsonString = JSON.toJSONString(map); // 因为我可能打开了很多管理端的界面，对于每个界面都建立ws连接，然后发送信息 webSocketServer.sendToAllClient(jsonString); } 对于webSocket来说，服务器就是运行java代码的地方，客户端是后台管理端\n客户催单的方法是类似的，分析一下\n首先客户在小程序点击催单按钮，抵达Controller后，会继续调用service，首先判断订单是否存在，只有存在才可以催单，然后构造一个Json数据，因为之前约定了发送给客户端的信息内容要求，客户端（管理后台）收到了数据后就会解析，然后进行响应\n","wordCount":"3248","inLanguage":"zh","image":"https://wqnm1gb.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2025-03-20T11:09:01+08:00","dateModified":"2025-03-20T11:09:01+08:00","author":{"@type":"Person","name":"冷漠三狗子丶"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://wqnm1gb.github.io/posts/day10%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%E5%92%8C%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95/"},"publisher":{"@type":"Organization","name":"三狗子的博客","logo":{"@type":"ImageObject","url":"https://wqnm1gb.github.io/images/favicon.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wqnm1gb.github.io/ accesskey=h title="主页 (Alt + H)"><img src=https://wqnm1gb.github.io/apple-touch-icon.png alt aria-label=logo height=35>主页</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://wqnm1gb.github.io/ title=三狗子的博客><span>首页</span></a></li><li><a href=https://wqnm1gb.github.io/archives/ title=归档><span>归档</span></a></li><li><a href=https://wqnm1gb.github.io/categories/ title=Categories><span>分类</span></a></li><li><a href=https://wqnm1gb.github.io/tags/ title=Tags><span>标签</span></a></li><li><a href=https://wqnm1gb.github.io/search/ title=搜索><span>搜索</span></a></li><li><a href=https://wqnm1gb.github.io/about/ title=关于><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://wqnm1gb.github.io/>主页</a>&nbsp;»&nbsp;<a href=https://wqnm1gb.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Day10 订单状态定时处理、来单提醒和客户催单</h1><div class=post-meta><span title='2025-03-20 11:09:01 +0800 +0800'>三月 20, 2025</span>&nbsp;·&nbsp;7 分钟&nbsp;·&nbsp;3248 字&nbsp;·&nbsp;冷漠三狗子丶</div></header><div class=post-content><h1 id=spring-task>Spring Task<a hidden class=anchor aria-hidden=true href=#spring-task>#</a></h1><p>Spring Task是Spring框架提供的<strong>任务调度工具</strong>，可以<strong>按照约定的时间自动执行某个代码逻辑</strong>。</p><p>定位：<strong>定时任务框架</strong></p><p><strong>作用：定时执行某段java代码</strong></p><p><strong>应用场景：</strong></p><ul><li>信用卡每月还款提醒</li><li>银行贷款每月还款提醒</li><li>火车票售票系统处理未支付订单</li><li>入职纪念日为用户发送通知</li></ul><p><strong>只要是需要定时处理的场景都可以使用Spring Task</strong></p><h2 id=cron表达式>cron表达式<a hidden class=anchor aria-hidden=true href=#cron表达式>#</a></h2><p>cron表达式其实就是<strong>一个字符串</strong>，通过cron表达式可以<strong>定义任务触发的时间</strong></p><p>构成规则：分为6或7个域，由空格分隔开，每个域代表一个含义</p><p>每个域的含义分别为：秒、分钟、小时、日、月、周、年（<strong>可选</strong>）</p><p><img loading=lazy src=/images/Day10%e8%ae%a2%e5%8d%95%e7%8a%b6%e6%80%81%e5%ae%9a%e6%97%b6%e5%a4%84%e7%90%86%e3%80%81%e6%9d%a5%e5%8d%95%e6%8f%90%e9%86%92%e5%92%8c%e5%ae%a2%e6%88%b7%e5%82%ac%e5%8d%95.assets/1741050579896-4f44b2cf-b80d-4f30-9840-7a7299a8fa71.png alt></p><p>cron表达式可以用在线生成器生成</p><p>Spring Task使用步骤：</p><ol><li>导入maven坐标 spring-context（已存在）</li><li>启动类添加注解 @EnableScheduling 开启任务调度</li><li>自定义定时任务类</li></ol><p>如果指定了是几号，星期的位置要写一个？</p><p>如果指定了周几，那具体是几号写一个？</p><p>往往只能定义一个，另一个地方写成问号</p><p>中间用空格隔开</p><p>cron表达式在线生成器</p><p>*号代表着每秒，每分钟，每小时</p><p>?代表的是不指定</p><h2 id=本项目中的案例>本项目中的案例<a hidden class=anchor aria-hidden=true href=#本项目中的案例>#</a></h2><p>需求分析</p><p>用户下单后可能存在的情况：</p><ul><li>下单后未支付，订单一直处于“待支付”状态</li><li>用户收货后管理端未点击完成按钮，订单一直处于“派送中〞状态</li></ul><p>对于上面两种情况需要通过定时任务来修改订单状态，具体逻辑为：</p><ul><li>通过定时任务每分钟检查一次是否存在支付超时订单（下单后超过15分钟仍未支付则判定为支付超时订单），如果存在则修改订单状态为“已取消”</li><li>通过定时任务每天凌晨1点检查一次是否存在“派送中”的订单，如果存在则修改订单状态为“已完成”</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * 自定义订单定时处理任务
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>OrderTask</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>OrderMapper</span><span class=w> </span><span class=n>orderMapper</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 处理未付款超过15分钟的订单
</span></span></span><span class=line><span class=cl><span class=cm>     * 每一分钟检查一下，是否有超过15分钟都没有付款的订单
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Scheduled</span><span class=p>(</span><span class=n>cron</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;0 * * * * ?&#34;</span><span class=p>)</span><span class=w> </span><span class=c1>// 每分钟执行一次</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>processTimeoutOrder</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;未付款订单检测{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>LocalDateTime</span><span class=p>.</span><span class=na>now</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// select * from order where status = ? and order_time &lt;= now -15</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Orders</span><span class=o>&gt;</span><span class=w> </span><span class=n>ordersList</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderMapper</span><span class=p>.</span><span class=na>getByStatusAndTimeLT</span><span class=p>(</span><span class=n>Orders</span><span class=p>.</span><span class=na>PENDING_PAYMENT</span><span class=p>,</span><span class=w> </span><span class=n>LocalDateTime</span><span class=p>.</span><span class=na>now</span><span class=p>().</span><span class=na>plusMinutes</span><span class=p>(</span><span class=o>-</span><span class=n>15</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ordersList</span><span class=w> </span><span class=o>!=</span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>ordersList</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=o>&gt;</span><span class=n>0</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Orders</span><span class=w> </span><span class=n>orders</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>ordersList</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 把状态改成已取消</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>orders</span><span class=p>.</span><span class=na>setStatus</span><span class=p>(</span><span class=n>Orders</span><span class=p>.</span><span class=na>CANCELLED</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>orders</span><span class=p>.</span><span class=na>setCancelReason</span><span class=p>(</span><span class=s>&#34;用户支付超时&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>orders</span><span class=p>.</span><span class=na>setCancelTime</span><span class=p>(</span><span class=n>LocalDateTime</span><span class=p>.</span><span class=na>now</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>orderMapper</span><span class=p>.</span><span class=na>update</span><span class=p>(</span><span class=n>orders</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 处理还在派送中未完成的订单
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Scheduled</span><span class=p>(</span><span class=n>cron</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;0 0 1 * * ?&#34;</span><span class=p>)</span><span class=w> </span><span class=c1>// 每天1点执行一次</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>processNotComplete</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;处理还在派送中的订单{}&#34;</span><span class=p>,</span><span class=n>LocalDateTime</span><span class=p>.</span><span class=na>now</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=o>&lt;</span><span class=n>Orders</span><span class=o>&gt;</span><span class=w> </span><span class=n>ordersList</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderMapper</span><span class=p>.</span><span class=na>getByStatusAndTimeLT</span><span class=p>(</span><span class=n>Orders</span><span class=p>.</span><span class=na>DELIVERY_IN_PROGRESS</span><span class=p>,</span><span class=w> </span><span class=n>LocalDateTime</span><span class=p>.</span><span class=na>now</span><span class=p>().</span><span class=na>plusMinutes</span><span class=p>(</span><span class=o>-</span><span class=n>60</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>ordersList</span><span class=w> </span><span class=o>!=</span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>ordersList</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=o>&gt;</span><span class=n>0</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Orders</span><span class=w> </span><span class=n>orders</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>ordersList</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>// 把状态改成已完成</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>orders</span><span class=p>.</span><span class=na>setStatus</span><span class=p>(</span><span class=n>Orders</span><span class=p>.</span><span class=na>COMPLETED</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>orderMapper</span><span class=p>.</span><span class=na>update</span><span class=p>(</span><span class=n>orders</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p><img loading=lazy src=/images/Day10%e8%ae%a2%e5%8d%95%e7%8a%b6%e6%80%81%e5%ae%9a%e6%97%b6%e5%a4%84%e7%90%86%e3%80%81%e6%9d%a5%e5%8d%95%e6%8f%90%e9%86%92%e5%92%8c%e5%ae%a2%e6%88%b7%e5%82%ac%e5%8d%95.assets/1741050889622-73123f52-9b4f-497b-9c73-76fc89dc96c0.png alt></p><h1 id=websocket>WebSocket<a hidden class=anchor aria-hidden=true href=#websocket>#</a></h1><p>WebSocket 是基于 TCP的一种新的网络协议。它实现了浏览器与服务器全双工通信——浏览器和服务器只需要<strong>完成一次握手</strong>，两者之间就可以创建持久性的连接，并进行<strong>双向数据传输</strong>。</p><p>http协议，交互一定是从客户端发给浏览器，短连接</p><p>webSocket是双向消息</p><p>ws就是websocket的缩写，在机器人里边用到了</p><p><strong>HTTP协议和WebSocket协议对比：</strong></p><ul><li>HTTP是短连接</li><li>WebSocket是长连接</li><li>HTTP通信是单向的，基于请求响应模式</li><li>WebSocket支持双向通信</li><li>HTTP和WebSocket底层都是TCP连接</li></ul><p><img loading=lazy src=/images/Day10%e8%ae%a2%e5%8d%95%e7%8a%b6%e6%80%81%e5%ae%9a%e6%97%b6%e5%a4%84%e7%90%86%e3%80%81%e6%9d%a5%e5%8d%95%e6%8f%90%e9%86%92%e5%92%8c%e5%ae%a2%e6%88%b7%e5%82%ac%e5%8d%95.assets/1741051005730-97d550ee-efa2-4ec1-8886-316f85ecfa47.png alt>
<img loading=lazy src=/images/Day10%e8%ae%a2%e5%8d%95%e7%8a%b6%e6%80%81%e5%ae%9a%e6%97%b6%e5%a4%84%e7%90%86%e3%80%81%e6%9d%a5%e5%8d%95%e6%8f%90%e9%86%92%e5%92%8c%e5%ae%a2%e6%88%b7%e5%82%ac%e5%8d%95.assets/1741051009445-e434df0f-109a-42f7-b2cd-277466ee70fd.png alt></p><p>应用场景：</p><ul><li>视频弹幕</li><li>网页聊天</li><li>体育实况更新</li><li>股票基金报价实时更新</li></ul><h2 id=websocket入门案例>WebSocket入门案例<a hidden class=anchor aria-hidden=true href=#websocket入门案例>#</a></h2><p>实现步骤：</p><ol><li>直接使用websocket.html页面作为WebSocket客户端</li><li>导入WebSocket的maven坐标</li><li>导入WebSocket服务端组件WebSocketServer，用于和客户端通信</li><li>导入配置类WebSocketConfiguration，注册WebSocket的服务端组件</li><li>导入定时任务类WebSocketTask，定时向客户端推送数据</li></ol><p>既然WebSocket支持双向通信，功能看似比HTTP强大，那么我们</p><p>是不是可以基于WebSocket开发所有的业务功能？</p><p><strong>WebSocket缺点：</strong></p><ol><li>服务器长期维护长连接需要一定的成本</li><li>各个浏览器支持程度不一</li><li>WebSocket 是长连接，受网络限制比较大，需要处理好重连</li></ol><p>结论：WebSocket并不能完全取代HTTP，它只适合<strong>在特定的场景下使用</strong></p><h2 id=服务器配置类>服务器配置类<a hidden class=anchor aria-hidden=true href=#服务器配置类>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>com.sky.config</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.context.annotation.Bean</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.context.annotation.Configuration</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.web.socket.server.standard.ServerEndpointExporter</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * WebSocket配置类，用于注册WebSocket的Bean
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Configuration</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>WebSocketConfiguration</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Bean</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>ServerEndpointExporter</span><span class=w> </span><span class=nf>serverEndpointExporter</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ServerEndpointExporter</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=websocketserver>WebSocketServer<a hidden class=anchor aria-hidden=true href=#websocketserver>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>com.sky.websocket</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.stereotype.Component</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>javax.websocket.OnClose</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>javax.websocket.OnMessage</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>javax.websocket.OnOpen</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>javax.websocket.Session</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>javax.websocket.server.PathParam</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>javax.websocket.server.ServerEndpoint</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.Collection</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.HashMap</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.Map</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm> * WebSocket服务
</span></span></span><span class=line><span class=cl><span class=cm> */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@ServerEndpoint</span><span class=p>(</span><span class=s>&#34;/ws/{sid}&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>WebSocketServer</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//存放会话对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=kd>static</span><span class=w> </span><span class=n>Map</span><span class=o>&lt;</span><span class=n>String</span><span class=p>,</span><span class=w> </span><span class=n>Session</span><span class=o>&gt;</span><span class=w> </span><span class=n>sessionMap</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashMap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 连接建立成功调用的方法
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@OnOpen</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onOpen</span><span class=p>(</span><span class=n>Session</span><span class=w> </span><span class=n>session</span><span class=p>,</span><span class=w> </span><span class=nd>@PathParam</span><span class=p>(</span><span class=s>&#34;sid&#34;</span><span class=p>)</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>sid</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;客户端：&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>sid</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;建立连接&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sessionMap</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=n>sid</span><span class=p>,</span><span class=w> </span><span class=n>session</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 收到客户端消息后调用的方法
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param message 客户端发送过来的消息
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@OnMessage</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onMessage</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>message</span><span class=p>,</span><span class=w> </span><span class=nd>@PathParam</span><span class=p>(</span><span class=s>&#34;sid&#34;</span><span class=p>)</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>sid</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;收到来自客户端：&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>sid</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=s>&#34;的信息:&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>message</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 连接关闭调用的方法
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param sid
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@OnClose</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>onClose</span><span class=p>(</span><span class=nd>@PathParam</span><span class=p>(</span><span class=s>&#34;sid&#34;</span><span class=p>)</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=n>sid</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>System</span><span class=p>.</span><span class=na>out</span><span class=p>.</span><span class=na>println</span><span class=p>(</span><span class=s>&#34;连接断开:&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>sid</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>sessionMap</span><span class=p>.</span><span class=na>remove</span><span class=p>(</span><span class=n>sid</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 群发
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param message
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>sendToAllClient</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>message</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Collection</span><span class=o>&lt;</span><span class=n>Session</span><span class=o>&gt;</span><span class=w> </span><span class=n>sessions</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>sessionMap</span><span class=p>.</span><span class=na>values</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Session</span><span class=w> </span><span class=n>session</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>sessions</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>try</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=c1>//服务器向客户端发送消息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>session</span><span class=p>.</span><span class=na>getBasicRemote</span><span class=p>().</span><span class=na>sendText</span><span class=p>(</span><span class=n>message</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w> </span><span class=k>catch</span><span class=w> </span><span class=p>(</span><span class=n>Exception</span><span class=w> </span><span class=n>e</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=n>e</span><span class=p>.</span><span class=na>printStackTrace</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=task任务向客户端发信息>Task任务向客户端发信息<a hidden class=anchor aria-hidden=true href=#task任务向客户端发信息>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>com.sky.task</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sky.websocket.WebSocketServer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.beans.factory.annotation.Autowired</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.scheduling.annotation.Scheduled</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.stereotype.Component</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.time.LocalDateTime</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.time.format.DateTimeFormatter</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Component</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>WebSocketTask</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>WebSocketServer</span><span class=w> </span><span class=n>webSocketServer</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 通过WebSocket每隔5秒向客户端发送消息
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Scheduled</span><span class=p>(</span><span class=n>cron</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;0/5 * * * * ?&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>sendMessageToClient</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>webSocketServer</span><span class=p>.</span><span class=na>sendToAllClient</span><span class=p>(</span><span class=s>&#34;这是来自服务端的消息：&#34;</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>DateTimeFormatter</span><span class=p>.</span><span class=na>ofPattern</span><span class=p>(</span><span class=s>&#34;HH:mm:ss&#34;</span><span class=p>).</span><span class=na>format</span><span class=p>(</span><span class=n>LocalDateTime</span><span class=p>.</span><span class=na>now</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=客户端html代码>客户端html代码<a hidden class=anchor aria-hidden=true href=#客户端html代码>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=o>&lt;!</span><span class=n>DOCTYPE</span><span class=w> </span><span class=n>HTML</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>&lt;</span><span class=n>html</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>&lt;</span><span class=n>head</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>&lt;</span><span class=n>meta</span><span class=w> </span><span class=n>charset</span><span class=o>=</span><span class=s>&#34;UTF-8&#34;</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>&lt;</span><span class=n>title</span><span class=o>&gt;</span><span class=n>WebSocket</span><span class=w> </span><span class=n>Demo</span><span class=o>&lt;/</span><span class=n>title</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>&lt;/</span><span class=n>head</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>&lt;</span><span class=n>body</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>&lt;</span><span class=n>input</span><span class=w> </span><span class=n>id</span><span class=o>=</span><span class=s>&#34;text&#34;</span><span class=w> </span><span class=n>type</span><span class=o>=</span><span class=s>&#34;text&#34;</span><span class=w> </span><span class=o>/&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>&lt;</span><span class=n>button</span><span class=w> </span><span class=n>onclick</span><span class=o>=</span><span class=s>&#34;send()&#34;</span><span class=o>&gt;</span><span class=n>发送消息</span><span class=o>&lt;/</span><span class=n>button</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>&lt;</span><span class=n>button</span><span class=w> </span><span class=n>onclick</span><span class=o>=</span><span class=s>&#34;closeWebSocket()&#34;</span><span class=o>&gt;</span><span class=n>关闭连接</span><span class=o>&lt;/</span><span class=n>button</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>&lt;</span><span class=n>div</span><span class=w> </span><span class=n>id</span><span class=o>=</span><span class=s>&#34;message&#34;</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=o>&lt;/</span><span class=n>div</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>&lt;/</span><span class=n>body</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>&lt;</span><span class=n>script</span><span class=w> </span><span class=n>type</span><span class=o>=</span><span class=s>&#34;text/javascript&#34;</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>websocket</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=kc>null</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>var</span><span class=w> </span><span class=n>clientId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Math</span><span class=p>.</span><span class=na>random</span><span class=p>().</span><span class=na>toString</span><span class=p>(</span><span class=n>36</span><span class=p>).</span><span class=na>substr</span><span class=p>(</span><span class=n>2</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//判断当前浏览器是否支持WebSocket</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>if</span><span class=p>(</span><span class=err>&#39;</span><span class=n>WebSocket</span><span class=err>&#39;</span><span class=w> </span><span class=n>in</span><span class=w> </span><span class=n>window</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//连接WebSocket节点</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>websocket</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>WebSocket</span><span class=p>(</span><span class=s>&#34;ws://localhost:8080/ws/&#34;</span><span class=o>+</span><span class=n>clientId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=k>else</span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>alert</span><span class=p>(</span><span class=err>&#39;</span><span class=n>Not</span><span class=w> </span><span class=n>support</span><span class=w> </span><span class=n>websocket</span><span class=err>&#39;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//连接发生错误的回调方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>websocket</span><span class=p>.</span><span class=na>onerror</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>function</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>setMessageInnerHTML</span><span class=p>(</span><span class=s>&#34;error&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>};</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//连接成功建立的回调方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>websocket</span><span class=p>.</span><span class=na>onopen</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>function</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>setMessageInnerHTML</span><span class=p>(</span><span class=s>&#34;连接成功&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//接收到消息的回调方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>websocket</span><span class=p>.</span><span class=na>onmessage</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>function</span><span class=p>(</span><span class=n>event</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>setMessageInnerHTML</span><span class=p>(</span><span class=n>event</span><span class=p>.</span><span class=na>data</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//连接关闭的回调方法</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>websocket</span><span class=p>.</span><span class=na>onclose</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>function</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>setMessageInnerHTML</span><span class=p>(</span><span class=s>&#34;close&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//监听窗口关闭事件，当窗口关闭时，主动去关闭websocket连接，防止连接还没断开就关闭窗口，server端会抛异常。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>window</span><span class=p>.</span><span class=na>onbeforeunload</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>function</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>websocket</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//将消息显示在网页上</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>function</span><span class=w> </span><span class=nf>setMessageInnerHTML</span><span class=p>(</span><span class=n>innerHTML</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>document</span><span class=p>.</span><span class=na>getElementById</span><span class=p>(</span><span class=err>&#39;</span><span class=n>message</span><span class=err>&#39;</span><span class=p>).</span><span class=na>innerHTML</span><span class=w> </span><span class=o>+=</span><span class=w> </span><span class=n>innerHTML</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=err>&#39;</span><span class=o>&lt;</span><span class=n>br</span><span class=o>/&gt;</span><span class=err>&#39;</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=c1>//发送消息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>function</span><span class=w> </span><span class=nf>send</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=kd>var</span><span class=w> </span><span class=n>message</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>document</span><span class=p>.</span><span class=na>getElementById</span><span class=p>(</span><span class=err>&#39;</span><span class=n>text</span><span class=err>&#39;</span><span class=p>).</span><span class=na>value</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>websocket</span><span class=p>.</span><span class=na>send</span><span class=p>(</span><span class=n>message</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>	
</span></span></span><span class=line><span class=cl><span class=w>	</span><span class=c1>//关闭连接</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=n>function</span><span class=w> </span><span class=nf>closeWebSocket</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>websocket</span><span class=p>.</span><span class=na>close</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>&lt;/</span><span class=n>script</span><span class=o>&gt;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=o>&lt;/</span><span class=n>html</span><span class=o>&gt;</span><span class=w>
</span></span></span></code></pre></div><p><img loading=lazy src=/images/Day10%e8%ae%a2%e5%8d%95%e7%8a%b6%e6%80%81%e5%ae%9a%e6%97%b6%e5%a4%84%e7%90%86%e3%80%81%e6%9d%a5%e5%8d%95%e6%8f%90%e9%86%92%e5%92%8c%e5%ae%a2%e6%88%b7%e5%82%ac%e5%8d%95.assets/1740799215311-3ef99f46-94f5-41a7-b3b9-75fc1c91da64.png alt></p><p>如果建立了连接，后端服务器会提示</p><p><img loading=lazy src=/images/Day10%e8%ae%a2%e5%8d%95%e7%8a%b6%e6%80%81%e5%ae%9a%e6%97%b6%e5%a4%84%e7%90%86%e3%80%81%e6%9d%a5%e5%8d%95%e6%8f%90%e9%86%92%e5%92%8c%e5%ae%a2%e6%88%b7%e5%82%ac%e5%8d%95.assets/1740807029065-202dcb09-ad3f-41e2-8f66-fd5d9505171d.png alt></p><p>更改了两个配置文件</p><p><img loading=lazy src=/images/Day10%e8%ae%a2%e5%8d%95%e7%8a%b6%e6%80%81%e5%ae%9a%e6%97%b6%e5%a4%84%e7%90%86%e3%80%81%e6%9d%a5%e5%8d%95%e6%8f%90%e9%86%92%e5%92%8c%e5%ae%a2%e6%88%b7%e5%82%ac%e5%8d%95.assets/1740807079040-5b738279-9414-4450-98b2-2a13dad8920b.png alt></p><p>参考链接：<a href=https://blog.csdn.net/weixin_40433846/article/details/136520927>https://blog.csdn.net/weixin_40433846/article/details/136520927</a></p><h1 id=来单提醒功能实现>来单提醒功能实现<a hidden class=anchor aria-hidden=true href=#来单提醒功能实现>#</a></h1><p>设计：</p><ul><li>通过WebSocket实现管理端页面和服务端保持长连接状态</li><li>当客户支付后，调用WebSocket的相关API实现服务端向客户端推送消息</li><li>客户端浏览器解析服务端推送的消息，判断是来单提醒还是客户催单，进行相应的消息提示和语音播报</li><li><strong>约定服务端发送给客户端浏览器的数据格式为JSON，字段包括：type,orderld, content</strong></li></ul><ul><li><p>type 为消息类型，1为来单提醒2为客户催单</p></li><li><p>orderld 为订单id</p></li><li><p>content 为消息内容</p></li></ul><p>修改paySuccess代码</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>paySuccess</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>outTradeNo</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 根据订单号查询订单</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Orders</span><span class=w> </span><span class=n>ordersDB</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderMapper</span><span class=p>.</span><span class=na>getByNumber</span><span class=p>(</span><span class=n>outTradeNo</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 根据订单id更新订单的状态、支付方式、支付状态、结账时间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Orders</span><span class=w> </span><span class=n>orders</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Orders</span><span class=p>.</span><span class=na>builder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>id</span><span class=p>(</span><span class=n>ordersDB</span><span class=p>.</span><span class=na>getId</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>status</span><span class=p>(</span><span class=n>Orders</span><span class=p>.</span><span class=na>TO_BE_CONFIRMED</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>payStatus</span><span class=p>(</span><span class=n>Orders</span><span class=p>.</span><span class=na>PAID</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>checkoutTime</span><span class=p>(</span><span class=n>LocalDateTime</span><span class=p>.</span><span class=na>now</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orderMapper</span><span class=p>.</span><span class=na>update</span><span class=p>(</span><span class=n>orders</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 还要给客户端（这里的客户端指的是管理界面）发送待接单的信息，整个后端系  统称之为服务器</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 先构造一个JSON字符串</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Map</span><span class=w> </span><span class=n>map</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>HashMap</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;type&#34;</span><span class=p>,</span><span class=n>1</span><span class=p>);</span><span class=w> </span><span class=c1>// 通知类型，是1表示是接单提醒，2表示的是催单提醒</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;orderId&#34;</span><span class=p>,</span><span class=n>ordersDB</span><span class=p>.</span><span class=na>getId</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>map</span><span class=p>.</span><span class=na>put</span><span class=p>(</span><span class=s>&#34;content&#34;</span><span class=p>,</span><span class=s>&#34;订单号&#34;</span><span class=o>+</span><span class=n>outTradeNo</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>jsonString</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>JSON</span><span class=p>.</span><span class=na>toJSONString</span><span class=p>(</span><span class=n>map</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 因为我可能打开了很多管理端的界面，对于每个界面都建立ws连接，然后发送信息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>webSocketServer</span><span class=p>.</span><span class=na>sendToAllClient</span><span class=p>(</span><span class=n>jsonString</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>对于webSocket来说，服务器就是运行java代码的地方，客户端是后台管理端</p><p>客户催单的方法是类似的，分析一下</p><p>首先客户在小程序点击催单按钮，抵达Controller后，会继续调用service，首先判断订单是否存在，只有存在才可以催单，然后构造一个Json数据，因为之前约定了发送给客户端的信息内容要求，客户端（管理后台）收到了数据后就会解析，然后进行响应</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://wqnm1gb.github.io/tags/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96/>苍穹外卖</a></li></ul><nav class=paginav><a class=prev href=https://wqnm1gb.github.io/posts/day11%E6%95%B0%E6%8D%AE%E7%BB%9F%E8%AE%A1%E5%9B%BE%E5%BD%A2%E6%8A%A5%E8%A1%A8/><span class=title>« 上一页</span><br><span>Day11 数据统计、图形报表</span>
</a><a class=next href=https://wqnm1gb.github.io/posts/day09%E8%AE%A2%E5%8D%95%E7%9B%B8%E5%85%B3%E5%8A%9F%E8%83%BD%E5%BC%80%E5%8F%91/><span class=title>下一页 »</span><br><span>Day09 订单相关功能开发</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://wqnm1gb.github.io/>三狗子的博客</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>