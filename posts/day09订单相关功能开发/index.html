<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Day09 订单相关功能开发 | 三狗子的博客</title>
<meta name=keywords content="苍穹外卖"><meta name=description content="查询历史订单功能
  /**
     * 历史订单查询
     * @param ordersPageQueryDTO
     * @return
     */
    @Override
    public PageResult pageQuery(OrdersPageQueryDTO ordersPageQueryDTO) {
        // 开始分页
        PageHelper.startPage(ordersPageQueryDTO.getPage(),ordersPageQueryDTO.getPageSize());
        // 补全数据，先拿到用户信息
        Long userId = BaseContext.getCurrentId();
        ordersPageQueryDTO.setUserId(userId);

        // 调用Mapper查询数据
        // 先查询出订单信息
        Page<Orders> page = orderMapper.pageQuery(ordersPageQueryDTO);

        List<OrderVO> list = new ArrayList<>();
        // 封装订单详情信息，最后只需要返回OrderVO就可以了
        for (Orders orders : page) {
            // 根据订单id获取订单详细信息
            List<OrderDetail> orderDetailList = orderDetailMapper.getByOrderId(orders.getId());
            OrderVO orderVO = new OrderVO();
            // 完善一个orderVO对象
            BeanUtils.copyProperties(orders,orderVO);
            orderVO.setOrderDetailList(orderDetailList);
            list.add(orderVO);
        }
        // pageResult里边封装的是总记录数和记录集合
        return new PageResult(page.getTotal(),list);
    }
一开始没弄明白为什么返回一个OrderVO对象，里边的数据很少，结果没看到他是继承Orders的，会继承里边所有非私有的成员"><meta name=author content="冷漠三狗子丶"><link rel=canonical href=https://wqnm1gb.github.io/posts/day09%E8%AE%A2%E5%8D%95%E7%9B%B8%E5%85%B3%E5%8A%9F%E8%83%BD%E5%BC%80%E5%8F%91/><link crossorigin=anonymous href=/assets/css/stylesheet.3d688279d829dc24da48acd11f9e33ebea2f39c035e899e1bf4297d8b7aa89b9.css integrity="sha256-PWiCedgp3CTaSKzRH54z6+ovOcA16Jnhv0KX2Leqibk=" rel="preload stylesheet" as=style><link rel=icon href=https://wqnm1gb.github.io/images/favicon.png><link rel=icon type=image/png sizes=16x16 href=https://wqnm1gb.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://wqnm1gb.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://wqnm1gb.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://wqnm1gb.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://wqnm1gb.github.io/posts/day09%E8%AE%A2%E5%8D%95%E7%9B%B8%E5%85%B3%E5%8A%9F%E8%83%BD%E5%BC%80%E5%8F%91/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap" rel=stylesheet><script type=text/javascript async src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">MathJax.Hub.Config({tex2jax:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["[[","]]"]],processEscapes:!0,processEnvironments:!0,skipTags:["script","noscript","style","textarea","pre"],TeX:{equationNumbers:{autoNumber:"AMS"},extensions:["AMSmath.js","AMSsymbols.js"]}}}),MathJax.Hub.Queue(function(){var e,t=MathJax.Hub.getAllJax();for(e=0;e<t.length;e+=1)t[e].SourceElement().parentNode.className+=" has-jax"})</script><style>code.has-jax{font:inherit;font-size:100%;background:inherit;border:inherit;color:#515151}</style><meta property="og:title" content="Day09 订单相关功能开发"><meta property="og:description" content="查询历史订单功能
  /**
     * 历史订单查询
     * @param ordersPageQueryDTO
     * @return
     */
    @Override
    public PageResult pageQuery(OrdersPageQueryDTO ordersPageQueryDTO) {
        // 开始分页
        PageHelper.startPage(ordersPageQueryDTO.getPage(),ordersPageQueryDTO.getPageSize());
        // 补全数据，先拿到用户信息
        Long userId = BaseContext.getCurrentId();
        ordersPageQueryDTO.setUserId(userId);

        // 调用Mapper查询数据
        // 先查询出订单信息
        Page<Orders> page = orderMapper.pageQuery(ordersPageQueryDTO);

        List<OrderVO> list = new ArrayList<>();
        // 封装订单详情信息，最后只需要返回OrderVO就可以了
        for (Orders orders : page) {
            // 根据订单id获取订单详细信息
            List<OrderDetail> orderDetailList = orderDetailMapper.getByOrderId(orders.getId());
            OrderVO orderVO = new OrderVO();
            // 完善一个orderVO对象
            BeanUtils.copyProperties(orders,orderVO);
            orderVO.setOrderDetailList(orderDetailList);
            list.add(orderVO);
        }
        // pageResult里边封装的是总记录数和记录集合
        return new PageResult(page.getTotal(),list);
    }
一开始没弄明白为什么返回一个OrderVO对象，里边的数据很少，结果没看到他是继承Orders的，会继承里边所有非私有的成员"><meta property="og:type" content="article"><meta property="og:url" content="https://wqnm1gb.github.io/posts/day09%E8%AE%A2%E5%8D%95%E7%9B%B8%E5%85%B3%E5%8A%9F%E8%83%BD%E5%BC%80%E5%8F%91/"><meta property="og:image" content="https://wqnm1gb.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-03-20T11:08:38+08:00"><meta property="article:modified_time" content="2025-03-20T11:08:38+08:00"><meta property="og:site_name" content="三狗子的博客"><meta property="fb:admins" content="your-facebook-admin-id"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://wqnm1gb.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Day09 订单相关功能开发","item":"https://wqnm1gb.github.io/posts/day09%E8%AE%A2%E5%8D%95%E7%9B%B8%E5%85%B3%E5%8A%9F%E8%83%BD%E5%BC%80%E5%8F%91/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Day09 订单相关功能开发","name":"Day09 订单相关功能开发","description":"查询历史订单功能 /** * 历史订单查询 * @param ordersPageQueryDTO * @return */ @Override public PageResult pageQuery(OrdersPageQueryDTO ordersPageQueryDTO) { // 开始分页 PageHelper.startPage(ordersPageQueryDTO.getPage(),ordersPageQueryDTO.getPageSize()); // 补全数据，先拿到用户信息 Long userId = BaseContext.getCurrentId(); ordersPageQueryDTO.setUserId(userId); // 调用Mapper查询数据 // 先查询出订单信息 Page\u0026lt;Orders\u0026gt; page = orderMapper.pageQuery(ordersPageQueryDTO); List\u0026lt;OrderVO\u0026gt; list = new ArrayList\u0026lt;\u0026gt;(); // 封装订单详情信息，最后只需要返回OrderVO就可以了 for (Orders orders : page) { // 根据订单id获取订单详细信息 List\u0026lt;OrderDetail\u0026gt; orderDetailList = orderDetailMapper.getByOrderId(orders.getId()); OrderVO orderVO = new OrderVO(); // 完善一个orderVO对象 BeanUtils.copyProperties(orders,orderVO); orderVO.setOrderDetailList(orderDetailList); list.add(orderVO); } // pageResult里边封装的是总记录数和记录集合 return new PageResult(page.getTotal(),list); } 一开始没弄明白为什么返回一个OrderVO对象，里边的数据很少，结果没看到他是继承Orders的，会继承里边所有非私有的成员\n","keywords":["苍穹外卖"],"articleBody":"查询历史订单功能 /** * 历史订单查询 * @param ordersPageQueryDTO * @return */ @Override public PageResult pageQuery(OrdersPageQueryDTO ordersPageQueryDTO) { // 开始分页 PageHelper.startPage(ordersPageQueryDTO.getPage(),ordersPageQueryDTO.getPageSize()); // 补全数据，先拿到用户信息 Long userId = BaseContext.getCurrentId(); ordersPageQueryDTO.setUserId(userId); // 调用Mapper查询数据 // 先查询出订单信息 Page\u003cOrders\u003e page = orderMapper.pageQuery(ordersPageQueryDTO); List\u003cOrderVO\u003e list = new ArrayList\u003c\u003e(); // 封装订单详情信息，最后只需要返回OrderVO就可以了 for (Orders orders : page) { // 根据订单id获取订单详细信息 List\u003cOrderDetail\u003e orderDetailList = orderDetailMapper.getByOrderId(orders.getId()); OrderVO orderVO = new OrderVO(); // 完善一个orderVO对象 BeanUtils.copyProperties(orders,orderVO); orderVO.setOrderDetailList(orderDetailList); list.add(orderVO); } // pageResult里边封装的是总记录数和记录集合 return new PageResult(page.getTotal(),list); } 一开始没弄明白为什么返回一个OrderVO对象，里边的数据很少，结果没看到他是继承Orders的，会继承里边所有非私有的成员\n取消订单功能 这个功能需要有详细的判断，首先要看是不是有这个订单，还要把订单的状态拿到，待支付和待接单状态下，用户可直接取消订单商家已接单状态下，用户取消订单需电话沟通商家派送中状态下，用户取消订单需电话沟通商家如果在待接单状态下取消订单，需要给用户退款取消订单后需要将订单状态修改为“已取消”\n/** * 用户取消订单 * @param id * @return */ @Override public void cancelOrder(Long id) { // 取消订单就是把里边的状态改成已取消，同时添加上取消时间 // 需要判断订单的状态是否可以取消 // 待支付和待接单状态下，用户可直接取消订单 // 商家已接单状态下，用户取消订单需电话沟通商家 // 派送中状态下，用户取消订单需电话沟通商家 // 如果在待接单状态下取消订单，需要给用户退款 // 取消订单后需要将订单状态修改为“已取消” // 查询是否有这个订单 Orders orders = orderMapper.getByOrderId(id); if (orders == null){ throw new OrderBusinessException(MessageConstant.ORDER_NOT_FOUND); } if(orders.getStatus()\u003e=3){ // 已经在已接单以上的状态了，需要打电话和商家沟通 throw new OrderBusinessException(MessageConstant.ORDER_STATUS_ERROR); } // 如果是在待接单的状态，需要退款 if(orders.getStatus().equals(Orders.TO_BE_CONFIRMED)){ // 假装退款成功 orders.setPayStatus(Orders.REFUND); } orders.setCancelTime(LocalDateTime.now()); orders.setCancelReason(\"用户取消订单\"); orders.setStatus(Orders.CANCELLED); orderMapper.update(orders); } 开发完成代码 user OrderController package com.sky.controller.user; // 订单管理 import com.sky.dto.OrdersDTO; import com.sky.dto.OrdersPageQueryDTO; import com.sky.dto.OrdersPaymentDTO; import com.sky.dto.OrdersSubmitDTO; import com.sky.result.PageResult; import com.sky.result.Result; import com.sky.service.OrderService; import com.sky.vo.OrderPaymentVO; import com.sky.vo.OrderSubmitVO; import com.sky.vo.OrderVO; import io.swagger.annotations.Api; import io.swagger.annotations.ApiOperation; import lombok.extern.slf4j.Slf4j; import org.aspectj.weaver.ast.Or; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.web.bind.annotation.*; // 给他在容器里起别名，防止管理端也有订单管理导致的冲突 @RestController(\"UserOrderController\") @RequestMapping(\"/user/order\") @Api(tags = \"订单管理相关接口\") @Slf4j public class OrderController { @Autowired private OrderService orderService; /** * 提交订单功能 * @param ordersDTO * @return */ @ApiOperation(\"提交订单\") @PostMapping(\"/submit\") public Result\u003cOrderSubmitVO\u003e submit(@RequestBody OrdersSubmitDTO ordersDTO){ log.info(\"提交订单{}\",ordersDTO); OrderSubmitVO orderSubmitVO = orderService.submitOrder(ordersDTO); return Result.success(orderSubmitVO); } /** * 订单支付 * * @param ordersPaymentDTO * @return */ @PutMapping(\"/payment\") @ApiOperation(\"订单支付\") public Result\u003cOrderPaymentVO\u003e payment(@RequestBody OrdersPaymentDTO ordersPaymentDTO) throws Exception { log.info(\"订单支付：{}\", ordersPaymentDTO); OrderPaymentVO orderPaymentVO = orderService.payment(ordersPaymentDTO); // 直接模拟交易成功 log.info(\"生成预支付交易单：{}\", orderPaymentVO); orderService.paySuccess(ordersPaymentDTO.getOrderNumber()); log.info(\"模拟交易成功{}\",ordersPaymentDTO.getOrderNumber()); return Result.success(orderPaymentVO); } /** * 历史订单查询 * @param ordersPageQueryDTO * @return */ @ApiOperation(\"历史订单查询\") @GetMapping(\"/historyOrders\") public Result\u003cPageResult\u003e pageQuery(OrdersPageQueryDTO ordersPageQueryDTO){ log.info(\"历史订单查询{}\",ordersPageQueryDTO); PageResult pageResult = orderService.pageQuery(ordersPageQueryDTO); return Result.success(pageResult); } /** * 查询订单详情 * @param id * @return */ @GetMapping(\"/orderDetail/{id}\") @ApiOperation(\"查询订单详情\") public Result\u003cOrderVO\u003e getOrderDetail(@PathVariable Long id){ log.info(\"查询订单详情{}\",id); OrderVO orderVO = orderService.getOrderDetail(id); return Result.success(orderVO); } /** * 用户取消订单 * @param id * @return */ @ApiOperation(\"用户取消订单\") @PutMapping(\"/cancel/{id}\") public Result cancelOrder(@PathVariable Long id){ log.info(\"用户取消订单{}\",id); orderService.cancelOrder(id); return Result.success(); } /** * 再来一单 * @param id * @return */ @PostMapping(\"/repetition/{id}\") @ApiOperation(\"再来一单\") public Result repeat(@PathVariable Long id){ log.info(\"再来一单:{}\",id); orderService.repeat(id); return Result.success(); } } admin OrderController package com.sky.controller.admin; import com.sky.dto.OrdersCancelDTO; import com.sky.dto.OrdersConfirmDTO; import com.sky.dto.OrdersPageQueryDTO; import com.sky.dto.OrdersRejectionDTO; import com.sky.entity.OrderDetail; import com.sky.result.PageResult; import com.sky.result.Result; import com.sky.service.OrderService; import com.sky.vo.OrderStatisticsVO; import com.sky.vo.OrderVO; import io.swagger.annotations.Api; import io.swagger.annotations.ApiOperation; import lombok.extern.slf4j.Slf4j; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.web.bind.annotation.*; @RestController(\"AdminOrderController\") @RequestMapping(\"/admin/order\") @Api(tags = \"订单管理\") @Slf4j public class OrderController { @Autowired private OrderService orderService; /** * 订单搜索功能 * @param ordersPageQueryDTO * @return */ @GetMapping(\"/conditionSearch\") @ApiOperation(\"订单搜索功能\") public Result\u003cPageResult\u003e searchOrder(OrdersPageQueryDTO ordersPageQueryDTO){ log.info(\"订单搜索功能{}\",ordersPageQueryDTO); PageResult pageResult = orderService.pageQueryAll(ordersPageQueryDTO); return Result.success(pageResult); } /** * 获取各个状态的订单数 * @return */ @GetMapping(\"/statistics\") @ApiOperation(\"获取各个状态的订单数\") public Result\u003cOrderStatisticsVO\u003e getStatusCount(){ log.info(\"获取各个状态的订单数\"); OrderStatisticsVO orderStatisticsVO = orderService.getStatusCount(); return Result.success(orderStatisticsVO); } /** * 查询订单详情 * @return */ @GetMapping(\"/details/{id}\") @ApiOperation(\"查询订单详情\") public Result\u003cOrderVO\u003e getOrderDetail(@PathVariable Long id){ log.info(\"查询订单详情{}\",id); OrderVO orderDetail = orderService.getOrderDetail(id); return Result.success(orderDetail); } /** * 订单接单 * @param ordersConfirmDTO */ @PutMapping(\"/confirm\") @ApiOperation(\"订单接单\") public Result confirmOrder(@RequestBody OrdersConfirmDTO ordersConfirmDTO){ log.info(\"订单接单{}\",ordersConfirmDTO); orderService.confirmOrder(ordersConfirmDTO); return Result.success(); } /** * 订单拒单 * @param ordersRejectionDTO */ @PutMapping(\"/rejection\") @ApiOperation(\"订单接单\") public Result rejectOrder(@RequestBody OrdersRejectionDTO ordersRejectionDTO){ log.info(\"订单拒单{}\",ordersRejectionDTO); orderService.rejectOrder(ordersRejectionDTO); return Result.success(); } /** * 商家取消订单 * @param ordersCancelDTO * @return */ @PutMapping(\"/cancel\") @ApiOperation(\"取消订单\") public Result cancelOrder(@RequestBody OrdersCancelDTO ordersCancelDTO){ log.info(\"取消订单{}\",ordersCancelDTO); orderService.cancelOrderAdmin(ordersCancelDTO); return Result.success(); } /** * 派送订单 * @param id * @return */ @ApiOperation(\"派送订单\") @PutMapping(\"/delivery/{id}\") public Result deliveryOrder(@PathVariable Long id){ log.info(\"派送订单{}\",id); orderService.deliveryOrder(id); return Result.success(); } /** * 完成订单 * @param id * @return */ @PutMapping(\"/complete/{id}\") @ApiOperation(\"完成订单\") public Result completeOrder(@PathVariable Long id){ log.info(\"完成订单{}\",id); orderService.completeOrder(id); return Result.success(); } } OrderServiceImpl package com.sky.service.impl; import com.alibaba.fastjson.JSONObject; import com.github.pagehelper.Page; import com.github.pagehelper.PageHelper; import com.sky.constant.MessageConstant; import com.sky.context.BaseContext; import com.sky.dto.*; import com.sky.entity.*; import com.sky.exception.AddressBookBusinessException; import com.sky.exception.OrderBusinessException; import com.sky.exception.ShoppingCartBusinessException; import com.sky.mapper.*; import com.sky.result.PageResult; import com.sky.service.OrderService; import com.sky.utils.WeChatPayUtil; import com.sky.vo.OrderPaymentVO; import com.sky.vo.OrderStatisticsVO; import com.sky.vo.OrderSubmitVO; import com.sky.vo.OrderVO; import lombok.extern.slf4j.Slf4j; import org.aopalliance.intercept.Interceptor; import org.openxmlformats.schemas.spreadsheetml.x2006.main.SstDocument; import org.springframework.beans.BeanUtils; import org.springframework.beans.factory.BeanNameAware; import org.springframework.beans.factory.annotation.Autowired; import org.springframework.core.annotation.Order; import org.springframework.data.auditing.CurrentDateTimeProvider; import org.springframework.stereotype.Service; import org.springframework.transaction.annotation.Transactional; import org.springframework.web.bind.annotation.PostMapping; import org.springframework.web.bind.annotation.PutMapping; import java.math.BigDecimal; import java.time.LocalDateTime; import java.util.ArrayList; import java.util.List; @Service @Slf4j public class OrderServiceImpl implements OrderService { @Autowired private OrderMapper orderMapper; @Autowired private ShoppingCartMapper shoppingCartMapper; @Autowired private AddressBookMapper addressBookMapper; @Autowired private OrderDetailMapper orderDetailMapper; @Autowired private UserMapper userMapper; @Autowired private DishMapper dishMapper; /** * 提交订单 * @param ordersDTO * @return */ @Override @Transactional public OrderSubmitVO submitOrder(OrdersSubmitDTO ordersDTO) { // 1、判断是否可以插入，购物车是不是空的，地址是不是空的 // 1.1 先判断购物车是否为空 Long userId = BaseContext.getCurrentId(); ShoppingCart shoppingCart = new ShoppingCart(); shoppingCart.setUserId(userId); List\u003cShoppingCart\u003e shoppingCartList = shoppingCartMapper.getById(shoppingCart); if(shoppingCartList == null || shoppingCartList.size()==0){ // 如果购物车中为空，那么抛出业务异常 throw new ShoppingCartBusinessException(MessageConstant.SHOPPING_CART_IS_NULL); } // 1.2 判断地址是否为空 Long addressBookId = ordersDTO.getAddressBookId(); AddressBook address = addressBookMapper.getById(addressBookId); if(address == null){ throw new AddressBookBusinessException(MessageConstant.ADDRESS_BOOK_IS_NULL); } // 2、向订单表插入1条数据 // 需要把数据先完善 Orders orders = new Orders(); BeanUtils.copyProperties(ordersDTO,orders); // 设置订单号，用当前时间的时间戳 orders.setNumber(String.valueOf(System.currentTimeMillis())); orders.setStatus(Orders.PENDING_PAYMENT); orders.setOrderTime(LocalDateTime.now()); orders.setPayStatus(Orders.UN_PAID); orders.setPhone(address.getPhone()); orders.setAddress(address.getDetail()); orders.setConsignee(address.getConsignee()); orders.setUserId(userId); orderMapper.insert(orders); List\u003cOrderDetail\u003e orderDetailList = new ArrayList\u003c\u003e(); // 3、向订单详细表插入n条数据（n是购物车里边的数据数量） for (ShoppingCart sc : shoppingCartList) { OrderDetail orderDetail = new OrderDetail(); BeanUtils.copyProperties(sc,orderDetail); orderDetail.setOrderId(orders.getId()); orderDetailList.add(orderDetail); } // 一次性插入所有的数据 orderDetailMapper.insertBatch(orderDetailList); // 4、把购物车清空 shoppingCartMapper.deleteAll(userId); // 5、返回vo数据 OrderSubmitVO orderSubmitVO = OrderSubmitVO.builder() .orderAmount(orders.getAmount()) .orderNumber(orders.getNumber()) .orderTime(orders.getOrderTime()) .id(orders.getId()) .build(); return orderSubmitVO; } /** * 订单支付 * * @param ordersPaymentDTO * @return */ public OrderPaymentVO payment(OrdersPaymentDTO ordersPaymentDTO) throws Exception { // 当前登录用户id Long userId = BaseContext.getCurrentId(); User user = userMapper.getById(userId); // //调用微信支付接口，生成预支付交易单 // 对应图中的第5步，调用微信下单接口 // JSONObject jsonObject = weChatPayUtil.pay( // ordersPaymentDTO.getOrderNumber(), //商户订单号 // new BigDecimal(0.01), //支付金额，单位 元 // \"苍穹外卖订单\", //商品描述 // user.getOpenid() //微信用户的openid // ); JSONObject jsonObject = new JSONObject(); if (jsonObject.getString(\"code\") != null \u0026\u0026 jsonObject.getString(\"code\").equals(\"ORDERPAID\")) { throw new OrderBusinessException(\"该订单已支付\"); } OrderPaymentVO vo = jsonObject.toJavaObject(OrderPaymentVO.class); vo.setPackageStr(jsonObject.getString(\"package\")); return vo; } /** * 支付成功，修改订单状态 * * @param outTradeNo */ public void paySuccess(String outTradeNo) { // 根据订单号查询订单 Orders ordersDB = orderMapper.getByNumber(outTradeNo); // 根据订单id更新订单的状态、支付方式、支付状态、结账时间 Orders orders = Orders.builder() .id(ordersDB.getId()) .status(Orders.TO_BE_CONFIRMED) .payStatus(Orders.PAID) .checkoutTime(LocalDateTime.now()) .build(); orderMapper.update(orders); } /** * 历史订单查询 * @param ordersPageQueryDTO * @return */ @Override public PageResult pageQuery(OrdersPageQueryDTO ordersPageQueryDTO) { // 开始分页 PageHelper.startPage(ordersPageQueryDTO.getPage(),ordersPageQueryDTO.getPageSize()); // 补全数据，先拿到用户信息 Long userId = BaseContext.getCurrentId(); ordersPageQueryDTO.setUserId(userId); // 调用Mapper查询数据 // 先查询出订单信息 Page\u003cOrders\u003e page = orderMapper.pageQuery(ordersPageQueryDTO); List\u003cOrderVO\u003e list = new ArrayList\u003c\u003e(); // 封装订单详情信息，最后只需要返回OrderVO就可以了 for (Orders orders : page) { // 根据订单id获取订单详细信息 List\u003cOrderDetail\u003e orderDetailList = orderDetailMapper.getByOrderId(orders.getId()); OrderVO orderVO = new OrderVO(); // 完善一个orderVO对象 BeanUtils.copyProperties(orders,orderVO); orderVO.setOrderDetailList(orderDetailList); // 还需要完善一下vo对象里边的orderDishes字段 orderVO.setOrderDishes(getDishDetail(orderDetailList)); list.add(orderVO); } // pageResult里边封装的是总记录数和记录集合 return new PageResult(page.getTotal(),list); } /** * 查询全部订单 * @param ordersPageQueryDTO * @return */ public PageResult pageQueryAll(OrdersPageQueryDTO ordersPageQueryDTO){ // 开始分页 PageHelper.startPage(ordersPageQueryDTO.getPage(),ordersPageQueryDTO.getPageSize()); // 调用Mapper查询数据 // 先查询出订单信息 Page\u003cOrders\u003e page = orderMapper.pageQuery(ordersPageQueryDTO); List\u003cOrderVO\u003e list = new ArrayList\u003c\u003e(); // 封装订单详情信息，最后只需要返回OrderVO就可以了 for (Orders orders : page) { // 根据订单id获取订单详细信息 List\u003cOrderDetail\u003e orderDetailList = orderDetailMapper.getByOrderId(orders.getId()); OrderVO orderVO = new OrderVO(); // 完善一个orderVO对象 BeanUtils.copyProperties(orders,orderVO); orderVO.setOrderDetailList(orderDetailList); // 还需要完善一下vo对象里边的orderDishes字段 orderVO.setOrderDishes(getDishDetail(orderDetailList)); list.add(orderVO); } // pageResult里边封装的是总记录数和记录集合 return new PageResult(page.getTotal(),list); } /** * 获取各个状态的订单数 * @return */ @Override public OrderStatisticsVO getStatusCount() { // 获取待派送的数量 Integer confirmed = orderMapper.getStatusCount(Orders.CONFIRMED); // 获取派送中的数量 Integer deliverInProgress = orderMapper.getStatusCount(Orders.DELIVERY_IN_PROGRESS); // 获取待接单的数量 Integer toBeConfirmed = orderMapper.getStatusCount(Orders.TO_BE_CONFIRMED); OrderStatisticsVO orderStatisticsVO = new OrderStatisticsVO(); orderStatisticsVO.setConfirmed(confirmed); orderStatisticsVO.setToBeConfirmed(toBeConfirmed); orderStatisticsVO.setDeliveryInProgress(deliverInProgress); return orderStatisticsVO; } /** * 订单接单 * @param ordersConfirmDTO */ @Override public void confirmOrder(OrdersConfirmDTO ordersConfirmDTO) { // 先判断是否有这个订单 Orders orders1 = orderMapper.getByOrderId(ordersConfirmDTO.getId()); if(orders1==null){ throw new OrderBusinessException(MessageConstant.ORDER_NOT_FOUND); } orders1.setStatus(Orders.CONFIRMED); orders1.setId(ordersConfirmDTO.getId()); orderMapper.update(orders1); } /** * 订单拒单 * @param ordersRejectionDTO */ @Override public void rejectOrder(OrdersRejectionDTO ordersRejectionDTO) { // 判断是否有这个订单 Orders orders = orderMapper.getByOrderId(ordersRejectionDTO.getId()); // 判断是否是待接单状态，待接单状态才可以拒单 if (orders == null \u0026\u0026 orders.getStatus()!=Orders.TO_BE_CONFIRMED ){ throw new OrderBusinessException(MessageConstant.ORDER_STATUS_ERROR); } // 改成取消状态 orders.setStatus(Orders.CANCELLED); // 假装退款成功 orders.setPayStatus(Orders.REFUND); orders.setCancelReason(\"商家拒单\"); orders.setCancelTime(LocalDateTime.now()); orders.setRejectionReason(ordersRejectionDTO.getRejectionReason()); orderMapper.update(orders); } /** * 商家取消订单 * @param ordersCancelDTO * @return */ @Override public void cancelOrderAdmin(OrdersCancelDTO ordersCancelDTO) { // 判断是否有这个订单 Orders orders = orderMapper.getByOrderId(ordersCancelDTO.getId()); if(orders == null){ // 如果没有这个订单，那么就抛出异常 throw new OrderBusinessException(MessageConstant.ORDER_NOT_FOUND); } // 判断订单状态是不是待付款、待派送、派送中、已完成状态可以进行取消操作，进行取消操作需要选择取消原因。 if(orders.getStatus()==Orders.TO_BE_CONFIRMED){ // 待接单状态不能取消，只能拒接 throw new OrderBusinessException(MessageConstant.ORDER_STATUS_ERROR); } // 改成取消状态 orders.setStatus(Orders.CANCELLED); // 假装退款成功 orders.setPayStatus(Orders.REFUND); orders.setCancelReason(ordersCancelDTO.getCancelReason()); orders.setCancelTime(LocalDateTime.now()); orderMapper.update(orders); } /** * 派送订单 * @param id * @return */ @Override public void deliveryOrder(Long id) { // 先查询是否有这个订单，并且订单是待派送状态 Orders orders = orderMapper.getByOrderId(id); if(orders == null \u0026\u0026 orders.getStatus()!=Orders.CONFIRMED){ throw new OrderBusinessException(MessageConstant.ORDER_NOT_FOUND); } // 有这个订单，只需要把状态改成派送中即可 orders.setStatus(Orders.DELIVERY_IN_PROGRESS); orderMapper.update(orders); } /** * 完成订单 * @param id * @return */ @Override public void completeOrder(Long id) { // 首先判断订单是否存在，并且处于派送中状态 Orders orders = orderMapper.getByOrderId(id); if(orders == null \u0026\u0026 orders.getStatus()!=4){ throw new OrderBusinessException(MessageConstant.ORDER_STATUS_ERROR); } // 重新设置一个，这样插入的时间就会变短 Orders orders1 = new Orders(); // 更改订单状态 orders1.setStatus(Orders.COMPLETED); orders1.setId(orders.getId()); // 设置完成时间 orders1.setDeliveryTime(LocalDateTime.now()); orderMapper.update(orders1); } public String getDishDetail(List\u003cOrderDetail\u003e orderDetailList){ StringBuilder msg =new StringBuilder(); for (OrderDetail orderDetail : orderDetailList) { // 查询出套餐名字或者菜品名字，订单细节里边有包含名字，不需要查询了 msg.append(orderDetail.getName()).append(\"*\").append(orderDetail.getNumber()).append(\";\"); } return msg.toString(); } /** * 查询订单详情 * @param orderId * @return */ @Override public OrderVO getOrderDetail(Long orderId) { // 想要返回OrderVO，先创建一个 OrderVO orderVO = new OrderVO(); Orders order = orderMapper.getByOrderId(orderId); // 根据订单号来查询订单细节 List\u003cOrderDetail\u003e orderDetailList = orderDetailMapper.getByOrderId(orderId); // 构建vo对象 BeanUtils.copyProperties(order,orderVO); orderVO.setOrderDishes(getDishDetail(orderDetailList)); orderVO.setOrderDetailList(orderDetailList); return orderVO; } /** * 用户取消订单 * @param id * @return */ @Override public void cancelOrder(Long id) { // 取消订单就是把里边的状态改成已取消，同时添加上取消时间 // 需要判断订单的状态是否可以取消 // 待支付和待接单状态下，用户可直接取消订单 // 商家已接单状态下，用户取消订单需电话沟通商家 // 派送中状态下，用户取消订单需电话沟通商家 // 如果在待接单状态下取消订单，需要给用户退款 // 取消订单后需要将订单状态修改为“已取消” // 查询是否有这个订单 Orders orders = orderMapper.getByOrderId(id); if (orders == null){ throw new OrderBusinessException(MessageConstant.ORDER_NOT_FOUND); } if(orders.getStatus()\u003e=3){ // 已经在已接单以上的状态了，需要打电话和商家沟通 throw new OrderBusinessException(MessageConstant.ORDER_STATUS_ERROR); } // 如果是在待接单的状态，需要退款 if(orders.getStatus().equals(Orders.TO_BE_CONFIRMED)){ // 假装退款成功 orders.setPayStatus(Orders.REFUND); } orders.setCancelTime(LocalDateTime.now()); orders.setCancelReason(\"用户取消订单\"); orders.setStatus(Orders.CANCELLED); orderMapper.update(orders); } /** * 再来一单 * @param id * @return */ @Override public void repeat(Long id) { // 目前的思路是，先根据订单号查询到订单的菜品信息，然后把购物车清空，重新添加上菜品 Orders orders = orderMapper.getByOrderId(id); // 先判断一下，有没有这个订单 if(orders == null){ throw new OrderBusinessException(MessageConstant.ORDER_NOT_FOUND); } // 根据订单查询详细的菜品信息 List\u003cOrderDetail\u003e byOrderId = orderDetailMapper.getByOrderId(id); // 先清除购物车 shoppingCartMapper.deleteAll(BaseContext.getCurrentId()); // 把list集合里边的每一条数据都封装成一个购物车对象 for (OrderDetail orderDetail : byOrderId) { ShoppingCart shoppingCart = new ShoppingCart(); BeanUtils.copyProperties(orderDetail,shoppingCart); shoppingCart.setCreateTime(LocalDateTime.now()); // 还需要设置用户id shoppingCart.setUserId(BaseContext.getCurrentId()); shoppingCartMapper.insert(shoppingCart); } } } 注意每次拿到的时候的逻辑的判断很重要，如果直接发送请求，不经过前端验证，需要防范不合理的请求\n","wordCount":"4482","inLanguage":"zh","image":"https://wqnm1gb.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2025-03-20T11:08:38+08:00","dateModified":"2025-03-20T11:08:38+08:00","author":{"@type":"Person","name":"冷漠三狗子丶"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://wqnm1gb.github.io/posts/day09%E8%AE%A2%E5%8D%95%E7%9B%B8%E5%85%B3%E5%8A%9F%E8%83%BD%E5%BC%80%E5%8F%91/"},"publisher":{"@type":"Organization","name":"三狗子的博客","logo":{"@type":"ImageObject","url":"https://wqnm1gb.github.io/images/favicon.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wqnm1gb.github.io/ accesskey=h title="主页 (Alt + H)"><img src=https://wqnm1gb.github.io/apple-touch-icon.png alt aria-label=logo height=35>主页</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://wqnm1gb.github.io/ title=三狗子的博客><span>首页</span></a></li><li><a href=https://wqnm1gb.github.io/archives/ title=归档><span>归档</span></a></li><li><a href=https://wqnm1gb.github.io/categories/ title=Categories><span>分类</span></a></li><li><a href=https://wqnm1gb.github.io/tags/ title=Tags><span>标签</span></a></li><li><a href=https://wqnm1gb.github.io/search/ title=搜索><span>搜索</span></a></li><li><a href=https://wqnm1gb.github.io/about/ title=关于><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://wqnm1gb.github.io/>主页</a>&nbsp;»&nbsp;<a href=https://wqnm1gb.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Day09 订单相关功能开发</h1><div class=post-meta><span title='2025-03-20 11:08:38 +0800 +0800'>三月 20, 2025</span>&nbsp;·&nbsp;9 分钟&nbsp;·&nbsp;4482 字&nbsp;·&nbsp;冷漠三狗子丶</div></header><div class=post-content><h1 id=查询历史订单功能>查询历史订单功能<a hidden class=anchor aria-hidden=true href=#查询历史订单功能>#</a></h1><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>  </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 历史订单查询
</span></span></span><span class=line><span class=cl><span class=cm>     * @param ordersPageQueryDTO
</span></span></span><span class=line><span class=cl><span class=cm>     * @return
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>PageResult</span><span class=w> </span><span class=nf>pageQuery</span><span class=p>(</span><span class=n>OrdersPageQueryDTO</span><span class=w> </span><span class=n>ordersPageQueryDTO</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 开始分页</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>PageHelper</span><span class=p>.</span><span class=na>startPage</span><span class=p>(</span><span class=n>ordersPageQueryDTO</span><span class=p>.</span><span class=na>getPage</span><span class=p>(),</span><span class=n>ordersPageQueryDTO</span><span class=p>.</span><span class=na>getPageSize</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 补全数据，先拿到用户信息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>BaseContext</span><span class=p>.</span><span class=na>getCurrentId</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ordersPageQueryDTO</span><span class=p>.</span><span class=na>setUserId</span><span class=p>(</span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 调用Mapper查询数据</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 先查询出订单信息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Page</span><span class=o>&lt;</span><span class=n>Orders</span><span class=o>&gt;</span><span class=w> </span><span class=n>page</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderMapper</span><span class=p>.</span><span class=na>pageQuery</span><span class=p>(</span><span class=n>ordersPageQueryDTO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=o>&lt;</span><span class=n>OrderVO</span><span class=o>&gt;</span><span class=w> </span><span class=n>list</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 封装订单详情信息，最后只需要返回OrderVO就可以了</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Orders</span><span class=w> </span><span class=n>orders</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>page</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 根据订单id获取订单详细信息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>List</span><span class=o>&lt;</span><span class=n>OrderDetail</span><span class=o>&gt;</span><span class=w> </span><span class=n>orderDetailList</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderDetailMapper</span><span class=p>.</span><span class=na>getByOrderId</span><span class=p>(</span><span class=n>orders</span><span class=p>.</span><span class=na>getId</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>OrderVO</span><span class=w> </span><span class=n>orderVO</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>OrderVO</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 完善一个orderVO对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>BeanUtils</span><span class=p>.</span><span class=na>copyProperties</span><span class=p>(</span><span class=n>orders</span><span class=p>,</span><span class=n>orderVO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>orderVO</span><span class=p>.</span><span class=na>setOrderDetailList</span><span class=p>(</span><span class=n>orderDetailList</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>list</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>orderVO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// pageResult里边封装的是总记录数和记录集合</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>PageResult</span><span class=p>(</span><span class=n>page</span><span class=p>.</span><span class=na>getTotal</span><span class=p>(),</span><span class=n>list</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>一开始没弄明白为什么返回一个OrderVO对象，里边的数据很少，结果没看到他是继承Orders的，会继承里边所有非私有的成员</p><h1 id=取消订单功能>取消订单功能<a hidden class=anchor aria-hidden=true href=#取消订单功能>#</a></h1><p>这个功能需要有详细的判断，首先要看是不是有这个订单，还要把订单的状态拿到，待支付和待接单状态下，用户可直接取消订单商家已接单状态下，用户取消订单需电话沟通商家派送中状态下，用户取消订单需电话沟通商家如果在待接单状态下取消订单，需要给用户退款取消订单后需要将订单状态修改为“已取消”</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w> </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 用户取消订单
</span></span></span><span class=line><span class=cl><span class=cm>     * @param id
</span></span></span><span class=line><span class=cl><span class=cm>     * @return
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>cancelOrder</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 取消订单就是把里边的状态改成已取消，同时添加上取消时间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 需要判断订单的状态是否可以取消</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//       待支付和待接单状态下，用户可直接取消订单</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//       商家已接单状态下，用户取消订单需电话沟通商家</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//       派送中状态下，用户取消订单需电话沟通商家</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//       如果在待接单状态下取消订单，需要给用户退款</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//       取消订单后需要将订单状态修改为“已取消”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 查询是否有这个订单</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Orders</span><span class=w> </span><span class=n>orders</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderMapper</span><span class=p>.</span><span class=na>getByOrderId</span><span class=p>(</span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>orders</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>OrderBusinessException</span><span class=p>(</span><span class=n>MessageConstant</span><span class=p>.</span><span class=na>ORDER_NOT_FOUND</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>orders</span><span class=p>.</span><span class=na>getStatus</span><span class=p>()</span><span class=o>&gt;=</span><span class=n>3</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 已经在已接单以上的状态了，需要打电话和商家沟通</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>OrderBusinessException</span><span class=p>(</span><span class=n>MessageConstant</span><span class=p>.</span><span class=na>ORDER_STATUS_ERROR</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 如果是在待接单的状态，需要退款</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>orders</span><span class=p>.</span><span class=na>getStatus</span><span class=p>().</span><span class=na>equals</span><span class=p>(</span><span class=n>Orders</span><span class=p>.</span><span class=na>TO_BE_CONFIRMED</span><span class=p>)){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 假装退款成功</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>orders</span><span class=p>.</span><span class=na>setPayStatus</span><span class=p>(</span><span class=n>Orders</span><span class=p>.</span><span class=na>REFUND</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orders</span><span class=p>.</span><span class=na>setCancelTime</span><span class=p>(</span><span class=n>LocalDateTime</span><span class=p>.</span><span class=na>now</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orders</span><span class=p>.</span><span class=na>setCancelReason</span><span class=p>(</span><span class=s>&#34;用户取消订单&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orders</span><span class=p>.</span><span class=na>setStatus</span><span class=p>(</span><span class=n>Orders</span><span class=p>.</span><span class=na>CANCELLED</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orderMapper</span><span class=p>.</span><span class=na>update</span><span class=p>(</span><span class=n>orders</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h1 id=开发完成代码>开发完成代码<a hidden class=anchor aria-hidden=true href=#开发完成代码>#</a></h1><h2 id=user>user<a hidden class=anchor aria-hidden=true href=#user>#</a></h2><h3 id=ordercontroller>OrderController<a hidden class=anchor aria-hidden=true href=#ordercontroller>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>com.sky.controller.user</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 订单管理</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sky.dto.OrdersDTO</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sky.dto.OrdersPageQueryDTO</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sky.dto.OrdersPaymentDTO</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sky.dto.OrdersSubmitDTO</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sky.result.PageResult</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sky.result.Result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sky.service.OrderService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sky.vo.OrderPaymentVO</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sky.vo.OrderSubmitVO</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sky.vo.OrderVO</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>io.swagger.annotations.Api</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>io.swagger.annotations.ApiOperation</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>lombok.extern.slf4j.Slf4j</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.aspectj.weaver.ast.Or</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.beans.factory.annotation.Autowired</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.web.bind.annotation.*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>// 给他在容器里起别名，防止管理端也有订单管理导致的冲突</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@RestController</span><span class=p>(</span><span class=s>&#34;UserOrderController&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@RequestMapping</span><span class=p>(</span><span class=s>&#34;/user/order&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Api</span><span class=p>(</span><span class=n>tags</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;订单管理相关接口&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>OrderController</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>OrderService</span><span class=w> </span><span class=n>orderService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 提交订单功能
</span></span></span><span class=line><span class=cl><span class=cm>     * @param ordersDTO
</span></span></span><span class=line><span class=cl><span class=cm>     * @return
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ApiOperation</span><span class=p>(</span><span class=s>&#34;提交订单&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@PostMapping</span><span class=p>(</span><span class=s>&#34;/submit&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Result</span><span class=o>&lt;</span><span class=n>OrderSubmitVO</span><span class=o>&gt;</span><span class=w> </span><span class=nf>submit</span><span class=p>(</span><span class=nd>@RequestBody</span><span class=w> </span><span class=n>OrdersSubmitDTO</span><span class=w> </span><span class=n>ordersDTO</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;提交订单{}&#34;</span><span class=p>,</span><span class=n>ordersDTO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>OrderSubmitVO</span><span class=w> </span><span class=n>orderSubmitVO</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderService</span><span class=p>.</span><span class=na>submitOrder</span><span class=p>(</span><span class=n>ordersDTO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Result</span><span class=p>.</span><span class=na>success</span><span class=p>(</span><span class=n>orderSubmitVO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 订单支付
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param ordersPaymentDTO
</span></span></span><span class=line><span class=cl><span class=cm>     * @return
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@PutMapping</span><span class=p>(</span><span class=s>&#34;/payment&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ApiOperation</span><span class=p>(</span><span class=s>&#34;订单支付&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Result</span><span class=o>&lt;</span><span class=n>OrderPaymentVO</span><span class=o>&gt;</span><span class=w> </span><span class=nf>payment</span><span class=p>(</span><span class=nd>@RequestBody</span><span class=w> </span><span class=n>OrdersPaymentDTO</span><span class=w> </span><span class=n>ordersPaymentDTO</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;订单支付：{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ordersPaymentDTO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>OrderPaymentVO</span><span class=w> </span><span class=n>orderPaymentVO</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderService</span><span class=p>.</span><span class=na>payment</span><span class=p>(</span><span class=n>ordersPaymentDTO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 直接模拟交易成功</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;生成预支付交易单：{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>orderPaymentVO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orderService</span><span class=p>.</span><span class=na>paySuccess</span><span class=p>(</span><span class=n>ordersPaymentDTO</span><span class=p>.</span><span class=na>getOrderNumber</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;模拟交易成功{}&#34;</span><span class=p>,</span><span class=n>ordersPaymentDTO</span><span class=p>.</span><span class=na>getOrderNumber</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Result</span><span class=p>.</span><span class=na>success</span><span class=p>(</span><span class=n>orderPaymentVO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 历史订单查询
</span></span></span><span class=line><span class=cl><span class=cm>     * @param ordersPageQueryDTO
</span></span></span><span class=line><span class=cl><span class=cm>     * @return
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ApiOperation</span><span class=p>(</span><span class=s>&#34;历史订单查询&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/historyOrders&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Result</span><span class=o>&lt;</span><span class=n>PageResult</span><span class=o>&gt;</span><span class=w> </span><span class=nf>pageQuery</span><span class=p>(</span><span class=n>OrdersPageQueryDTO</span><span class=w> </span><span class=n>ordersPageQueryDTO</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;历史订单查询{}&#34;</span><span class=p>,</span><span class=n>ordersPageQueryDTO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>PageResult</span><span class=w> </span><span class=n>pageResult</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderService</span><span class=p>.</span><span class=na>pageQuery</span><span class=p>(</span><span class=n>ordersPageQueryDTO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Result</span><span class=p>.</span><span class=na>success</span><span class=p>(</span><span class=n>pageResult</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 查询订单详情
</span></span></span><span class=line><span class=cl><span class=cm>     * @param id
</span></span></span><span class=line><span class=cl><span class=cm>     * @return
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/orderDetail/{id}&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ApiOperation</span><span class=p>(</span><span class=s>&#34;查询订单详情&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Result</span><span class=o>&lt;</span><span class=n>OrderVO</span><span class=o>&gt;</span><span class=w> </span><span class=nf>getOrderDetail</span><span class=p>(</span><span class=nd>@PathVariable</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>id</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;查询订单详情{}&#34;</span><span class=p>,</span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>OrderVO</span><span class=w> </span><span class=n>orderVO</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderService</span><span class=p>.</span><span class=na>getOrderDetail</span><span class=p>(</span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Result</span><span class=p>.</span><span class=na>success</span><span class=p>(</span><span class=n>orderVO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 用户取消订单
</span></span></span><span class=line><span class=cl><span class=cm>     * @param id
</span></span></span><span class=line><span class=cl><span class=cm>     * @return
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ApiOperation</span><span class=p>(</span><span class=s>&#34;用户取消订单&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@PutMapping</span><span class=p>(</span><span class=s>&#34;/cancel/{id}&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Result</span><span class=w> </span><span class=nf>cancelOrder</span><span class=p>(</span><span class=nd>@PathVariable</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>id</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;用户取消订单{}&#34;</span><span class=p>,</span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orderService</span><span class=p>.</span><span class=na>cancelOrder</span><span class=p>(</span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Result</span><span class=p>.</span><span class=na>success</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 再来一单
</span></span></span><span class=line><span class=cl><span class=cm>     * @param id
</span></span></span><span class=line><span class=cl><span class=cm>     * @return
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@PostMapping</span><span class=p>(</span><span class=s>&#34;/repetition/{id}&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ApiOperation</span><span class=p>(</span><span class=s>&#34;再来一单&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Result</span><span class=w> </span><span class=nf>repeat</span><span class=p>(</span><span class=nd>@PathVariable</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>id</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;再来一单:{}&#34;</span><span class=p>,</span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orderService</span><span class=p>.</span><span class=na>repeat</span><span class=p>(</span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Result</span><span class=p>.</span><span class=na>success</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=admin>admin<a hidden class=anchor aria-hidden=true href=#admin>#</a></h2><h3 id=ordercontroller-1>OrderController<a hidden class=anchor aria-hidden=true href=#ordercontroller-1>#</a></h3><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>com.sky.controller.admin</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sky.dto.OrdersCancelDTO</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sky.dto.OrdersConfirmDTO</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sky.dto.OrdersPageQueryDTO</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sky.dto.OrdersRejectionDTO</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sky.entity.OrderDetail</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sky.result.PageResult</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sky.result.Result</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sky.service.OrderService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sky.vo.OrderStatisticsVO</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sky.vo.OrderVO</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>io.swagger.annotations.Api</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>io.swagger.annotations.ApiOperation</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>lombok.extern.slf4j.Slf4j</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.beans.factory.annotation.Autowired</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.web.bind.annotation.*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@RestController</span><span class=p>(</span><span class=s>&#34;AdminOrderController&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@RequestMapping</span><span class=p>(</span><span class=s>&#34;/admin/order&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Api</span><span class=p>(</span><span class=n>tags</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;订单管理&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>OrderController</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>OrderService</span><span class=w> </span><span class=n>orderService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 订单搜索功能
</span></span></span><span class=line><span class=cl><span class=cm>     * @param ordersPageQueryDTO
</span></span></span><span class=line><span class=cl><span class=cm>     * @return
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/conditionSearch&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ApiOperation</span><span class=p>(</span><span class=s>&#34;订单搜索功能&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Result</span><span class=o>&lt;</span><span class=n>PageResult</span><span class=o>&gt;</span><span class=w> </span><span class=nf>searchOrder</span><span class=p>(</span><span class=n>OrdersPageQueryDTO</span><span class=w> </span><span class=n>ordersPageQueryDTO</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;订单搜索功能{}&#34;</span><span class=p>,</span><span class=n>ordersPageQueryDTO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>PageResult</span><span class=w> </span><span class=n>pageResult</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderService</span><span class=p>.</span><span class=na>pageQueryAll</span><span class=p>(</span><span class=n>ordersPageQueryDTO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Result</span><span class=p>.</span><span class=na>success</span><span class=p>(</span><span class=n>pageResult</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 获取各个状态的订单数
</span></span></span><span class=line><span class=cl><span class=cm>     * @return
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/statistics&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ApiOperation</span><span class=p>(</span><span class=s>&#34;获取各个状态的订单数&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Result</span><span class=o>&lt;</span><span class=n>OrderStatisticsVO</span><span class=o>&gt;</span><span class=w> </span><span class=nf>getStatusCount</span><span class=p>(){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;获取各个状态的订单数&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>OrderStatisticsVO</span><span class=w> </span><span class=n>orderStatisticsVO</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderService</span><span class=p>.</span><span class=na>getStatusCount</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Result</span><span class=p>.</span><span class=na>success</span><span class=p>(</span><span class=n>orderStatisticsVO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 查询订单详情
</span></span></span><span class=line><span class=cl><span class=cm>     * @return
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@GetMapping</span><span class=p>(</span><span class=s>&#34;/details/{id}&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ApiOperation</span><span class=p>(</span><span class=s>&#34;查询订单详情&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Result</span><span class=o>&lt;</span><span class=n>OrderVO</span><span class=o>&gt;</span><span class=w> </span><span class=nf>getOrderDetail</span><span class=p>(</span><span class=nd>@PathVariable</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>id</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;查询订单详情{}&#34;</span><span class=p>,</span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>OrderVO</span><span class=w> </span><span class=n>orderDetail</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderService</span><span class=p>.</span><span class=na>getOrderDetail</span><span class=p>(</span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Result</span><span class=p>.</span><span class=na>success</span><span class=p>(</span><span class=n>orderDetail</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 订单接单
</span></span></span><span class=line><span class=cl><span class=cm>     * @param ordersConfirmDTO
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@PutMapping</span><span class=p>(</span><span class=s>&#34;/confirm&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ApiOperation</span><span class=p>(</span><span class=s>&#34;订单接单&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Result</span><span class=w> </span><span class=nf>confirmOrder</span><span class=p>(</span><span class=nd>@RequestBody</span><span class=w> </span><span class=n>OrdersConfirmDTO</span><span class=w> </span><span class=n>ordersConfirmDTO</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;订单接单{}&#34;</span><span class=p>,</span><span class=n>ordersConfirmDTO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orderService</span><span class=p>.</span><span class=na>confirmOrder</span><span class=p>(</span><span class=n>ordersConfirmDTO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Result</span><span class=p>.</span><span class=na>success</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 订单拒单
</span></span></span><span class=line><span class=cl><span class=cm>     * @param ordersRejectionDTO
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@PutMapping</span><span class=p>(</span><span class=s>&#34;/rejection&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ApiOperation</span><span class=p>(</span><span class=s>&#34;订单接单&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Result</span><span class=w> </span><span class=nf>rejectOrder</span><span class=p>(</span><span class=nd>@RequestBody</span><span class=w> </span><span class=n>OrdersRejectionDTO</span><span class=w> </span><span class=n>ordersRejectionDTO</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;订单拒单{}&#34;</span><span class=p>,</span><span class=n>ordersRejectionDTO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orderService</span><span class=p>.</span><span class=na>rejectOrder</span><span class=p>(</span><span class=n>ordersRejectionDTO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Result</span><span class=p>.</span><span class=na>success</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 商家取消订单
</span></span></span><span class=line><span class=cl><span class=cm>     * @param ordersCancelDTO
</span></span></span><span class=line><span class=cl><span class=cm>     * @return
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@PutMapping</span><span class=p>(</span><span class=s>&#34;/cancel&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ApiOperation</span><span class=p>(</span><span class=s>&#34;取消订单&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Result</span><span class=w> </span><span class=nf>cancelOrder</span><span class=p>(</span><span class=nd>@RequestBody</span><span class=w> </span><span class=n>OrdersCancelDTO</span><span class=w> </span><span class=n>ordersCancelDTO</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;取消订单{}&#34;</span><span class=p>,</span><span class=n>ordersCancelDTO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orderService</span><span class=p>.</span><span class=na>cancelOrderAdmin</span><span class=p>(</span><span class=n>ordersCancelDTO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Result</span><span class=p>.</span><span class=na>success</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 派送订单
</span></span></span><span class=line><span class=cl><span class=cm>     * @param id
</span></span></span><span class=line><span class=cl><span class=cm>     * @return
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ApiOperation</span><span class=p>(</span><span class=s>&#34;派送订单&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@PutMapping</span><span class=p>(</span><span class=s>&#34;/delivery/{id}&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Result</span><span class=w> </span><span class=nf>deliveryOrder</span><span class=p>(</span><span class=nd>@PathVariable</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>id</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;派送订单{}&#34;</span><span class=p>,</span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orderService</span><span class=p>.</span><span class=na>deliveryOrder</span><span class=p>(</span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Result</span><span class=p>.</span><span class=na>success</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 完成订单
</span></span></span><span class=line><span class=cl><span class=cm>     * @param id
</span></span></span><span class=line><span class=cl><span class=cm>     * @return
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@PutMapping</span><span class=p>(</span><span class=s>&#34;/complete/{id}&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ApiOperation</span><span class=p>(</span><span class=s>&#34;完成订单&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Result</span><span class=w> </span><span class=nf>completeOrder</span><span class=p>(</span><span class=nd>@PathVariable</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>id</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;完成订单{}&#34;</span><span class=p>,</span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orderService</span><span class=p>.</span><span class=na>completeOrder</span><span class=p>(</span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Result</span><span class=p>.</span><span class=na>success</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=orderserviceimpl>OrderServiceImpl<a hidden class=anchor aria-hidden=true href=#orderserviceimpl>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=kn>package</span><span class=w> </span><span class=nn>com.sky.service.impl</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.alibaba.fastjson.JSONObject</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.github.pagehelper.Page</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.github.pagehelper.PageHelper</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sky.constant.MessageConstant</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sky.context.BaseContext</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sky.dto.*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sky.entity.*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sky.exception.AddressBookBusinessException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sky.exception.OrderBusinessException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sky.exception.ShoppingCartBusinessException</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sky.mapper.*</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sky.result.PageResult</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sky.service.OrderService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sky.utils.WeChatPayUtil</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sky.vo.OrderPaymentVO</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sky.vo.OrderStatisticsVO</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sky.vo.OrderSubmitVO</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>com.sky.vo.OrderVO</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>lombok.extern.slf4j.Slf4j</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.aopalliance.intercept.Interceptor</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.openxmlformats.schemas.spreadsheetml.x2006.main.SstDocument</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.beans.BeanUtils</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.beans.factory.BeanNameAware</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.beans.factory.annotation.Autowired</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.core.annotation.Order</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.data.auditing.CurrentDateTimeProvider</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.stereotype.Service</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.transaction.annotation.Transactional</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.web.bind.annotation.PostMapping</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>org.springframework.web.bind.annotation.PutMapping</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.math.BigDecimal</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.time.LocalDateTime</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.ArrayList</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kn>import</span><span class=w> </span><span class=nn>java.util.List</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Service</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>OrderServiceImpl</span><span class=w> </span><span class=kd>implements</span><span class=w> </span><span class=n>OrderService</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>OrderMapper</span><span class=w> </span><span class=n>orderMapper</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>ShoppingCartMapper</span><span class=w> </span><span class=n>shoppingCartMapper</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>AddressBookMapper</span><span class=w> </span><span class=n>addressBookMapper</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>OrderDetailMapper</span><span class=w> </span><span class=n>orderDetailMapper</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>UserMapper</span><span class=w> </span><span class=n>userMapper</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>DishMapper</span><span class=w> </span><span class=n>dishMapper</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 提交订单
</span></span></span><span class=line><span class=cl><span class=cm>     * @param ordersDTO
</span></span></span><span class=line><span class=cl><span class=cm>     * @return
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Transactional</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>OrderSubmitVO</span><span class=w> </span><span class=nf>submitOrder</span><span class=p>(</span><span class=n>OrdersSubmitDTO</span><span class=w> </span><span class=n>ordersDTO</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 1、判断是否可以插入，购物车是不是空的，地址是不是空的</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 1.1 先判断购物车是否为空</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>BaseContext</span><span class=p>.</span><span class=na>getCurrentId</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ShoppingCart</span><span class=w> </span><span class=n>shoppingCart</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ShoppingCart</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>shoppingCart</span><span class=p>.</span><span class=na>setUserId</span><span class=p>(</span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=o>&lt;</span><span class=n>ShoppingCart</span><span class=o>&gt;</span><span class=w> </span><span class=n>shoppingCartList</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>shoppingCartMapper</span><span class=p>.</span><span class=na>getById</span><span class=p>(</span><span class=n>shoppingCart</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>shoppingCartList</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>shoppingCartList</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=o>==</span><span class=n>0</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 如果购物车中为空，那么抛出业务异常</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ShoppingCartBusinessException</span><span class=p>(</span><span class=n>MessageConstant</span><span class=p>.</span><span class=na>SHOPPING_CART_IS_NULL</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 1.2 判断地址是否为空</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Long</span><span class=w> </span><span class=n>addressBookId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ordersDTO</span><span class=p>.</span><span class=na>getAddressBookId</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>AddressBook</span><span class=w> </span><span class=n>address</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>addressBookMapper</span><span class=p>.</span><span class=na>getById</span><span class=p>(</span><span class=n>addressBookId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>address</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AddressBookBusinessException</span><span class=p>(</span><span class=n>MessageConstant</span><span class=p>.</span><span class=na>ADDRESS_BOOK_IS_NULL</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 2、向订单表插入1条数据</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 需要把数据先完善</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Orders</span><span class=w> </span><span class=n>orders</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Orders</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>BeanUtils</span><span class=p>.</span><span class=na>copyProperties</span><span class=p>(</span><span class=n>ordersDTO</span><span class=p>,</span><span class=n>orders</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 设置订单号，用当前时间的时间戳</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orders</span><span class=p>.</span><span class=na>setNumber</span><span class=p>(</span><span class=n>String</span><span class=p>.</span><span class=na>valueOf</span><span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orders</span><span class=p>.</span><span class=na>setStatus</span><span class=p>(</span><span class=n>Orders</span><span class=p>.</span><span class=na>PENDING_PAYMENT</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orders</span><span class=p>.</span><span class=na>setOrderTime</span><span class=p>(</span><span class=n>LocalDateTime</span><span class=p>.</span><span class=na>now</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orders</span><span class=p>.</span><span class=na>setPayStatus</span><span class=p>(</span><span class=n>Orders</span><span class=p>.</span><span class=na>UN_PAID</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orders</span><span class=p>.</span><span class=na>setPhone</span><span class=p>(</span><span class=n>address</span><span class=p>.</span><span class=na>getPhone</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orders</span><span class=p>.</span><span class=na>setAddress</span><span class=p>(</span><span class=n>address</span><span class=p>.</span><span class=na>getDetail</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orders</span><span class=p>.</span><span class=na>setConsignee</span><span class=p>(</span><span class=n>address</span><span class=p>.</span><span class=na>getConsignee</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orders</span><span class=p>.</span><span class=na>setUserId</span><span class=p>(</span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orderMapper</span><span class=p>.</span><span class=na>insert</span><span class=p>(</span><span class=n>orders</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=o>&lt;</span><span class=n>OrderDetail</span><span class=o>&gt;</span><span class=w> </span><span class=n>orderDetailList</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 3、向订单详细表插入n条数据（n是购物车里边的数据数量）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>ShoppingCart</span><span class=w> </span><span class=n>sc</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>shoppingCartList</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>OrderDetail</span><span class=w> </span><span class=n>orderDetail</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>OrderDetail</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>BeanUtils</span><span class=p>.</span><span class=na>copyProperties</span><span class=p>(</span><span class=n>sc</span><span class=p>,</span><span class=n>orderDetail</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>orderDetail</span><span class=p>.</span><span class=na>setOrderId</span><span class=p>(</span><span class=n>orders</span><span class=p>.</span><span class=na>getId</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>orderDetailList</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>orderDetail</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 一次性插入所有的数据</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orderDetailMapper</span><span class=p>.</span><span class=na>insertBatch</span><span class=p>(</span><span class=n>orderDetailList</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 4、把购物车清空</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>shoppingCartMapper</span><span class=p>.</span><span class=na>deleteAll</span><span class=p>(</span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 5、返回vo数据</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>OrderSubmitVO</span><span class=w> </span><span class=n>orderSubmitVO</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>OrderSubmitVO</span><span class=p>.</span><span class=na>builder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>orderAmount</span><span class=p>(</span><span class=n>orders</span><span class=p>.</span><span class=na>getAmount</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>orderNumber</span><span class=p>(</span><span class=n>orders</span><span class=p>.</span><span class=na>getNumber</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>orderTime</span><span class=p>(</span><span class=n>orders</span><span class=p>.</span><span class=na>getOrderTime</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>id</span><span class=p>(</span><span class=n>orders</span><span class=p>.</span><span class=na>getId</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>orderSubmitVO</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 订单支付
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param ordersPaymentDTO
</span></span></span><span class=line><span class=cl><span class=cm>     * @return
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>OrderPaymentVO</span><span class=w> </span><span class=nf>payment</span><span class=p>(</span><span class=n>OrdersPaymentDTO</span><span class=w> </span><span class=n>ordersPaymentDTO</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 当前登录用户id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>BaseContext</span><span class=p>.</span><span class=na>getCurrentId</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>User</span><span class=w> </span><span class=n>user</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>userMapper</span><span class=p>.</span><span class=na>getById</span><span class=p>(</span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//        //调用微信支付接口，生成预支付交易单</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 对应图中的第5步，调用微信下单接口</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//        JSONObject jsonObject = weChatPayUtil.pay(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//                ordersPaymentDTO.getOrderNumber(), //商户订单号</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//                new BigDecimal(0.01), //支付金额，单位 元</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//                &#34;苍穹外卖订单&#34;, //商品描述</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//                user.getOpenid() //微信用户的openid</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//        );</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>JSONObject</span><span class=w> </span><span class=n>jsonObject</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>JSONObject</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>jsonObject</span><span class=p>.</span><span class=na>getString</span><span class=p>(</span><span class=s>&#34;code&#34;</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>jsonObject</span><span class=p>.</span><span class=na>getString</span><span class=p>(</span><span class=s>&#34;code&#34;</span><span class=p>).</span><span class=na>equals</span><span class=p>(</span><span class=s>&#34;ORDERPAID&#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>OrderBusinessException</span><span class=p>(</span><span class=s>&#34;该订单已支付&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>OrderPaymentVO</span><span class=w> </span><span class=n>vo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>jsonObject</span><span class=p>.</span><span class=na>toJavaObject</span><span class=p>(</span><span class=n>OrderPaymentVO</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>vo</span><span class=p>.</span><span class=na>setPackageStr</span><span class=p>(</span><span class=n>jsonObject</span><span class=p>.</span><span class=na>getString</span><span class=p>(</span><span class=s>&#34;package&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>vo</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 支付成功，修改订单状态
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param outTradeNo
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>paySuccess</span><span class=p>(</span><span class=n>String</span><span class=w> </span><span class=n>outTradeNo</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 根据订单号查询订单</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Orders</span><span class=w> </span><span class=n>ordersDB</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderMapper</span><span class=p>.</span><span class=na>getByNumber</span><span class=p>(</span><span class=n>outTradeNo</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 根据订单id更新订单的状态、支付方式、支付状态、结账时间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Orders</span><span class=w> </span><span class=n>orders</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Orders</span><span class=p>.</span><span class=na>builder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>id</span><span class=p>(</span><span class=n>ordersDB</span><span class=p>.</span><span class=na>getId</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>status</span><span class=p>(</span><span class=n>Orders</span><span class=p>.</span><span class=na>TO_BE_CONFIRMED</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>payStatus</span><span class=p>(</span><span class=n>Orders</span><span class=p>.</span><span class=na>PAID</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>checkoutTime</span><span class=p>(</span><span class=n>LocalDateTime</span><span class=p>.</span><span class=na>now</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orderMapper</span><span class=p>.</span><span class=na>update</span><span class=p>(</span><span class=n>orders</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 历史订单查询
</span></span></span><span class=line><span class=cl><span class=cm>     * @param ordersPageQueryDTO
</span></span></span><span class=line><span class=cl><span class=cm>     * @return
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>PageResult</span><span class=w> </span><span class=nf>pageQuery</span><span class=p>(</span><span class=n>OrdersPageQueryDTO</span><span class=w> </span><span class=n>ordersPageQueryDTO</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 开始分页</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>PageHelper</span><span class=p>.</span><span class=na>startPage</span><span class=p>(</span><span class=n>ordersPageQueryDTO</span><span class=p>.</span><span class=na>getPage</span><span class=p>(),</span><span class=n>ordersPageQueryDTO</span><span class=p>.</span><span class=na>getPageSize</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 补全数据，先拿到用户信息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>BaseContext</span><span class=p>.</span><span class=na>getCurrentId</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ordersPageQueryDTO</span><span class=p>.</span><span class=na>setUserId</span><span class=p>(</span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 调用Mapper查询数据</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 先查询出订单信息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Page</span><span class=o>&lt;</span><span class=n>Orders</span><span class=o>&gt;</span><span class=w> </span><span class=n>page</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderMapper</span><span class=p>.</span><span class=na>pageQuery</span><span class=p>(</span><span class=n>ordersPageQueryDTO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=o>&lt;</span><span class=n>OrderVO</span><span class=o>&gt;</span><span class=w> </span><span class=n>list</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 封装订单详情信息，最后只需要返回OrderVO就可以了</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Orders</span><span class=w> </span><span class=n>orders</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>page</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 根据订单id获取订单详细信息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>List</span><span class=o>&lt;</span><span class=n>OrderDetail</span><span class=o>&gt;</span><span class=w> </span><span class=n>orderDetailList</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderDetailMapper</span><span class=p>.</span><span class=na>getByOrderId</span><span class=p>(</span><span class=n>orders</span><span class=p>.</span><span class=na>getId</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>OrderVO</span><span class=w> </span><span class=n>orderVO</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>OrderVO</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 完善一个orderVO对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>BeanUtils</span><span class=p>.</span><span class=na>copyProperties</span><span class=p>(</span><span class=n>orders</span><span class=p>,</span><span class=n>orderVO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>orderVO</span><span class=p>.</span><span class=na>setOrderDetailList</span><span class=p>(</span><span class=n>orderDetailList</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 还需要完善一下vo对象里边的orderDishes字段</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>orderVO</span><span class=p>.</span><span class=na>setOrderDishes</span><span class=p>(</span><span class=n>getDishDetail</span><span class=p>(</span><span class=n>orderDetailList</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>list</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>orderVO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// pageResult里边封装的是总记录数和记录集合</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>PageResult</span><span class=p>(</span><span class=n>page</span><span class=p>.</span><span class=na>getTotal</span><span class=p>(),</span><span class=n>list</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 查询全部订单
</span></span></span><span class=line><span class=cl><span class=cm>     * @param ordersPageQueryDTO
</span></span></span><span class=line><span class=cl><span class=cm>     * @return
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>PageResult</span><span class=w> </span><span class=nf>pageQueryAll</span><span class=p>(</span><span class=n>OrdersPageQueryDTO</span><span class=w> </span><span class=n>ordersPageQueryDTO</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 开始分页</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>PageHelper</span><span class=p>.</span><span class=na>startPage</span><span class=p>(</span><span class=n>ordersPageQueryDTO</span><span class=p>.</span><span class=na>getPage</span><span class=p>(),</span><span class=n>ordersPageQueryDTO</span><span class=p>.</span><span class=na>getPageSize</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 调用Mapper查询数据</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 先查询出订单信息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Page</span><span class=o>&lt;</span><span class=n>Orders</span><span class=o>&gt;</span><span class=w> </span><span class=n>page</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderMapper</span><span class=p>.</span><span class=na>pageQuery</span><span class=p>(</span><span class=n>ordersPageQueryDTO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=o>&lt;</span><span class=n>OrderVO</span><span class=o>&gt;</span><span class=w> </span><span class=n>list</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 封装订单详情信息，最后只需要返回OrderVO就可以了</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>Orders</span><span class=w> </span><span class=n>orders</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>page</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 根据订单id获取订单详细信息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>List</span><span class=o>&lt;</span><span class=n>OrderDetail</span><span class=o>&gt;</span><span class=w> </span><span class=n>orderDetailList</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderDetailMapper</span><span class=p>.</span><span class=na>getByOrderId</span><span class=p>(</span><span class=n>orders</span><span class=p>.</span><span class=na>getId</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>OrderVO</span><span class=w> </span><span class=n>orderVO</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>OrderVO</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 完善一个orderVO对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>BeanUtils</span><span class=p>.</span><span class=na>copyProperties</span><span class=p>(</span><span class=n>orders</span><span class=p>,</span><span class=n>orderVO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>orderVO</span><span class=p>.</span><span class=na>setOrderDetailList</span><span class=p>(</span><span class=n>orderDetailList</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 还需要完善一下vo对象里边的orderDishes字段</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>orderVO</span><span class=p>.</span><span class=na>setOrderDishes</span><span class=p>(</span><span class=n>getDishDetail</span><span class=p>(</span><span class=n>orderDetailList</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>list</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>orderVO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// pageResult里边封装的是总记录数和记录集合</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>PageResult</span><span class=p>(</span><span class=n>page</span><span class=p>.</span><span class=na>getTotal</span><span class=p>(),</span><span class=n>list</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 获取各个状态的订单数
</span></span></span><span class=line><span class=cl><span class=cm>     * @return
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>OrderStatisticsVO</span><span class=w> </span><span class=nf>getStatusCount</span><span class=p>()</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 获取待派送的数量</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Integer</span><span class=w> </span><span class=n>confirmed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderMapper</span><span class=p>.</span><span class=na>getStatusCount</span><span class=p>(</span><span class=n>Orders</span><span class=p>.</span><span class=na>CONFIRMED</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 获取派送中的数量</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Integer</span><span class=w> </span><span class=n>deliverInProgress</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderMapper</span><span class=p>.</span><span class=na>getStatusCount</span><span class=p>(</span><span class=n>Orders</span><span class=p>.</span><span class=na>DELIVERY_IN_PROGRESS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 获取待接单的数量</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Integer</span><span class=w> </span><span class=n>toBeConfirmed</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderMapper</span><span class=p>.</span><span class=na>getStatusCount</span><span class=p>(</span><span class=n>Orders</span><span class=p>.</span><span class=na>TO_BE_CONFIRMED</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>OrderStatisticsVO</span><span class=w> </span><span class=n>orderStatisticsVO</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>OrderStatisticsVO</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orderStatisticsVO</span><span class=p>.</span><span class=na>setConfirmed</span><span class=p>(</span><span class=n>confirmed</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orderStatisticsVO</span><span class=p>.</span><span class=na>setToBeConfirmed</span><span class=p>(</span><span class=n>toBeConfirmed</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orderStatisticsVO</span><span class=p>.</span><span class=na>setDeliveryInProgress</span><span class=p>(</span><span class=n>deliverInProgress</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>orderStatisticsVO</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 订单接单
</span></span></span><span class=line><span class=cl><span class=cm>     * @param ordersConfirmDTO
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>confirmOrder</span><span class=p>(</span><span class=n>OrdersConfirmDTO</span><span class=w> </span><span class=n>ordersConfirmDTO</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 先判断是否有这个订单</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Orders</span><span class=w> </span><span class=n>orders1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderMapper</span><span class=p>.</span><span class=na>getByOrderId</span><span class=p>(</span><span class=n>ordersConfirmDTO</span><span class=p>.</span><span class=na>getId</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>orders1</span><span class=o>==</span><span class=kc>null</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>OrderBusinessException</span><span class=p>(</span><span class=n>MessageConstant</span><span class=p>.</span><span class=na>ORDER_NOT_FOUND</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orders1</span><span class=p>.</span><span class=na>setStatus</span><span class=p>(</span><span class=n>Orders</span><span class=p>.</span><span class=na>CONFIRMED</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orders1</span><span class=p>.</span><span class=na>setId</span><span class=p>(</span><span class=n>ordersConfirmDTO</span><span class=p>.</span><span class=na>getId</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orderMapper</span><span class=p>.</span><span class=na>update</span><span class=p>(</span><span class=n>orders1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 订单拒单
</span></span></span><span class=line><span class=cl><span class=cm>     * @param ordersRejectionDTO
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>rejectOrder</span><span class=p>(</span><span class=n>OrdersRejectionDTO</span><span class=w> </span><span class=n>ordersRejectionDTO</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 判断是否有这个订单</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Orders</span><span class=w> </span><span class=n>orders</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderMapper</span><span class=p>.</span><span class=na>getByOrderId</span><span class=p>(</span><span class=n>ordersRejectionDTO</span><span class=p>.</span><span class=na>getId</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 判断是否是待接单状态，待接单状态才可以拒单</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>orders</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>orders</span><span class=p>.</span><span class=na>getStatus</span><span class=p>()</span><span class=o>!=</span><span class=n>Orders</span><span class=p>.</span><span class=na>TO_BE_CONFIRMED</span><span class=w> </span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>OrderBusinessException</span><span class=p>(</span><span class=n>MessageConstant</span><span class=p>.</span><span class=na>ORDER_STATUS_ERROR</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 改成取消状态</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orders</span><span class=p>.</span><span class=na>setStatus</span><span class=p>(</span><span class=n>Orders</span><span class=p>.</span><span class=na>CANCELLED</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 假装退款成功</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orders</span><span class=p>.</span><span class=na>setPayStatus</span><span class=p>(</span><span class=n>Orders</span><span class=p>.</span><span class=na>REFUND</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orders</span><span class=p>.</span><span class=na>setCancelReason</span><span class=p>(</span><span class=s>&#34;商家拒单&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orders</span><span class=p>.</span><span class=na>setCancelTime</span><span class=p>(</span><span class=n>LocalDateTime</span><span class=p>.</span><span class=na>now</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orders</span><span class=p>.</span><span class=na>setRejectionReason</span><span class=p>(</span><span class=n>ordersRejectionDTO</span><span class=p>.</span><span class=na>getRejectionReason</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orderMapper</span><span class=p>.</span><span class=na>update</span><span class=p>(</span><span class=n>orders</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 商家取消订单
</span></span></span><span class=line><span class=cl><span class=cm>     * @param ordersCancelDTO
</span></span></span><span class=line><span class=cl><span class=cm>     * @return
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>cancelOrderAdmin</span><span class=p>(</span><span class=n>OrdersCancelDTO</span><span class=w> </span><span class=n>ordersCancelDTO</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 判断是否有这个订单</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Orders</span><span class=w> </span><span class=n>orders</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderMapper</span><span class=p>.</span><span class=na>getByOrderId</span><span class=p>(</span><span class=n>ordersCancelDTO</span><span class=p>.</span><span class=na>getId</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>orders</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 如果没有这个订单，那么就抛出异常</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>OrderBusinessException</span><span class=p>(</span><span class=n>MessageConstant</span><span class=p>.</span><span class=na>ORDER_NOT_FOUND</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 判断订单状态是不是待付款、待派送、派送中、已完成状态可以进行取消操作，进行取消操作需要选择取消原因。</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>orders</span><span class=p>.</span><span class=na>getStatus</span><span class=p>()</span><span class=o>==</span><span class=n>Orders</span><span class=p>.</span><span class=na>TO_BE_CONFIRMED</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 待接单状态不能取消，只能拒接</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>OrderBusinessException</span><span class=p>(</span><span class=n>MessageConstant</span><span class=p>.</span><span class=na>ORDER_STATUS_ERROR</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 改成取消状态</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orders</span><span class=p>.</span><span class=na>setStatus</span><span class=p>(</span><span class=n>Orders</span><span class=p>.</span><span class=na>CANCELLED</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 假装退款成功</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orders</span><span class=p>.</span><span class=na>setPayStatus</span><span class=p>(</span><span class=n>Orders</span><span class=p>.</span><span class=na>REFUND</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orders</span><span class=p>.</span><span class=na>setCancelReason</span><span class=p>(</span><span class=n>ordersCancelDTO</span><span class=p>.</span><span class=na>getCancelReason</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orders</span><span class=p>.</span><span class=na>setCancelTime</span><span class=p>(</span><span class=n>LocalDateTime</span><span class=p>.</span><span class=na>now</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orderMapper</span><span class=p>.</span><span class=na>update</span><span class=p>(</span><span class=n>orders</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 派送订单
</span></span></span><span class=line><span class=cl><span class=cm>     * @param id
</span></span></span><span class=line><span class=cl><span class=cm>     * @return
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>deliveryOrder</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 先查询是否有这个订单，并且订单是待派送状态</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Orders</span><span class=w> </span><span class=n>orders</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderMapper</span><span class=p>.</span><span class=na>getByOrderId</span><span class=p>(</span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>orders</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>orders</span><span class=p>.</span><span class=na>getStatus</span><span class=p>()</span><span class=o>!=</span><span class=n>Orders</span><span class=p>.</span><span class=na>CONFIRMED</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>OrderBusinessException</span><span class=p>(</span><span class=n>MessageConstant</span><span class=p>.</span><span class=na>ORDER_NOT_FOUND</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 有这个订单，只需要把状态改成派送中即可</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orders</span><span class=p>.</span><span class=na>setStatus</span><span class=p>(</span><span class=n>Orders</span><span class=p>.</span><span class=na>DELIVERY_IN_PROGRESS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orderMapper</span><span class=p>.</span><span class=na>update</span><span class=p>(</span><span class=n>orders</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 完成订单
</span></span></span><span class=line><span class=cl><span class=cm>     * @param id
</span></span></span><span class=line><span class=cl><span class=cm>     * @return
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>completeOrder</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 首先判断订单是否存在，并且处于派送中状态</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Orders</span><span class=w> </span><span class=n>orders</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderMapper</span><span class=p>.</span><span class=na>getByOrderId</span><span class=p>(</span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>orders</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>orders</span><span class=p>.</span><span class=na>getStatus</span><span class=p>()</span><span class=o>!=</span><span class=n>4</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>OrderBusinessException</span><span class=p>(</span><span class=n>MessageConstant</span><span class=p>.</span><span class=na>ORDER_STATUS_ERROR</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 重新设置一个，这样插入的时间就会变短</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Orders</span><span class=w> </span><span class=n>orders1</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Orders</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 更改订单状态</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orders1</span><span class=p>.</span><span class=na>setStatus</span><span class=p>(</span><span class=n>Orders</span><span class=p>.</span><span class=na>COMPLETED</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orders1</span><span class=p>.</span><span class=na>setId</span><span class=p>(</span><span class=n>orders</span><span class=p>.</span><span class=na>getId</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 设置完成时间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orders1</span><span class=p>.</span><span class=na>setDeliveryTime</span><span class=p>(</span><span class=n>LocalDateTime</span><span class=p>.</span><span class=na>now</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orderMapper</span><span class=p>.</span><span class=na>update</span><span class=p>(</span><span class=n>orders1</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>String</span><span class=w> </span><span class=nf>getDishDetail</span><span class=p>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>OrderDetail</span><span class=o>&gt;</span><span class=w> </span><span class=n>orderDetailList</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>StringBuilder</span><span class=w> </span><span class=n>msg</span><span class=w> </span><span class=o>=</span><span class=k>new</span><span class=w> </span><span class=n>StringBuilder</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>OrderDetail</span><span class=w> </span><span class=n>orderDetail</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>orderDetailList</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 查询出套餐名字或者菜品名字，订单细节里边有包含名字，不需要查询了</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>msg</span><span class=p>.</span><span class=na>append</span><span class=p>(</span><span class=n>orderDetail</span><span class=p>.</span><span class=na>getName</span><span class=p>()).</span><span class=na>append</span><span class=p>(</span><span class=s>&#34;*&#34;</span><span class=p>).</span><span class=na>append</span><span class=p>(</span><span class=n>orderDetail</span><span class=p>.</span><span class=na>getNumber</span><span class=p>()).</span><span class=na>append</span><span class=p>(</span><span class=s>&#34;;&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>msg</span><span class=p>.</span><span class=na>toString</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 查询订单详情
</span></span></span><span class=line><span class=cl><span class=cm>     * @param orderId
</span></span></span><span class=line><span class=cl><span class=cm>     * @return
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>OrderVO</span><span class=w> </span><span class=nf>getOrderDetail</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>orderId</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 想要返回OrderVO，先创建一个</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>OrderVO</span><span class=w> </span><span class=n>orderVO</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>OrderVO</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Orders</span><span class=w> </span><span class=n>order</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderMapper</span><span class=p>.</span><span class=na>getByOrderId</span><span class=p>(</span><span class=n>orderId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 根据订单号来查询订单细节</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=o>&lt;</span><span class=n>OrderDetail</span><span class=o>&gt;</span><span class=w> </span><span class=n>orderDetailList</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderDetailMapper</span><span class=p>.</span><span class=na>getByOrderId</span><span class=p>(</span><span class=n>orderId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 构建vo对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>BeanUtils</span><span class=p>.</span><span class=na>copyProperties</span><span class=p>(</span><span class=n>order</span><span class=p>,</span><span class=n>orderVO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orderVO</span><span class=p>.</span><span class=na>setOrderDishes</span><span class=p>(</span><span class=n>getDishDetail</span><span class=p>(</span><span class=n>orderDetailList</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orderVO</span><span class=p>.</span><span class=na>setOrderDetailList</span><span class=p>(</span><span class=n>orderDetailList</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>orderVO</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 用户取消订单
</span></span></span><span class=line><span class=cl><span class=cm>     * @param id
</span></span></span><span class=line><span class=cl><span class=cm>     * @return
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>cancelOrder</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 取消订单就是把里边的状态改成已取消，同时添加上取消时间</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 需要判断订单的状态是否可以取消</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//       待支付和待接单状态下，用户可直接取消订单</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//       商家已接单状态下，用户取消订单需电话沟通商家</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//       派送中状态下，用户取消订单需电话沟通商家</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//       如果在待接单状态下取消订单，需要给用户退款</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//       取消订单后需要将订单状态修改为“已取消”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 查询是否有这个订单</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Orders</span><span class=w> </span><span class=n>orders</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderMapper</span><span class=p>.</span><span class=na>getByOrderId</span><span class=p>(</span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>orders</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>OrderBusinessException</span><span class=p>(</span><span class=n>MessageConstant</span><span class=p>.</span><span class=na>ORDER_NOT_FOUND</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>orders</span><span class=p>.</span><span class=na>getStatus</span><span class=p>()</span><span class=o>&gt;=</span><span class=n>3</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 已经在已接单以上的状态了，需要打电话和商家沟通</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>OrderBusinessException</span><span class=p>(</span><span class=n>MessageConstant</span><span class=p>.</span><span class=na>ORDER_STATUS_ERROR</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 如果是在待接单的状态，需要退款</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>orders</span><span class=p>.</span><span class=na>getStatus</span><span class=p>().</span><span class=na>equals</span><span class=p>(</span><span class=n>Orders</span><span class=p>.</span><span class=na>TO_BE_CONFIRMED</span><span class=p>)){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 假装退款成功</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>orders</span><span class=p>.</span><span class=na>setPayStatus</span><span class=p>(</span><span class=n>Orders</span><span class=p>.</span><span class=na>REFUND</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orders</span><span class=p>.</span><span class=na>setCancelTime</span><span class=p>(</span><span class=n>LocalDateTime</span><span class=p>.</span><span class=na>now</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orders</span><span class=p>.</span><span class=na>setCancelReason</span><span class=p>(</span><span class=s>&#34;用户取消订单&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orders</span><span class=p>.</span><span class=na>setStatus</span><span class=p>(</span><span class=n>Orders</span><span class=p>.</span><span class=na>CANCELLED</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orderMapper</span><span class=p>.</span><span class=na>update</span><span class=p>(</span><span class=n>orders</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 再来一单
</span></span></span><span class=line><span class=cl><span class=cm>     * @param id
</span></span></span><span class=line><span class=cl><span class=cm>     * @return
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>repeat</span><span class=p>(</span><span class=n>Long</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 目前的思路是，先根据订单号查询到订单的菜品信息，然后把购物车清空，重新添加上菜品</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Orders</span><span class=w> </span><span class=n>orders</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderMapper</span><span class=p>.</span><span class=na>getByOrderId</span><span class=p>(</span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 先判断一下，有没有这个订单</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>orders</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>OrderBusinessException</span><span class=p>(</span><span class=n>MessageConstant</span><span class=p>.</span><span class=na>ORDER_NOT_FOUND</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 根据订单查询详细的菜品信息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=o>&lt;</span><span class=n>OrderDetail</span><span class=o>&gt;</span><span class=w> </span><span class=n>byOrderId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderDetailMapper</span><span class=p>.</span><span class=na>getByOrderId</span><span class=p>(</span><span class=n>id</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 先清除购物车</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>shoppingCartMapper</span><span class=p>.</span><span class=na>deleteAll</span><span class=p>(</span><span class=n>BaseContext</span><span class=p>.</span><span class=na>getCurrentId</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 把list集合里边的每一条数据都封装成一个购物车对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>OrderDetail</span><span class=w> </span><span class=n>orderDetail</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>byOrderId</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>ShoppingCart</span><span class=w> </span><span class=n>shoppingCart</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ShoppingCart</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>BeanUtils</span><span class=p>.</span><span class=na>copyProperties</span><span class=p>(</span><span class=n>orderDetail</span><span class=p>,</span><span class=n>shoppingCart</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>shoppingCart</span><span class=p>.</span><span class=na>setCreateTime</span><span class=p>(</span><span class=n>LocalDateTime</span><span class=p>.</span><span class=na>now</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 还需要设置用户id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>shoppingCart</span><span class=p>.</span><span class=na>setUserId</span><span class=p>(</span><span class=n>BaseContext</span><span class=p>.</span><span class=na>getCurrentId</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>shoppingCartMapper</span><span class=p>.</span><span class=na>insert</span><span class=p>(</span><span class=n>shoppingCart</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>注意每次拿到的时候的逻辑的判断很重要，如果直接发送请求，不经过前端验证，需要防范不合理的请求</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://wqnm1gb.github.io/tags/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96/>苍穹外卖</a></li></ul><nav class=paginav><a class=prev href=https://wqnm1gb.github.io/posts/day10%E8%AE%A2%E5%8D%95%E7%8A%B6%E6%80%81%E5%AE%9A%E6%97%B6%E5%A4%84%E7%90%86%E6%9D%A5%E5%8D%95%E6%8F%90%E9%86%92%E5%92%8C%E5%AE%A2%E6%88%B7%E5%82%AC%E5%8D%95/><span class=title>« 上一页</span><br><span>Day10 订单状态定时处理、来单提醒和客户催单</span>
</a><a class=next href=https://wqnm1gb.github.io/posts/day08%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/><span class=title>下一页 »</span><br><span>Day08 用户下单、订单支付</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://wqnm1gb.github.io/>三狗子的博客</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>