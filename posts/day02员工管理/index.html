<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Day02 员工管理 | 三狗子的博客</title>
<meta name=keywords content="苍穹外卖"><meta name=description content="新增员工功能开发
需求分析和设计
本项目约定：

管理端发出的请求，统一使用/admin 作为前缀
用户端发出的请求，统一使用/user 作为前缀

代码开发
注意：当前端提交的数据和实体类中对应的属性差别比较大时，建议使用DTO来封装数据"><meta name=author content="冷漠三狗子丶"><link rel=canonical href=https://wqnm1gb.github.io/posts/day02%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86/><link crossorigin=anonymous href=/assets/css/stylesheet.3d688279d829dc24da48acd11f9e33ebea2f39c035e899e1bf4297d8b7aa89b9.css integrity="sha256-PWiCedgp3CTaSKzRH54z6+ovOcA16Jnhv0KX2Leqibk=" rel="preload stylesheet" as=style><link rel=icon href=https://wqnm1gb.github.io/images/favicon.png><link rel=icon type=image/png sizes=16x16 href=https://wqnm1gb.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://wqnm1gb.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://wqnm1gb.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://wqnm1gb.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://wqnm1gb.github.io/posts/day02%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap" rel=stylesheet><script type=text/javascript async src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">MathJax.Hub.Config({tex2jax:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["[[","]]"]],processEscapes:!0,processEnvironments:!0,skipTags:["script","noscript","style","textarea","pre"],TeX:{equationNumbers:{autoNumber:"AMS"},extensions:["AMSmath.js","AMSsymbols.js"]}}}),MathJax.Hub.Queue(function(){var e,t=MathJax.Hub.getAllJax();for(e=0;e<t.length;e+=1)t[e].SourceElement().parentNode.className+=" has-jax"})</script><style>code.has-jax{font:inherit;font-size:100%;background:inherit;border:inherit;color:#515151}</style><meta property="og:title" content="Day02 员工管理"><meta property="og:description" content="新增员工功能开发
需求分析和设计
本项目约定：

管理端发出的请求，统一使用/admin 作为前缀
用户端发出的请求，统一使用/user 作为前缀

代码开发
注意：当前端提交的数据和实体类中对应的属性差别比较大时，建议使用DTO来封装数据"><meta property="og:type" content="article"><meta property="og:url" content="https://wqnm1gb.github.io/posts/day02%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86/"><meta property="og:image" content="https://wqnm1gb.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-03-20T11:05:38+08:00"><meta property="article:modified_time" content="2025-03-20T11:05:38+08:00"><meta property="og:site_name" content="三狗子的博客"><meta property="fb:admins" content="your-facebook-admin-id"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://wqnm1gb.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Day02 员工管理","item":"https://wqnm1gb.github.io/posts/day02%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Day02 员工管理","name":"Day02 员工管理","description":"新增员工功能开发 需求分析和设计 本项目约定：\n管理端发出的请求，统一使用/admin 作为前缀 用户端发出的请求，统一使用/user 作为前缀 代码开发 注意：当前端提交的数据和实体类中对应的属性差别比较大时，建议使用DTO来封装数据\n","keywords":["苍穹外卖"],"articleBody":"新增员工功能开发 需求分析和设计 本项目约定：\n管理端发出的请求，统一使用/admin 作为前缀 用户端发出的请求，统一使用/user 作为前缀 代码开发 注意：当前端提交的数据和实体类中对应的属性差别比较大时，建议使用DTO来封装数据\n所以在这个项目中，前端传过来的数据需要使用DTO接收，然后插入数据库的数据是另外的，内容更多的数据，所以在Service层中需要对数据进行完善\n通过对象的属性拷贝，就不需要再一个一个的设置了，但是前提是目标的属性和源属性的属性名是一致的\nBeanUtils.copyProperties(从哪里拷贝,拷贝到哪里) 接收Json格式的数据用的注解是@RequestBody\n功能测试 如果需要接口测试，要在controller层编写的代码方法中加入\n@ApiOperation(\"新增员工\") 在调试的时候，因为已经使用了jwt令牌校验，所以要先获取到一个token，保存为全局变量\n之所以参数名称需要是token是因为在application.yml中设置了\n代码完善 完善1：数据库报错后无法展示错误信息 用全局异常处理器，来处理异常信息，比如说多次添加同一个用户名，这个是数据库不允许的，如果不处理异常的话，会报500的服务器异常\njava.sql.SQLIntegrityConstraintViolationException: Duplicate entry 'xiaozhi' for key 'employee.idx_username' 完善后的代码：\n/** * 捕获SQL完整性约束违反异常 */ @ExceptionHandler public Result exceptionHandler(SQLIntegrityConstraintViolationException ex){ log.error(\"异常信息：{}\", ex.getMessage()); // 找到异常的id信息 String message = ex.getMessage(); // 判断异常信息是否包括 “Duplicate entry” if(message.contains(\"Duplicate entry\")) { String[] s = message.split(\" \"); String name = s[2]; return Result.error(name + MessageConstant.ALREADY_EXISTS); }else { // 如果没有包括就报未知错误 return Result.error(MessageConstant.UNKNOWN_ERROR); } } 这里边的代码，需要注意的是判断是否包含Duplicate entry 这个步骤，因为整个错误类型是SQL完整性约束违反异常，里边包括了很多，需要具体判断不同的错误\n完善2：无法获取到新增用户的用户信息 后续请求中，前端会携带JVT令牌，通过JWVT令牌可以解析出当前登录员工id\n使用ThreadLocal 这在Java Web 13天里有详细的解释\nThreadLocal 并不是一个Thread，而是Thread的局部变量。\nThreadLocal为每个线程提供**单独一份存储空间**，具有线程隔离的效果，只有在线程内才能获取到对应的值，线程外则不能访问。\nThreadLocal常用方法：\npublic void set（T value）设置当前线程的线程局部变量的值 public T get（） 返回当前线程所对应的线程局部变量的值 public void remove（ 移除当前线程的线程局部变量 注意：客户端发送的每次请求，后端的Tomcat服务器都会分配一个单独的线程来处理请求\n把需要存放的id通过Jwt令牌的解析后，放在ThreadLocal里边，这样服务器就可以访问到\n开发员工编写的代码：\n/** *新增员工 */ @PostMapping @ApiOperation(\"新增员工\") public Result save(@RequestBody EmployeeDTO employeeDTO){ // 接收参数，并且用日志的方式输出 log.info(\"新增员工 {}\",employeeDTO); log.info(\"员工id{}\",BaseContext.getCurrentId()); // 调用Service层 employeeService.save(employeeDTO); return Result.success(); } @Override public void save(EmployeeDTO employeeDTO) { // 在这里需要把数据完善，然后传给Mapper层进行数据库的插入，这里边需要使用的Employee类 Employee employee = new Employee(); BeanUtils.copyProperties(employeeDTO, employee); // 设置状态，默认是1 employee.setStatus(StatusConstant.ENABLE); // 设置密码 employee.setPassword(DigestUtils.md5DigestAsHex(PasswordConstant.DEFAULT_PASSWORD.getBytes())); employee.setCreateTime(LocalDateTime.now()); employee.setUpdateTime(LocalDateTime.now()); employee.setCreateUser(BaseContext.getCurrentId()); employee.setUpdateUser(BaseContext.getCurrentId()); employeeMapper.insert(employee); } @Insert(\"insert into employee (name, username, password, phone, sex, id_number, status, create_time, update_time, create_user, update_user) \" + \"values \" + \"(#{name},#{username},#{password},#{phone},#{sex},#{idNumber},#{status},#{createTime},#{updateTime},#{createUser},#{updateUser})\" ) void insert(Employee employee); 分页查询 Query查询的参数是通过地址栏？的形式传参的，与Json格式的区别\npagehelper的使用\n@Override public PageResult pageQuery(EmployeePageQueryDTO employeePageQueryDTO) { // 使用Pagehelper，开始分页，传入参数1：页码，传入参数2：每页记录数 PageHelper.startPage(employeePageQueryDTO.getPage(), employeePageQueryDTO.getPageSize()); // 调用Mapper层进行查询，会返回一个Page对象 Page\u003cEmployee\u003e page = employeeMapper.pageQuery(employeePageQueryDTO); // 将Page对象转换为PageResult对象，返回 return new PageResult(page.getTotal(), page.getResult()); } 返回的LocalDateTime对象直接转换成Json会有问题\n解决的方法有两种\n方式1：在属性上加入注解，对日期进行格式化（这个是在JavaWeb中学的）\n@JsonFormat(pattern = \"yyyy-MM-dd HH:mm:ss\") private LocalDateTime createTime; 方式2：在 WebMvcConfiguration 中扩展Spring MVC的消息转换器，统一对日期类型进行格式化处理\n/** * 扩展mvc框架的消息转换器 */ protected void extendMessageConverters(List\u003cHttpMessageConverter\u003c?\u003e\u003e converters) { log.info(\"开始扩展消息转换器...\"); //创建一个消息转化器对象 MappingJackson2HttpMessageConverter converter = new MappingJackson2HttpMessageConverter(); //设置对象转换器，可以将Java对象转为json字符串 converter.setObjectMapper(new JacksonObjectMapper()); //将我们自己的转换器放入spring MVC框架的容器中 converters.add(0,converter); } 启用和禁用员工 @Override public void startOrStop(Integer status, Long id) { // update employee set status = where id = // 采用动态sql，可以update所有的字段，方便别的功能调用 Employee employee = Employee.builder().status(status).id(id).build(); employeeMapper.update(employee); } 里边所有的id都是用long类型修饰的\n@PathVariable是用来修饰路径参数的\n可以使用构建器build来构建对象\nEmployee employee = Employee.builder().status(status).id(id).build(); 更改员工状态的时候遇到的bug\n忘记加表名了\nupdate set 表名\n编辑员工 编辑员工的功能分为两个模块实现：1、根据id查询员工并且回显，回显的时候注意把密码信息改成***** 2、根据前端传过去的Json信息来修改数据库的内容\n修改数据库内容的时候，因为修改数据库需要传递的employee对象而前端传来的是employeeDTO对象，所以需要用到拷贝器，同时为了获得到是谁修改了，需要jwt令牌解析到id后存到ThreadLocal中\n@Override public void updateUser(EmployeeDTO employeeDTO) { // 因为写的mapper层update函数需要的是Employee信息，所以需要用拷贝器 Employee employee = new Employee(); BeanUtils.copyProperties(employeeDTO,employee); // employee.setPassword(\"*****\"); 不是这里改密码的显示，而是查询的时候 employee.setUpdateUser(BaseContext.getCurrentId()); employee.setUpdateTime(LocalDateTime.now()); employeeMapper.update(employee); } 编辑员工信息的时候遇到的bug\nJson格式的数据需要加@RequestBody\n","wordCount":"2227","inLanguage":"zh","image":"https://wqnm1gb.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2025-03-20T11:05:38+08:00","dateModified":"2025-03-20T11:05:38+08:00","author":{"@type":"Person","name":"冷漠三狗子丶"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://wqnm1gb.github.io/posts/day02%E5%91%98%E5%B7%A5%E7%AE%A1%E7%90%86/"},"publisher":{"@type":"Organization","name":"三狗子的博客","logo":{"@type":"ImageObject","url":"https://wqnm1gb.github.io/images/favicon.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wqnm1gb.github.io/ accesskey=h title="主页 (Alt + H)"><img src=https://wqnm1gb.github.io/apple-touch-icon.png alt aria-label=logo height=35>主页</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://wqnm1gb.github.io/ title=三狗子的博客><span>首页</span></a></li><li><a href=https://wqnm1gb.github.io/archives/ title=归档><span>归档</span></a></li><li><a href=https://wqnm1gb.github.io/categories/ title=Categories><span>分类</span></a></li><li><a href=https://wqnm1gb.github.io/tags/ title=Tags><span>标签</span></a></li><li><a href=https://wqnm1gb.github.io/search/ title=搜索><span>搜索</span></a></li><li><a href=https://wqnm1gb.github.io/about/ title=关于><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://wqnm1gb.github.io/>主页</a>&nbsp;»&nbsp;<a href=https://wqnm1gb.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Day02 员工管理</h1><div class=post-meta><span title='2025-03-20 11:05:38 +0800 +0800'>三月 20, 2025</span>&nbsp;·&nbsp;5 分钟&nbsp;·&nbsp;2227 字&nbsp;·&nbsp;冷漠三狗子丶</div></header><div class=post-content><h1 id=新增员工功能开发>新增员工功能开发<a hidden class=anchor aria-hidden=true href=#新增员工功能开发>#</a></h1><h2 id=需求分析和设计>需求分析和设计<a hidden class=anchor aria-hidden=true href=#需求分析和设计>#</a></h2><p>本项目约定：</p><ul><li>管理端发出的请求，统一使用/admin 作为前缀</li><li>用户端发出的请求，统一使用/user 作为前缀</li></ul><h2 id=代码开发>代码开发<a hidden class=anchor aria-hidden=true href=#代码开发>#</a></h2><p>注意：当前端提交的数据和实体类中对应的属性差别比较大时，建议使用DTO来封装数据</p><p>所以在这个项目中，前端传过来的数据需要使用DTO接收，然后插入数据库的数据是另外的，内容更多的数据，所以在Service层中需要对数据进行完善</p><p>通过对象的属性拷贝，就不需要再一个一个的设置了，但是前提是目标的属性和源属性的属性名是一致的</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>BeanUtils</span><span class=p>.</span><span class=na>copyProperties</span><span class=p>(</span><span class=n>从哪里拷贝</span><span class=p>,</span><span class=n>拷贝到哪里</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p>接收Json格式的数据用的注解是@RequestBody</p><h2 id=功能测试>功能测试<a hidden class=anchor aria-hidden=true href=#功能测试>#</a></h2><p>如果需要接口测试，要在controller层编写的代码方法中加入</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@ApiOperation</span><span class=p>(</span><span class=s>&#34;新增员工&#34;</span><span class=p>)</span><span class=w>
</span></span></span></code></pre></div><p>在调试的时候，因为已经使用了jwt令牌校验，所以要先获取到一个token，保存为全局变量</p><p><img loading=lazy src=/images/Day02%e5%91%98%e5%b7%a5%e7%ae%a1%e7%90%86.assets/1739240249555-17854ac8-1938-463c-9aaa-d314c117906c.png alt></p><p><img loading=lazy src=/images/Day02%e5%91%98%e5%b7%a5%e7%ae%a1%e7%90%86.assets/1739240285156-73074076-47db-48c1-964d-49df68f48d8c.png alt></p><p>之所以参数名称需要是token是因为在application.yml中设置了</p><p><img loading=lazy src=/images/Day02%e5%91%98%e5%b7%a5%e7%ae%a1%e7%90%86.assets/1739240370189-ae855cfc-0d63-4a0e-9cd3-3bf33496ac93.png alt></p><h2 id=代码完善>代码完善<a hidden class=anchor aria-hidden=true href=#代码完善>#</a></h2><h3 id=完善1数据库报错后无法展示错误信息>完善1：数据库报错后无法展示错误信息<a hidden class=anchor aria-hidden=true href=#完善1数据库报错后无法展示错误信息>#</a></h3><p>用全局异常处理器，来处理异常信息，比如说多次添加同一个用户名，这个是数据库不允许的，如果不处理异常的话，会报500的服务器异常</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>java</span><span class=p>.</span><span class=na>sql</span><span class=p>.</span><span class=na>SQLIntegrityConstraintViolationException</span><span class=p>:</span><span class=w> </span><span class=n>Duplicate</span><span class=w> </span><span class=n>entry</span><span class=w> </span><span class=err>&#39;</span><span class=n>xiaozhi</span><span class=err>&#39;</span><span class=w> </span><span class=k>for</span><span class=w> </span><span class=n>key</span><span class=w> </span><span class=err>&#39;</span><span class=n>employee</span><span class=p>.</span><span class=na>idx_username</span><span class=err>&#39;</span><span class=w>
</span></span></span></code></pre></div><p>完善后的代码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 捕获SQL完整性约束违反异常
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ExceptionHandler</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Result</span><span class=w> </span><span class=nf>exceptionHandler</span><span class=p>(</span><span class=n>SQLIntegrityConstraintViolationException</span><span class=w> </span><span class=n>ex</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=s>&#34;异常信息：{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ex</span><span class=p>.</span><span class=na>getMessage</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 找到异常的id信息</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>String</span><span class=w> </span><span class=n>message</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ex</span><span class=p>.</span><span class=na>getMessage</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 判断异常信息是否包括 “Duplicate entry”</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>message</span><span class=p>.</span><span class=na>contains</span><span class=p>(</span><span class=s>&#34;Duplicate entry&#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=o>[]</span><span class=w> </span><span class=n>s</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>message</span><span class=p>.</span><span class=na>split</span><span class=p>(</span><span class=s>&#34; &#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>String</span><span class=w> </span><span class=n>name</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>s</span><span class=o>[</span><span class=n>2</span><span class=o>]</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>Result</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=n>name</span><span class=w> </span><span class=o>+</span><span class=w> </span><span class=n>MessageConstant</span><span class=p>.</span><span class=na>ALREADY_EXISTS</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=k>else</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 如果没有包括就报未知错误</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>return</span><span class=w> </span><span class=n>Result</span><span class=p>.</span><span class=na>error</span><span class=p>(</span><span class=n>MessageConstant</span><span class=p>.</span><span class=na>UNKNOWN_ERROR</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>这里边的代码，需要注意的是判断是否包含Duplicate entry 这个步骤，因为整个错误类型是SQL完整性约束违反异常，里边包括了很多，需要具体判断不同的错误</p><p></p><h3 id=完善2无法获取到新增用户的用户信息>完善2：无法获取到新增用户的用户信息<a hidden class=anchor aria-hidden=true href=#完善2无法获取到新增用户的用户信息>#</a></h3><p><img loading=lazy src=/images/Day02%e5%91%98%e5%b7%a5%e7%ae%a1%e7%90%86.assets/1739244315516-014faffc-d79f-4777-9951-9afdf80bf2de.png alt></p><p>后续请求中，前端会携带JVT令牌，通过JWVT令牌可以解析出当前登录员工id</p><p>使用ThreadLocal 这在Java Web 13天里有详细的解释</p><p>ThreadLocal 并不是一个Thread，而是Thread的局部变量。</p><p>ThreadLocal为每个线程提供**单独一份存储空间**，具有线程隔离的效果，只有在线程内才能获取到对应的值，线程外则不能访问。</p><p><strong>ThreadLocal常用方法：</strong></p><ul><li>public void set（T value）设置当前线程的线程局部变量的值</li><li>public T get（） 返回当前线程所对应的线程局部变量的值</li><li>public void remove（ 移除当前线程的线程局部变量</li></ul><p>注意：客户端发送的每次请求，后端的Tomcat服务器都会分配一个单独的线程来处理请求</p><p>把需要存放的id通过Jwt令牌的解析后，放在ThreadLocal里边，这样服务器就可以访问到</p><p>开发员工编写的代码：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     *新增员工
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@PostMapping</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ApiOperation</span><span class=p>(</span><span class=s>&#34;新增员工&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Result</span><span class=w> </span><span class=nf>save</span><span class=p>(</span><span class=nd>@RequestBody</span><span class=w> </span><span class=n>EmployeeDTO</span><span class=w> </span><span class=n>employeeDTO</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 接收参数，并且用日志的方式输出</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;新增员工 {}&#34;</span><span class=p>,</span><span class=n>employeeDTO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;员工id{}&#34;</span><span class=p>,</span><span class=n>BaseContext</span><span class=p>.</span><span class=na>getCurrentId</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 调用Service层</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>employeeService</span><span class=p>.</span><span class=na>save</span><span class=p>(</span><span class=n>employeeDTO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Result</span><span class=p>.</span><span class=na>success</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>save</span><span class=p>(</span><span class=n>EmployeeDTO</span><span class=w> </span><span class=n>employeeDTO</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 在这里需要把数据完善，然后传给Mapper层进行数据库的插入，这里边需要使用的Employee类</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Employee</span><span class=w> </span><span class=n>employee</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Employee</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>BeanUtils</span><span class=p>.</span><span class=na>copyProperties</span><span class=p>(</span><span class=n>employeeDTO</span><span class=p>,</span><span class=w> </span><span class=n>employee</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 设置状态，默认是1</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>employee</span><span class=p>.</span><span class=na>setStatus</span><span class=p>(</span><span class=n>StatusConstant</span><span class=p>.</span><span class=na>ENABLE</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 设置密码</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>employee</span><span class=p>.</span><span class=na>setPassword</span><span class=p>(</span><span class=n>DigestUtils</span><span class=p>.</span><span class=na>md5DigestAsHex</span><span class=p>(</span><span class=n>PasswordConstant</span><span class=p>.</span><span class=na>DEFAULT_PASSWORD</span><span class=p>.</span><span class=na>getBytes</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>employee</span><span class=p>.</span><span class=na>setCreateTime</span><span class=p>(</span><span class=n>LocalDateTime</span><span class=p>.</span><span class=na>now</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>employee</span><span class=p>.</span><span class=na>setUpdateTime</span><span class=p>(</span><span class=n>LocalDateTime</span><span class=p>.</span><span class=na>now</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>employee</span><span class=p>.</span><span class=na>setCreateUser</span><span class=p>(</span><span class=n>BaseContext</span><span class=p>.</span><span class=na>getCurrentId</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>employee</span><span class=p>.</span><span class=na>setUpdateUser</span><span class=p>(</span><span class=n>BaseContext</span><span class=p>.</span><span class=na>getCurrentId</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>employeeMapper</span><span class=p>.</span><span class=na>insert</span><span class=p>(</span><span class=n>employee</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=nd>@Insert</span><span class=p>(</span><span class=s>&#34;insert into employee (name, username, password, phone, sex, id_number, status, create_time, update_time, create_user, update_user) &#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=s>&#34;values &#34;</span><span class=w> </span><span class=o>+</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=s>&#34;(#{name},#{username},#{password},#{phone},#{sex},#{idNumber},#{status},#{createTime},#{updateTime},#{createUser},#{updateUser})&#34;</span><span class=w> </span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kt>void</span><span class=w> </span><span class=nf>insert</span><span class=p>(</span><span class=n>Employee</span><span class=w> </span><span class=n>employee</span><span class=p>);</span><span class=w>
</span></span></span></code></pre></div><h1 id=分页查询>分页查询<a hidden class=anchor aria-hidden=true href=#分页查询>#</a></h1><p>Query查询的参数是通过地址栏？的形式传参的，与Json格式的区别</p><p>pagehelper的使用</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>PageResult</span><span class=w> </span><span class=nf>pageQuery</span><span class=p>(</span><span class=n>EmployeePageQueryDTO</span><span class=w> </span><span class=n>employeePageQueryDTO</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 使用Pagehelper，开始分页，传入参数1：页码，传入参数2：每页记录数</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>PageHelper</span><span class=p>.</span><span class=na>startPage</span><span class=p>(</span><span class=n>employeePageQueryDTO</span><span class=p>.</span><span class=na>getPage</span><span class=p>(),</span><span class=w> </span><span class=n>employeePageQueryDTO</span><span class=p>.</span><span class=na>getPageSize</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 调用Mapper层进行查询，会返回一个Page对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Page</span><span class=o>&lt;</span><span class=n>Employee</span><span class=o>&gt;</span><span class=w> </span><span class=n>page</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>employeeMapper</span><span class=p>.</span><span class=na>pageQuery</span><span class=p>(</span><span class=n>employeePageQueryDTO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 将Page对象转换为PageResult对象，返回</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>PageResult</span><span class=p>(</span><span class=n>page</span><span class=p>.</span><span class=na>getTotal</span><span class=p>(),</span><span class=w> </span><span class=n>page</span><span class=p>.</span><span class=na>getResult</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>返回的LocalDateTime对象直接转换成Json会有问题</p><p><img loading=lazy src=/images/Day02%e5%91%98%e5%b7%a5%e7%ae%a1%e7%90%86.assets/1739672505602-bad4428b-014f-490e-b7df-2ff2242dd969.png alt></p><p>解决的方法有两种</p><p>方式1：在属性上加入注解，对日期进行格式化（这个是在JavaWeb中学的）</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=nd>@JsonFormat</span><span class=p>(</span><span class=n>pattern</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;yyyy-MM-dd HH:mm:ss&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>private</span><span class=w> </span><span class=n>LocalDateTime</span><span class=w> </span><span class=n>createTime</span><span class=p>;</span><span class=w>
</span></span></span></code></pre></div><p>方式2：在 WebMvcConfiguration 中扩展Spring MVC的消息转换器，统一对日期类型进行格式化处理</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 扩展mvc框架的消息转换器
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>protected</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>extendMessageConverters</span><span class=p>(</span><span class=n>List</span><span class=o>&lt;</span><span class=n>HttpMessageConverter</span><span class=o>&lt;?&gt;&gt;</span><span class=w> </span><span class=n>converters</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;开始扩展消息转换器...&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//创建一个消息转化器对象</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>MappingJackson2HttpMessageConverter</span><span class=w> </span><span class=n>converter</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>MappingJackson2HttpMessageConverter</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//设置对象转换器，可以将Java对象转为json字符串</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>converter</span><span class=p>.</span><span class=na>setObjectMapper</span><span class=p>(</span><span class=k>new</span><span class=w> </span><span class=n>JacksonObjectMapper</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>//将我们自己的转换器放入spring MVC框架的容器中</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>converters</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>0</span><span class=p>,</span><span class=n>converter</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h1 id=启用和禁用员工>启用和禁用员工<a hidden class=anchor aria-hidden=true href=#启用和禁用员工>#</a></h1><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>startOrStop</span><span class=p>(</span><span class=n>Integer</span><span class=w> </span><span class=n>status</span><span class=p>,</span><span class=w> </span><span class=n>Long</span><span class=w> </span><span class=n>id</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// update employee set status = where id =</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 采用动态sql，可以update所有的字段，方便别的功能调用</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Employee</span><span class=w> </span><span class=n>employee</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Employee</span><span class=p>.</span><span class=na>builder</span><span class=p>().</span><span class=na>status</span><span class=p>(</span><span class=n>status</span><span class=p>).</span><span class=na>id</span><span class=p>(</span><span class=n>id</span><span class=p>).</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>employeeMapper</span><span class=p>.</span><span class=na>update</span><span class=p>(</span><span class=n>employee</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>里边所有的id都是用long类型修饰的</p><p>@PathVariable是用来修饰路径参数的</p><p>可以使用<strong>构建器build</strong>来构建对象</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=n>Employee</span><span class=w> </span><span class=n>employee</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>Employee</span><span class=p>.</span><span class=na>builder</span><span class=p>().</span><span class=na>status</span><span class=p>(</span><span class=n>status</span><span class=p>).</span><span class=na>id</span><span class=p>(</span><span class=n>id</span><span class=p>).</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span></code></pre></div><p>更改员工状态的时候遇到的bug</p><p>忘记加表名了</p><p>update set 表名</p><h1 id=编辑员工>编辑员工<a hidden class=anchor aria-hidden=true href=#编辑员工>#</a></h1><p>编辑员工的功能分为两个模块实现：1、根据id查询员工并且回显，回显的时候注意把密码信息改成***** 2、根据前端传过去的Json信息来修改数据库的内容</p><p>修改数据库内容的时候，因为修改数据库需要传递的employee对象而前端传来的是employeeDTO对象，所以需要用到拷贝器，同时为了获得到是谁修改了，需要jwt令牌解析到id后存到ThreadLocal中</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=kt>void</span><span class=w> </span><span class=nf>updateUser</span><span class=p>(</span><span class=n>EmployeeDTO</span><span class=w> </span><span class=n>employeeDTO</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 因为写的mapper层update函数需要的是Employee信息，所以需要用拷贝器</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Employee</span><span class=w> </span><span class=n>employee</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Employee</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>BeanUtils</span><span class=p>.</span><span class=na>copyProperties</span><span class=p>(</span><span class=n>employeeDTO</span><span class=p>,</span><span class=n>employee</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//        employee.setPassword(&#34;*****&#34;); 不是这里改密码的显示，而是查询的时候</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>employee</span><span class=p>.</span><span class=na>setUpdateUser</span><span class=p>(</span><span class=n>BaseContext</span><span class=p>.</span><span class=na>getCurrentId</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>employee</span><span class=p>.</span><span class=na>setUpdateTime</span><span class=p>(</span><span class=n>LocalDateTime</span><span class=p>.</span><span class=na>now</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>employeeMapper</span><span class=p>.</span><span class=na>update</span><span class=p>(</span><span class=n>employee</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>编辑员工信息的时候遇到的bug</p><p>Json格式的数据需要加@RequestBody</p></div><footer class=post-footer><ul class=post-tags><li><a href=https://wqnm1gb.github.io/tags/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96/>苍穹外卖</a></li></ul><nav class=paginav><a class=prev href=https://wqnm1gb.github.io/posts/day03%E8%8F%9C%E5%93%81%E7%AE%A1%E7%90%86/><span class=title>« 上一页</span><br><span>Day03 菜品管理</span>
</a><a class=next href=https://wqnm1gb.github.io/posts/day01%E5%9F%BA%E7%A1%80%E4%BB%8B%E7%BB%8D%E5%92%8C%E9%85%8D%E7%BD%AE/><span class=title>下一页 »</span><br><span>Day01 基础介绍和配置</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://wqnm1gb.github.io/>三狗子的博客</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>