<!doctype html><html lang=zh dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Day08 用户下单、订单支付 | 三狗子的博客</title>
<meta name=keywords content="苍穹外卖"><meta name=description content="用户下单功能
用户下单业务说明：
在电商系统中，用户是通过下单的方式通知商家，用户已经购买了商品，需要商家进行备货和发货。用户下单后会产生订单相关数据，订单数据需要能够体现如下信息："><meta name=author content="冷漠三狗子丶"><link rel=canonical href=https://wqnm1gb.github.io/posts/day08%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/><link crossorigin=anonymous href=/assets/css/stylesheet.3d688279d829dc24da48acd11f9e33ebea2f39c035e899e1bf4297d8b7aa89b9.css integrity="sha256-PWiCedgp3CTaSKzRH54z6+ovOcA16Jnhv0KX2Leqibk=" rel="preload stylesheet" as=style><link rel=icon href=https://wqnm1gb.github.io/images/favicon.png><link rel=icon type=image/png sizes=16x16 href=https://wqnm1gb.github.io/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://wqnm1gb.github.io/favicon-32x32.png><link rel=apple-touch-icon href=https://wqnm1gb.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://wqnm1gb.github.io/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=zh href=https://wqnm1gb.github.io/posts/day08%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--code-block-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><link rel=preconnect href=https://fonts.googleapis.com><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:ital,wght@0,100..800;1,100..800&display=swap" rel=stylesheet><script type=text/javascript async src="https://cdn.bootcss.com/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML">MathJax.Hub.Config({tex2jax:{inlineMath:[["$","$"],["\\(","\\)"]],displayMath:[["$$","$$"],["[[","]]"]],processEscapes:!0,processEnvironments:!0,skipTags:["script","noscript","style","textarea","pre"],TeX:{equationNumbers:{autoNumber:"AMS"},extensions:["AMSmath.js","AMSsymbols.js"]}}}),MathJax.Hub.Queue(function(){var e,t=MathJax.Hub.getAllJax();for(e=0;e<t.length;e+=1)t[e].SourceElement().parentNode.className+=" has-jax"})</script><style>code.has-jax{font:inherit;font-size:100%;background:inherit;border:inherit;color:#515151}</style><meta property="og:title" content="Day08 用户下单、订单支付"><meta property="og:description" content="用户下单功能
用户下单业务说明：
在电商系统中，用户是通过下单的方式通知商家，用户已经购买了商品，需要商家进行备货和发货。用户下单后会产生订单相关数据，订单数据需要能够体现如下信息："><meta property="og:type" content="article"><meta property="og:url" content="https://wqnm1gb.github.io/posts/day08%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/"><meta property="og:image" content="https://wqnm1gb.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-03-20T11:08:14+08:00"><meta property="article:modified_time" content="2025-03-20T11:08:14+08:00"><meta property="og:site_name" content="三狗子的博客"><meta property="fb:admins" content="your-facebook-admin-id"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://wqnm1gb.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Day08 用户下单、订单支付","item":"https://wqnm1gb.github.io/posts/day08%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Day08 用户下单、订单支付","name":"Day08 用户下单、订单支付","description":"用户下单功能 用户下单业务说明：\n在电商系统中，用户是通过下单的方式通知商家，用户已经购买了商品，需要商家进行备货和发货。用户下单后会产生订单相关数据，订单数据需要能够体现如下信息：\n","keywords":["苍穹外卖"],"articleBody":"用户下单功能 用户下单业务说明：\n在电商系统中，用户是通过下单的方式通知商家，用户已经购买了商品，需要商家进行备货和发货。用户下单后会产生订单相关数据，订单数据需要能够体现如下信息：\n点单流程分析 需求分析和设计\n请求数据：用OrdersDTO提交\n返回数据：用OrderVO返回 这里的OrderVO继承了Orders\nOrderController // 给他在容器里起别名，防止管理端也有订单管理导致的冲突 @RestController(\"UserOrderController\") @RequestMapping(\"/user/order\") @Api(tags = \"订单管理相关接口\") @Slf4j public class OrderController { @Autowired private OrderService orderService; /** * 提交订单功能 * @param ordersDTO * @return */ @ApiOperation(\"提交订单\") @PostMapping(\"/submit\") public Result\u003cOrderSubmitVO\u003e submit(@RequestBody OrdersSubmitDTO ordersDTO){ log.info(\"提交订单{}\",ordersDTO); OrderSubmitVO orderSubmitVO = orderService.submitOrder(ordersDTO); return Result.success(orderSubmitVO); } } Service /** * 提交订单 * @param ordersDTO * @return */ @Override @Transactional public OrderSubmitVO submitOrder(OrdersSubmitDTO ordersDTO) { // 1、判断是否可以插入，购物车是不是空的，地址是不是空的 // 1.1 先判断购物车是否为空 Long userId = BaseContext.getCurrentId(); ShoppingCart shoppingCart = new ShoppingCart(); shoppingCart.setUserId(userId); List\u003cShoppingCart\u003e shoppingCartList = shoppingCartMapper.getById(shoppingCart); if(shoppingCartList == null || shoppingCartList.size()==0){ // 如果购物车中为空，那么抛出业务异常 throw new ShoppingCartBusinessException(MessageConstant.SHOPPING_CART_IS_NULL); } // 1.2 判断地址是否为空 Long addressBookId = ordersDTO.getAddressBookId(); AddressBook address = addressBookMapper.getById(addressBookId); if(address == null){ throw new AddressBookBusinessException(MessageConstant.ADDRESS_BOOK_IS_NULL); } // 2、向订单表插入1条数据 // 需要把数据先完善 Orders orders = new Orders(); BeanUtils.copyProperties(ordersDTO,orders); // 设置订单号，用当前时间的时间戳 orders.setNumber(String.valueOf(System.currentTimeMillis())); orders.setStatus(Orders.PENDING_PAYMENT); orders.setOrderTime(LocalDateTime.now()); orders.setPayStatus(Orders.UN_PAID); orders.setPhone(address.getPhone()); orders.setAddress(address.getDetail()); orders.setConsignee(address.getConsignee()); orders.setUserId(userId); orderMapper.insert(orders); List\u003cOrderDetail\u003e orderDetailList = new ArrayList\u003c\u003e(); // 3、向订单详细表插入n条数据（n是购物车里边的数据数量） for (ShoppingCart sc : shoppingCartList) { OrderDetail orderDetail = new OrderDetail(); BeanUtils.copyProperties(sc,orderDetail); orderDetail.setOrderId(orders.getId()); orderDetailList.add(orderDetail); } // 一次性插入所有的数据 orderDetailMapper.insertBatch(orderDetailList); // 4、把购物车清空 shoppingCartMapper.deleteAll(userId); // 5、返回vo数据 OrderSubmitVO orderSubmitVO = OrderSubmitVO.builder() .orderAmount(orders.getAmount()) .orderNumber(orders.getNumber()) .orderTime(orders.getOrderTime()) .id(orders.getId()) .build(); return orderSubmitVO; } 订单支付功能 调用微信官方的接口支付的流程如上图所示\nJSAPI下单：商户系统调用该接口在微信支付服务后台生成预支付交易单\n微信小程序调起支付：通过JSAPI下单接口获取到发起支付的必要参数prepay_id，然后使用微信支付提供的小程序方法调起小程序支付\n同时还需要准备一个临时的域名，为了支付成功后微信服务通过该域名回调我们的程序\n因为个人小程序无法使用支付，更改原来的代码\n/** * 订单支付 * * @param ordersPaymentDTO * @return */ @PutMapping(\"/payment\") @ApiOperation(\"订单支付\") public Result\u003cOrderPaymentVO\u003e payment(@RequestBody OrdersPaymentDTO ordersPaymentDTO) throws Exception { log.info(\"订单支付：{}\", ordersPaymentDTO); OrderPaymentVO orderPaymentVO = orderService.payment(ordersPaymentDTO); // 直接模拟交易成功 log.info(\"生成预支付交易单：{}\", orderPaymentVO); orderService.paySuccess(ordersPaymentDTO.getOrderNumber()); log.info(\"模拟交易成功{}\",ordersPaymentDTO.getOrderNumber()); return Result.success(orderPaymentVO); } /** * 订单支付 * * @param ordersPaymentDTO * @return */ public OrderPaymentVO payment(OrdersPaymentDTO ordersPaymentDTO) throws Exception { // 当前登录用户id Long userId = BaseContext.getCurrentId(); User user = userMapper.getById(userId); // //调用微信支付接口，生成预支付交易单 // 对应图中的第5步，调用微信下单接口 // JSONObject jsonObject = weChatPayUtil.pay( // ordersPaymentDTO.getOrderNumber(), //商户订单号 // new BigDecimal(0.01), //支付金额，单位 元 // \"苍穹外卖订单\", //商品描述 // user.getOpenid() //微信用户的openid // ); JSONObject jsonObject = new JSONObject(); if (jsonObject.getString(\"code\") != null \u0026\u0026 jsonObject.getString(\"code\").equals(\"ORDERPAID\")) { throw new OrderBusinessException(\"该订单已支付\"); } OrderPaymentVO vo = jsonObject.toJavaObject(OrderPaymentVO.class); vo.setPackageStr(jsonObject.getString(\"package\")); return vo; } 同时前端的js也跳过，直接显示支付成功\n","wordCount":"1179","inLanguage":"zh","image":"https://wqnm1gb.github.io/%3Clink%20or%20path%20of%20image%20for%20opengraph,%20twitter-cards%3E","datePublished":"2025-03-20T11:08:14+08:00","dateModified":"2025-03-20T11:08:14+08:00","author":{"@type":"Person","name":"冷漠三狗子丶"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://wqnm1gb.github.io/posts/day08%E7%94%A8%E6%88%B7%E4%B8%8B%E5%8D%95%E8%AE%A2%E5%8D%95%E6%94%AF%E4%BB%98/"},"publisher":{"@type":"Organization","name":"三狗子的博客","logo":{"@type":"ImageObject","url":"https://wqnm1gb.github.io/images/favicon.png"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://wqnm1gb.github.io/ accesskey=h title="主页 (Alt + H)"><img src=https://wqnm1gb.github.io/apple-touch-icon.png alt aria-label=logo height=35>主页</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://wqnm1gb.github.io/ title=三狗子的博客><span>首页</span></a></li><li><a href=https://wqnm1gb.github.io/archives/ title=归档><span>归档</span></a></li><li><a href=https://wqnm1gb.github.io/categories/ title=Categories><span>分类</span></a></li><li><a href=https://wqnm1gb.github.io/tags/ title=Tags><span>标签</span></a></li><li><a href=https://wqnm1gb.github.io/search/ title=搜索><span>搜索</span></a></li><li><a href=https://wqnm1gb.github.io/about/ title=关于><span>关于</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://wqnm1gb.github.io/>主页</a>&nbsp;»&nbsp;<a href=https://wqnm1gb.github.io/posts/>Posts</a></div><h1 class="post-title entry-hint-parent">Day08 用户下单、订单支付</h1><div class=post-meta><span title='2025-03-20 11:08:14 +0800 +0800'>三月 20, 2025</span>&nbsp;·&nbsp;3 分钟&nbsp;·&nbsp;1179 字&nbsp;·&nbsp;冷漠三狗子丶</div></header><div class=post-content><h1 id=用户下单功能>用户下单功能<a hidden class=anchor aria-hidden=true href=#用户下单功能>#</a></h1><p>用户下单业务说明：</p><p>在电商系统中，用户是通过下单的方式通知商家，用户已经购买了商品，需要商家进行备货和发货。用户下单后会产生订单相关数据，订单数据需要能够体现如下信息：</p><p><img loading=lazy src=/images/Day08%e7%94%a8%e6%88%b7%e4%b8%8b%e5%8d%95%e3%80%81%e8%ae%a2%e5%8d%95%e6%94%af%e4%bb%98.assets/1740729690217-eb3cfc57-6869-44f9-8815-da30650198d4.png alt></p><h2 id=点单流程分析>点单流程分析<a hidden class=anchor aria-hidden=true href=#点单流程分析>#</a></h2><p><img loading=lazy src=/images/Day08%e7%94%a8%e6%88%b7%e4%b8%8b%e5%8d%95%e3%80%81%e8%ae%a2%e5%8d%95%e6%94%af%e4%bb%98.assets/1740729760057-7a9dd2ef-e4dd-4610-b42d-894179fbce0e.png alt></p><p>需求分析和设计</p><p>请求数据：用OrdersDTO提交</p><p><img loading=lazy src=/images/Day08%e7%94%a8%e6%88%b7%e4%b8%8b%e5%8d%95%e3%80%81%e8%ae%a2%e5%8d%95%e6%94%af%e4%bb%98.assets/1740536602073-cd6b00a0-e5b2-46c8-8913-ab80591b20ab.png alt></p><p>返回数据：用OrderVO返回 这里的OrderVO继承了Orders</p><p><img loading=lazy src=/images/Day08%e7%94%a8%e6%88%b7%e4%b8%8b%e5%8d%95%e3%80%81%e8%ae%a2%e5%8d%95%e6%94%af%e4%bb%98.assets/1740536616397-99a510c1-4571-49c8-aa3a-1e1f7d4e1a1e.png alt></p><h2 id=ordercontroller>OrderController<a hidden class=anchor aria-hidden=true href=#ordercontroller>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=c1>// 给他在容器里起别名，防止管理端也有订单管理导致的冲突</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@RestController</span><span class=p>(</span><span class=s>&#34;UserOrderController&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@RequestMapping</span><span class=p>(</span><span class=s>&#34;/user/order&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Api</span><span class=p>(</span><span class=n>tags</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=s>&#34;订单管理相关接口&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=nd>@Slf4j</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=kd>public</span><span class=w> </span><span class=kd>class</span> <span class=nc>OrderController</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Autowired</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>private</span><span class=w> </span><span class=n>OrderService</span><span class=w> </span><span class=n>orderService</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 提交订单功能
</span></span></span><span class=line><span class=cl><span class=cm>     * @param ordersDTO
</span></span></span><span class=line><span class=cl><span class=cm>     * @return
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ApiOperation</span><span class=p>(</span><span class=s>&#34;提交订单&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@PostMapping</span><span class=p>(</span><span class=s>&#34;/submit&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Result</span><span class=o>&lt;</span><span class=n>OrderSubmitVO</span><span class=o>&gt;</span><span class=w> </span><span class=nf>submit</span><span class=p>(</span><span class=nd>@RequestBody</span><span class=w> </span><span class=n>OrdersSubmitDTO</span><span class=w> </span><span class=n>ordersDTO</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;提交订单{}&#34;</span><span class=p>,</span><span class=n>ordersDTO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>OrderSubmitVO</span><span class=w> </span><span class=n>orderSubmitVO</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderService</span><span class=p>.</span><span class=na>submitOrder</span><span class=p>(</span><span class=n>ordersDTO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Result</span><span class=p>.</span><span class=na>success</span><span class=p>(</span><span class=n>orderSubmitVO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h2 id=service>Service<a hidden class=anchor aria-hidden=true href=#service>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w> </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 提交订单
</span></span></span><span class=line><span class=cl><span class=cm>     * @param ordersDTO
</span></span></span><span class=line><span class=cl><span class=cm>     * @return
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Override</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@Transactional</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>OrderSubmitVO</span><span class=w> </span><span class=nf>submitOrder</span><span class=p>(</span><span class=n>OrdersSubmitDTO</span><span class=w> </span><span class=n>ordersDTO</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 1、判断是否可以插入，购物车是不是空的，地址是不是空的</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 1.1 先判断购物车是否为空</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>BaseContext</span><span class=p>.</span><span class=na>getCurrentId</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>ShoppingCart</span><span class=w> </span><span class=n>shoppingCart</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ShoppingCart</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>shoppingCart</span><span class=p>.</span><span class=na>setUserId</span><span class=p>(</span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=o>&lt;</span><span class=n>ShoppingCart</span><span class=o>&gt;</span><span class=w> </span><span class=n>shoppingCartList</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>shoppingCartMapper</span><span class=p>.</span><span class=na>getById</span><span class=p>(</span><span class=n>shoppingCart</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>shoppingCartList</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>||</span><span class=w> </span><span class=n>shoppingCartList</span><span class=p>.</span><span class=na>size</span><span class=p>()</span><span class=o>==</span><span class=n>0</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=c1>// 如果购物车中为空，那么抛出业务异常</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ShoppingCartBusinessException</span><span class=p>(</span><span class=n>MessageConstant</span><span class=p>.</span><span class=na>SHOPPING_CART_IS_NULL</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 1.2 判断地址是否为空</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Long</span><span class=w> </span><span class=n>addressBookId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>ordersDTO</span><span class=p>.</span><span class=na>getAddressBookId</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>AddressBook</span><span class=w> </span><span class=n>address</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>addressBookMapper</span><span class=p>.</span><span class=na>getById</span><span class=p>(</span><span class=n>addressBookId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=p>(</span><span class=n>address</span><span class=w> </span><span class=o>==</span><span class=w> </span><span class=kc>null</span><span class=p>){</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>AddressBookBusinessException</span><span class=p>(</span><span class=n>MessageConstant</span><span class=p>.</span><span class=na>ADDRESS_BOOK_IS_NULL</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 2、向订单表插入1条数据</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 需要把数据先完善</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Orders</span><span class=w> </span><span class=n>orders</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>Orders</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>BeanUtils</span><span class=p>.</span><span class=na>copyProperties</span><span class=p>(</span><span class=n>ordersDTO</span><span class=p>,</span><span class=n>orders</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 设置订单号，用当前时间的时间戳</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orders</span><span class=p>.</span><span class=na>setNumber</span><span class=p>(</span><span class=n>String</span><span class=p>.</span><span class=na>valueOf</span><span class=p>(</span><span class=n>System</span><span class=p>.</span><span class=na>currentTimeMillis</span><span class=p>()));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orders</span><span class=p>.</span><span class=na>setStatus</span><span class=p>(</span><span class=n>Orders</span><span class=p>.</span><span class=na>PENDING_PAYMENT</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orders</span><span class=p>.</span><span class=na>setOrderTime</span><span class=p>(</span><span class=n>LocalDateTime</span><span class=p>.</span><span class=na>now</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orders</span><span class=p>.</span><span class=na>setPayStatus</span><span class=p>(</span><span class=n>Orders</span><span class=p>.</span><span class=na>UN_PAID</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orders</span><span class=p>.</span><span class=na>setPhone</span><span class=p>(</span><span class=n>address</span><span class=p>.</span><span class=na>getPhone</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orders</span><span class=p>.</span><span class=na>setAddress</span><span class=p>(</span><span class=n>address</span><span class=p>.</span><span class=na>getDetail</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orders</span><span class=p>.</span><span class=na>setConsignee</span><span class=p>(</span><span class=n>address</span><span class=p>.</span><span class=na>getConsignee</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orders</span><span class=p>.</span><span class=na>setUserId</span><span class=p>(</span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orderMapper</span><span class=p>.</span><span class=na>insert</span><span class=p>(</span><span class=n>orders</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>List</span><span class=o>&lt;</span><span class=n>OrderDetail</span><span class=o>&gt;</span><span class=w> </span><span class=n>orderDetailList</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>ArrayList</span><span class=o>&lt;&gt;</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 3、向订单详细表插入n条数据（n是购物车里边的数据数量）</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>for</span><span class=w> </span><span class=p>(</span><span class=n>ShoppingCart</span><span class=w> </span><span class=n>sc</span><span class=w> </span><span class=p>:</span><span class=w> </span><span class=n>shoppingCartList</span><span class=p>)</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>OrderDetail</span><span class=w> </span><span class=n>orderDetail</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>OrderDetail</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>BeanUtils</span><span class=p>.</span><span class=na>copyProperties</span><span class=p>(</span><span class=n>sc</span><span class=p>,</span><span class=n>orderDetail</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>orderDetail</span><span class=p>.</span><span class=na>setOrderId</span><span class=p>(</span><span class=n>orders</span><span class=p>.</span><span class=na>getId</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=n>orderDetailList</span><span class=p>.</span><span class=na>add</span><span class=p>(</span><span class=n>orderDetail</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 一次性插入所有的数据</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orderDetailMapper</span><span class=p>.</span><span class=na>insertBatch</span><span class=p>(</span><span class=n>orderDetailList</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 4、把购物车清空</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>shoppingCartMapper</span><span class=p>.</span><span class=na>deleteAll</span><span class=p>(</span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 5、返回vo数据</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>OrderSubmitVO</span><span class=w> </span><span class=n>orderSubmitVO</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>OrderSubmitVO</span><span class=p>.</span><span class=na>builder</span><span class=p>()</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>orderAmount</span><span class=p>(</span><span class=n>orders</span><span class=p>.</span><span class=na>getAmount</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>orderNumber</span><span class=p>(</span><span class=n>orders</span><span class=p>.</span><span class=na>getNumber</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>orderTime</span><span class=p>(</span><span class=n>orders</span><span class=p>.</span><span class=na>getOrderTime</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>id</span><span class=p>(</span><span class=n>orders</span><span class=p>.</span><span class=na>getId</span><span class=p>())</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>                </span><span class=p>.</span><span class=na>build</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>orderSubmitVO</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><h1 id=订单支付功能>订单支付功能<a hidden class=anchor aria-hidden=true href=#订单支付功能>#</a></h1><p><img loading=lazy src=/images/Day08%e7%94%a8%e6%88%b7%e4%b8%8b%e5%8d%95%e3%80%81%e8%ae%a2%e5%8d%95%e6%94%af%e4%bb%98.assets/1740732141905-49f69228-e9ef-499e-9c88-aa6b93bc1d8e.png alt></p><p>调用微信官方的接口支付的流程如上图所示</p><p>JSAPI下单：商户系统调用该接口在微信支付服务后台生成预支付交易单</p><p><img loading=lazy src=/images/Day08%e7%94%a8%e6%88%b7%e4%b8%8b%e5%8d%95%e3%80%81%e8%ae%a2%e5%8d%95%e6%94%af%e4%bb%98.assets/1740732674764-26b55115-fdc0-4d53-bc85-7b0add3e31c8.png alt></p><p>微信小程序调起支付：通过JSAPI下单接口获取到发起支付的必要参数prepay_id，然后使用微信支付提供的小程序方法调起小程序支付</p><p><img loading=lazy src=/images/Day08%e7%94%a8%e6%88%b7%e4%b8%8b%e5%8d%95%e3%80%81%e8%ae%a2%e5%8d%95%e6%94%af%e4%bb%98.assets/1740732699312-fdadf659-39fb-4848-bb74-ebe6ed042862.png alt></p><p>同时还需要准备一个临时的域名，为了支付成功后微信服务通过该域名回调我们的程序</p><p>因为个人小程序无法使用支付，更改原来的代码</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w> </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 订单支付
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param ordersPaymentDTO
</span></span></span><span class=line><span class=cl><span class=cm>     * @return
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@PutMapping</span><span class=p>(</span><span class=s>&#34;/payment&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=nd>@ApiOperation</span><span class=p>(</span><span class=s>&#34;订单支付&#34;</span><span class=p>)</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>Result</span><span class=o>&lt;</span><span class=n>OrderPaymentVO</span><span class=o>&gt;</span><span class=w> </span><span class=nf>payment</span><span class=p>(</span><span class=nd>@RequestBody</span><span class=w> </span><span class=n>OrdersPaymentDTO</span><span class=w> </span><span class=n>ordersPaymentDTO</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;订单支付：{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>ordersPaymentDTO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>OrderPaymentVO</span><span class=w> </span><span class=n>orderPaymentVO</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>orderService</span><span class=p>.</span><span class=na>payment</span><span class=p>(</span><span class=n>ordersPaymentDTO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 直接模拟交易成功</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;生成预支付交易单：{}&#34;</span><span class=p>,</span><span class=w> </span><span class=n>orderPaymentVO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>orderService</span><span class=p>.</span><span class=na>paySuccess</span><span class=p>(</span><span class=n>ordersPaymentDTO</span><span class=p>.</span><span class=na>getOrderNumber</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>log</span><span class=p>.</span><span class=na>info</span><span class=p>(</span><span class=s>&#34;模拟交易成功{}&#34;</span><span class=p>,</span><span class=n>ordersPaymentDTO</span><span class=p>.</span><span class=na>getOrderNumber</span><span class=p>());</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>Result</span><span class=p>.</span><span class=na>success</span><span class=p>(</span><span class=n>orderPaymentVO</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-java data-lang=java><span class=line><span class=cl><span class=w>    </span><span class=cm>/**
</span></span></span><span class=line><span class=cl><span class=cm>     * 订单支付
</span></span></span><span class=line><span class=cl><span class=cm>     *
</span></span></span><span class=line><span class=cl><span class=cm>     * @param ordersPaymentDTO
</span></span></span><span class=line><span class=cl><span class=cm>     * @return
</span></span></span><span class=line><span class=cl><span class=cm>     */</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=kd>public</span><span class=w> </span><span class=n>OrderPaymentVO</span><span class=w> </span><span class=nf>payment</span><span class=p>(</span><span class=n>OrdersPaymentDTO</span><span class=w> </span><span class=n>ordersPaymentDTO</span><span class=p>)</span><span class=w> </span><span class=kd>throws</span><span class=w> </span><span class=n>Exception</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 当前登录用户id</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>Long</span><span class=w> </span><span class=n>userId</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>BaseContext</span><span class=p>.</span><span class=na>getCurrentId</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>User</span><span class=w> </span><span class=n>user</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>userMapper</span><span class=p>.</span><span class=na>getById</span><span class=p>(</span><span class=n>userId</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//        //调用微信支付接口，生成预支付交易单</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=c1>// 对应图中的第5步，调用微信下单接口</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//        JSONObject jsonObject = weChatPayUtil.pay(</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//                ordersPaymentDTO.getOrderNumber(), //商户订单号</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//                new BigDecimal(0.01), //支付金额，单位 元</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//                &#34;苍穹外卖订单&#34;, //商品描述</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//                user.getOpenid() //微信用户的openid</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w></span><span class=c1>//        );</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>JSONObject</span><span class=w> </span><span class=n>jsonObject</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>JSONObject</span><span class=p>();</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>if</span><span class=w> </span><span class=p>(</span><span class=n>jsonObject</span><span class=p>.</span><span class=na>getString</span><span class=p>(</span><span class=s>&#34;code&#34;</span><span class=p>)</span><span class=w> </span><span class=o>!=</span><span class=w> </span><span class=kc>null</span><span class=w> </span><span class=o>&amp;&amp;</span><span class=w> </span><span class=n>jsonObject</span><span class=p>.</span><span class=na>getString</span><span class=p>(</span><span class=s>&#34;code&#34;</span><span class=p>).</span><span class=na>equals</span><span class=p>(</span><span class=s>&#34;ORDERPAID&#34;</span><span class=p>))</span><span class=w> </span><span class=p>{</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>            </span><span class=k>throw</span><span class=w> </span><span class=k>new</span><span class=w> </span><span class=n>OrderBusinessException</span><span class=p>(</span><span class=s>&#34;该订单已支付&#34;</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=p>}</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>OrderPaymentVO</span><span class=w> </span><span class=n>vo</span><span class=w> </span><span class=o>=</span><span class=w> </span><span class=n>jsonObject</span><span class=p>.</span><span class=na>toJavaObject</span><span class=p>(</span><span class=n>OrderPaymentVO</span><span class=p>.</span><span class=na>class</span><span class=p>);</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=n>vo</span><span class=p>.</span><span class=na>setPackageStr</span><span class=p>(</span><span class=n>jsonObject</span><span class=p>.</span><span class=na>getString</span><span class=p>(</span><span class=s>&#34;package&#34;</span><span class=p>));</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>        </span><span class=k>return</span><span class=w> </span><span class=n>vo</span><span class=p>;</span><span class=w>
</span></span></span><span class=line><span class=cl><span class=w>    </span><span class=p>}</span><span class=w>
</span></span></span></code></pre></div><p>同时前端的js也跳过，直接显示支付成功</p><p><img loading=lazy src=/images/Day08%e7%94%a8%e6%88%b7%e4%b8%8b%e5%8d%95%e3%80%81%e8%ae%a2%e5%8d%95%e6%94%af%e4%bb%98.assets/1740736625344-9bb6734e-c523-4cb9-b351-a4f9dc4f782c.png alt></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://wqnm1gb.github.io/tags/%E8%8B%8D%E7%A9%B9%E5%A4%96%E5%8D%96/>苍穹外卖</a></li></ul><nav class=paginav><a class=prev href=https://wqnm1gb.github.io/posts/day09%E8%AE%A2%E5%8D%95%E7%9B%B8%E5%85%B3%E5%8A%9F%E8%83%BD%E5%BC%80%E5%8F%91/><span class=title>« 上一页</span><br><span>Day09 订单相关功能开发</span>
</a><a class=next href=https://wqnm1gb.github.io/posts/day07%E7%BC%93%E5%AD%98%E8%8F%9C%E5%93%81%E5%92%8C%E8%B4%AD%E7%89%A9%E8%BD%A6/><span class=title>下一页 »</span><br><span>Day07 缓存菜品和购物车</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://wqnm1gb.github.io/>三狗子的博客</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="复制";function s(){t.innerHTML="已复制！",setTimeout(()=>{t.innerHTML="复制"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>